<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>정기검증 입력폼</title>
<style>
  body { font-family: Arial; padding: 16px; }
  .hidden { display:none !important; }
  .toggle-btn { padding:10px 20px; border:1px solid #333; border-radius:8px; margin-right:8px; cursor:pointer; }
  .toggle-btn.active { background:#4caf50; color:white; }
  .toggle-btn.inactive { background:#f44336; color:white; }
</style>
</head>
<body>
<h2>정기검증 입력폼</h2>

<label>날짜:</label>
<input type="date" id="dateInput" />
<br><br>

<label>주기 선택:</label>
<select id="periodSelect">
  <option value="">-- 선택 --</option>
  <option value="주간">주간</option>
  <option value="월간">월간</option>
  <option value="분기">분기</option>
  <option value="반기">반기</option>
  <option value="연간">연간</option>
</select>
<br><br>

<div id="itemBox" class="hidden">
  <label>항목 선택:</label>
  <select id="itemSelect"></select>
</div>
<br>

<div id="statusBox" class="hidden">
  <label>점검상태:</label><br>
  <button id="btnDone" class="toggle-btn inactive">완료</button>
  <button id="btnNot" class="toggle-btn active">미완료</button>
</div>
<br>

<button id="saveBtn">저장</button>

<script>
const BASE_URL = "YOUR_WEBAPP_URL"; // Apps Script WebApp URL

const itemsMap = {
  "주간": ["방재점검","위생복세탁","비공정청소"],
  "월간": ["CCP검증표","위생교육"],
  "분기": ["자가품질검사"],
  "반기": ["용수탱크청소","에어필터점검"],
  "연간": ["지하수검사","검교정","유효성평가"]
};

const dateInput = document.getElementById('dateInput');
const periodSelect = document.getElementById('periodSelect');
const itemBox = document.getElementById('itemBox');
const itemSelect = document.getElementById('itemSelect');
const statusBox = document.getElementById('statusBox');
const btnDone = document.getElementById('btnDone');
const btnNot = document.getElementById('btnNot');

// 초기 날짜
window.onload = () => {
  const today = new Date().toISOString().split('T')[0];
  dateInput.value = today;
};

periodSelect.addEventListener('change', () => {
  itemBox.classList.add('hidden');
  statusBox.classList.add('hidden');

  const period = periodSelect.value;
  if (!period) return;

  itemSelect.innerHTML = "";
  itemsMap[period].forEach(v => {
    const op = document.createElement('option');
    op.value = v;
    op.textContent = v;
    itemSelect.appendChild(op);
  });

  itemBox.classList.remove('hidden');
});

itemSelect.addEventListener('change', () => {
  statusBox.classList.remove('hidden');
  btnDone.classList.remove('active');
  btnDone.classList.add('inactive');
  btnNot.classList.add('active');
  btnNot.classList.remove('inactive');

  checkDuplicate();
});

btnDone.onclick = () => {
  btnDone.classList.add('active');
  btnDone.classList.remove('inactive');
  btnNot.classList.remove('active');
  btnNot.classList.add('inactive');
};

btnNot.onclick = () => {
  btnNot.classList.add('active');
  btnNot.classList.remove('inactive');
  btnDone.classList.remove('active');
  btnDone.classList.add('inactive');
};

function getStatus() {
  return btnDone.classList.contains('active') ? "완료" : "미완료";
}

// 중복 조회
function checkDuplicate() {
  fetch(`${BASE_URL}?mode=read&date=${dateInput.value}&period=${periodSelect.value}&item=${itemSelect.value}`)
    .then(r=>r.json())
    .then(d => {
      if (d.status) {
        if (d.data === "완료") {
          btnDone.click();
        } else {
          btnNot.click();
        }
      }
    });
}

// 저장
saveBtn.onclick = () => {
  const payload = {
    mode: "write",
    date: dateInput.value,
    period: periodSelect.value,
    item: itemSelect.value,
    status: getStatus(),
  };

  fetch(BASE_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  }).then(r=>r.json()).then(d=>{
    alert(d.message);
  });
};
</script>
</body>
</html>
