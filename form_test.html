<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>월별 데이터 취합</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:16px}
    .controls{display:flex;gap:8px;align-items:center}
    select, button{padding:6px 10px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f5f5f5}
    .small{font-size:13px;color:#666}
    .loading{margin-left:8px;font-size:13px}
  </style>
</head>
<body>
  <h2>월별 데이터 취합</h2>
  <div class="controls">
    <label for="monthSelector">월 선택: </label>
    <select id="monthSelector"></select>
    <button id="prevBtn">&lt; 이전</button>
    <button id="nextBtn">다음 &gt;</button>
    <span id="statusText" class="loading"></span>
  </div>

  <table id="statusTable">
    <thead>
      <tr>
        <th>일</th>
        <th>요일</th>
        <th>위생</th>
        <th>건면</th>
        <th>생면</th>
        <th>금속</th>
        <th>입고</th>
        <th>방재</th>
        <th>급수</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // 배포 URL(사용자 제공)
  const BASE_URL = "https://script.google.com/macros/s/AKfycbzf7LUZSuUNSHwbMLr_ujwpZZggatm4Rkbfmqp2DyFRzfXFsb5XBjc95kkDQVDGlc3T_Q/exec";

  const monthSel = document.getElementById("monthSelector");
  const statusText = document.getElementById("statusText");

  function init() {
    populateMonths();
    document.getElementById("prevBtn").addEventListener("click", () => changeMonth(-1));
    document.getElementById("nextBtn").addEventListener("click", () => changeMonth(1));
    monthSel.addEventListener("change", loadSelectedMonth);
    setToCurrentMonth();
  }

  function populateMonths() {
    // + -1 year ~ +1 year 범위로 예시 (원하면 확장)
    const today = new Date();
    const thisYear = today.getFullYear();
    const startYear = thisYear - 1;
    const endYear = thisYear + 1;
    for (let y = startYear; y <= endYear; y++) {
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        const val = `${y}-${String(m).padStart(2,"0")}`;
        opt.value = val;
        opt.textContent = `${y}년 ${m}월`;
        monthSel.appendChild(opt);
      }
    }
  }

  function setToCurrentMonth() {
    const t = new Date();
    const v = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;
    monthSel.value = v;
    loadSelectedMonth();
  }

  function changeMonth(delta) {
    const [y, m] = monthSel.value.split("-").map(Number);
    let newY = y, newM = m + delta;
    if (newM < 1) { newM = 12; newY -= 1; }
    if (newM > 12) { newM = 1; newY += 1; }
    const val = `${newY}-${String(newM).padStart(2,'0')}`;
    monthSel.value = val;
    loadSelectedMonth();
  }

  async function loadSelectedMonth() {
    const val = monthSel.value;
    const [year, month] = val.split("-").map(Number);
    statusText.textContent = "불러오는 중...";
    try {
      const url = `${BASE_URL}?mode=data&year=${year}&month=${month}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if (!json.success) throw new Error(json.error || "데이터 로드 실패");
      renderTable(json.data);
      statusText.textContent = `완료 — ${year}년 ${month}월`;
    } catch (err) {
      statusText.textContent = "오류: " + (err.message || err);
      document.querySelector("#statusTable tbody").innerHTML = "";
      console.error(err);
    }
  }

  function renderTable(data) {
    const tbody = document.querySelector("#statusTable tbody");
    tbody.innerHTML = "";
    const weekDays = ["일","월","화","수","목","금","토"];
    data.forEach(item => {
      const dt = new Date(item.date);
      const day = dt.getDate();
      const w = weekDays[dt.getDay()];
      const tr = document.createElement("tr");
      // 날짜, 요일 그리고 7개 상태
      tr.innerHTML = `<td>${day}</td><td>${w}</td>${item.status.map(s=>`<td>${s}</td>`).join('')}`;
      tbody.appendChild(tr);
    });
  }

  window.onload = init;
</script>
</body>
</html>
