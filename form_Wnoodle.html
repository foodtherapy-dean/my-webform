<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>생면공정 점검</title>
<style>
body { font-family:sans-serif; margin:0; background:#f9f9f9; }
.app-container { display:flex; flex-direction:column; height:100vh; }
.app-header { background:#4CAF50; color:#fff; text-align:center; padding:14px; font-size:1.3rem; }
.app-body { flex:1; overflow-y:auto; padding:12px; }
.app-footer { position:sticky; bottom:0; }
button[type=submit] { width:100%; font-size:1.3rem; padding:16px 0; background:#28a745; color:#fff; border:none; cursor:pointer; }
button[type=submit]:hover { background:#218838; }
.row { display:flex; align-items:center; margin:8px 0; gap:8px; }
.label { width:50px; font-weight:bold; }
.btn { flex:1; padding:12px; font-size:1.1rem; border:1px solid #ccc; border-radius:8px; background:#eee; cursor:pointer; }
.btn.selected { background:#007bff; color:white; border-color:#0056b3; }
.result { flex:1; text-align:right; font-weight:bold; color:#333; }
#duplicateMsg { background:#ffc107; color:#000; padding:10px; margin:10px 0; text-align:center; border-radius:4px; display:none; }
#duplicateMsg button { margin:6px; padding:8px 14px; border:none; border-radius:4px; cursor:pointer; }
#duplicateProceed { background:#007bff; color:#fff; }
#duplicateCancel { background:#dc3545; color:#fff; }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">생면공정 점검</div>
  <div class="app-body">
    <label>날짜</label>
    <input type="date" id="date" required>
    <div id="rounds"></div>
    <div id="duplicateMsg">
      <div id="duplicateText"></div>
      <button type="button" id="duplicateProceed">진행</button>
      <button type="button" id="duplicateCancel">취소</button>
    </div>
  </div>
  <div class="app-footer">
    <button id="submitBtn">저장</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const scriptUrl = "https://script.google.com/macros/s/AKfycbzuT-_RAwyZvrq8GmRmHcR8G3LI8u4xiqOw4SmMEqVOfOeJ-kNH5BCaS6nKsjK3WyDBtA/exec";
  const dateInput = document.getElementById("date");
  const roundsDiv = document.getElementById("rounds");
  const submitBtn = document.getElementById("submitBtn");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateProceed = document.getElementById("duplicateProceed");
  const duplicateCancel = document.getElementById("duplicateCancel");

  dateInput.valueAsDate = new Date();
  let roundData = {};

  // 차수별 UI 생성
  for (let i = 1; i <= 10; i++) {
    const row = document.createElement("div");
    row.className = "row";
    row.dataset.round = i;
    row.innerHTML = `
      <div class="label">${i}차</div>
      <button class="btn" type="button" data-type="3포">3포</button>
      <button class="btn" type="button" data-type="2포">2포</button>
      <div class="result" id="result${i}"></div>
    `;
    roundsDiv.appendChild(row);

    // 버튼 이벤트
    row.querySelectorAll(".btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.type;
        const no = (type === "3포" ? 60 : 40);
        const value = (type === "3포" ? 1 : 0.7);
        roundData[i] = { no, value };

        row.querySelectorAll(".btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        document.getElementById("result"+i).textContent = `주정 ${value} kg`;
      });
    });
  }

  // 저장
  submitBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (!dateInput.value) { alert("날짜를 선택하세요"); return; }

    const noArr = [], valueArr = [];
    for (let i=1;i<=10;i++){
      noArr.push(roundData[i]?.no || "");
      valueArr.push(roundData[i]?.value || "");
    }

    const payload = { date: dateInput.value, no: noArr, value: valueArr };

    try {
      // 중복 확인
      const res = await fetch(`${scriptUrl}?checkDate=${encodeURIComponent(dateInput.value)}`);
      const data = await res.json();
      if (data.exists) {
        duplicateText.textContent = `⚠️ ${dateInput.value} 에 이미 데이터가 있습니다. 진행할까요?`;
        duplicateMsg.style.display = "block";

        duplicateProceed.onclick = () => {
          duplicateMsg.style.display = "none";
          sendData(payload, true);
        };
        duplicateCancel.onclick = () => {
          duplicateMsg.style.display = "none";
          resetForm();
        };
      } else {
        sendData(payload, false);
      }
    } catch (err) {
      alert("중복 확인 실패: "+err.message);
    }
  });

  async function sendData(payload, update){
    try {
      const res = await fetch(scriptUrl, {
        method:"POST",
        body: new URLSearchParams({ saengmyeon: JSON.stringify({ ...payload, update }) })
      });
      const text = await res.text();
      alert("저장 완료: "+text);
      resetForm();
    } catch(err) {
      alert("저장 오류: "+err.message);
    }
  }

  function resetForm(){
    roundData = {};
    document.querySelectorAll(".result").forEach(r=>r.textContent="");
    document.querySelectorAll(".btn").forEach(b=>b.classList.remove("selected"));
    dateInput.valueAsDate = new Date();
  }
});
</script>
</body>
</html>
