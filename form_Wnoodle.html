<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìƒë©´ê³µì • ì…ë ¥</title>
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
.app-container { display:flex; flex-direction:column; height:100%; }
.app-header { background:#4CAF50; color:#fff; text-align:center; padding:20px; font-size:2rem; flex:0 0 auto; }
.app-body { flex:1 1 auto; overflow-y:auto; padding:20px; box-sizing:border-box; background:#f9f9f9; }
.app-footer { flex:0 0 auto; }
#submitBtn { width:100%; font-size:1.8rem; padding:24px 0; background:#4CAF50; color:#fff; border:none; border-radius:0; cursor:pointer; }

/* í•œ í–‰ ë ˆì´ì•„ì›ƒ ê³ ì • */
.row { display:flex; align-items:center; gap:8px; margin-bottom:12px; background:#fff; padding:16px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex-wrap:nowrap; }
.label { flex:0 0 60px; font-weight:bold; font-size:1.4rem; text-align:left; cursor:pointer; }
.btn { flex:1 1 0; min-width:0; padding:16px 12px; border-radius:8px; cursor:pointer; border:none; font-size:1.4rem; font-weight:bold; background:#e0e0e0; color:#333; transition:background .2s,color .2s,box-shadow .2s; }
.btn.selected { background:#4CAF50; color:#fff; box-shadow:inset 0 0 0 2px #2e7d32; }
.result { margin-left:auto; flex:0 0 auto; min-width:110px; text-align:right; font-size:1.4rem; font-weight:bold; color:#333; }

/* ì¤‘ë³µ ë©”ì‹œì§€ */
#duplicateMsg { display:none; background:#ffcccc; color:#900; padding:14px; margin-top:8px; border:1px solid #900; border-radius:6px; font-weight:bold; font-size:1.2rem; }
#duplicateMsg button { margin-left:14px; background:#900; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:1rem; }

@media (max-width:768px){
  .row{ gap:6px; padding:14px; }
  .label{ flex-basis:56px; font-size:1.6rem; }
  .btn{ font-size:1.6rem; padding:16px 8px; }
  .result{ font-size:1.6rem; min-width:100px; }
}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ìƒë©´ê³µì • ì ê²€ ì…ë ¥4</div>

  <div class="app-body">
    <label for="date">ë‚ ì§œ</label>
    <input type="date" id="date" required style="font-size:1.4rem; padding:10px; width:100%; margin-bottom:20px;" />

    <h3 style="margin-top:20px;">ì°¨ìˆ˜ë³„ ì…ë ¥</h3>
    <div id="rounds"></div>

    <div id="duplicateMsg">
      <span id="duplicateText"></span>
      <button id="duplicateConfirmBtn">í™•ì¸</button>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ“¥ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById("date");
  const submitBtn = document.getElementById("submitBtn");
  const roundsDiv = document.getElementById("rounds");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
  const duplicateCancelBtn = document.createElement("button");

  duplicateCancelBtn.textContent = "ì·¨ì†Œ";
  duplicateCancelBtn.type = "button";
  duplicateCancelBtn.id = "duplicateCancelBtn";
  duplicateCancelBtn.style.marginLeft = "10px";
  duplicateMsg.appendChild(duplicateCancelBtn);

  // âœ… ë°°í¬ëœ Web Appì˜ /exec ì£¼ì†Œ
  const scriptUrl = "https://script.google.com/macros/s/AKfycbzuT-_RAwyZvrq8GmRmHcR8G3LI8u4xiqOw4SmMEqVOfOeJ-kNH5BCaS6nKsjK3WyDBtA/exec";

  // ì˜¤ëŠ˜ ë‚ ì§œ ìë™
  dateInput.valueAsDate = new Date();

  // ë°ì´í„° ì €ì¥ìš©
  const roundData = {};

  // UI ìƒì„±: 1~10ì°¨
  for (let i = 1; i <= 10; i++) {
    const row = document.createElement("div");
    row.className = "row";
    row.dataset.round = String(i);
    row.innerHTML = `
      <div class="label">${i}ì°¨</div>
      <button class="btn" type="button" onclick="selectOption(${i}, '3í¬')" aria-pressed="false">3í¬</button>
      <button class="btn" type="button" onclick="selectOption(${i}, '2í¬')" aria-pressed="false">2í¬</button>
      <div id="result${i}" class="result"></div>
    `;
    roundsDiv.appendChild(row);
  }

  // ì„ íƒ ì²˜ë¦¬
  window.selectOption = function(round, type) {
    const rowEl = roundsDiv.children[round - 1];
    const btns = rowEl.querySelectorAll('.btn');

    let no, value;
    if (type === "3í¬") { no = 60; value = 1; }
    else { no = 40; value = 0.7; }

    roundData[round] = { no, value };
    document.getElementById("result"+round).textContent = `ì£¼ì • ${value} kg`;

    btns.forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
    if (type === "3í¬") { btns[0].classList.add('selected'); btns[0].setAttribute('aria-pressed','true'); }
    else { btns[1].classList.add('selected'); btns[1].setAttribute('aria-pressed','true'); }
  };

  // ë¼ë²¨ í´ë¦­ â†’ í•´ë‹¹ ì°¨ìˆ˜ ì´ˆê¸°í™”
  roundsDiv.addEventListener("click", (e) => {
    if (e.target.classList.contains("label")) {
      const round = e.target.parentElement.dataset.round;
      delete roundData[round];
      const rowEl = e.target.parentElement;
      rowEl.querySelectorAll(".btn").forEach(btn => { btn.classList.remove("selected"); btn.setAttribute("aria-pressed","false"); });
      rowEl.querySelector(".result").textContent = "";
    }
  });

  // í•„ìˆ˜ ì°¨ìˆ˜ í™•ì¸
  function validateRounds() {
    if (!roundData[1]) { alert("âš ï¸ 1ì°¨ëŠ” ë°˜ë“œì‹œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤."); return false; }
    for (let i = 1; i <= 10; i++) {
      if (!roundData[i]) {
        for (let j = i+1; j <= 10; j++) {
          if (roundData[j]) { alert(`âš ï¸ ${i}ì°¨ìˆ˜ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ${i}ì°¨ë¥¼ ì„ íƒí•˜ì„¸ìš”.`); return false; }
        }
      }
    }
    return true;
  }

  // ì €ì¥ ë¡œì§ (âœ… JSON POSTë¡œ ë³€ê²½)
  async function saveData(force = false) {
    if (!dateInput.value) { alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
    if (!validateRounds()) return;

    const noArr = [], valueArr = [];
    for (let i = 1; i <= 10; i++) {
      if (roundData[i]) { noArr.push(roundData[i].no); valueArr.push(roundData[i].value); }
      else { noArr.push(""); valueArr.push(""); }
    }

    const payload = { date: dateInput.value, no: noArr, value: valueArr };

    try {
      const res = await fetch(scriptUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // Apps Script doPostì—ì„œ e.postData.contentsë¡œ ë°›ë„ë¡
        body: JSON.stringify({ saengmyeon: payload, force: force ? 1 : 0 })
      });

      const text = await res.text();
      alert("ì €ì¥ ê²°ê³¼: " + text);

      // ì´ˆê¸°í™” (ë‚ ì§œëŠ” ìœ ì§€í•˜ë ¤ë©´ ì•„ë˜ í•œ ì¤„ ì‚­ì œ)
      Object.keys(roundData).forEach(k => delete roundData[k]);
      document.querySelectorAll(".result").forEach(el => el.textContent = "");
      document.querySelectorAll(".btn").forEach(btn => btn.classList.remove("selected"));
      duplicateMsg.style.display = "none";
    } catch (err) {
      alert("ì—ëŸ¬ ë°œìƒ: " + err.message);
    }
  }

  // ì €ì¥ ë²„íŠ¼ â†’ ì¤‘ë³µ í™•ì¸ í›„ ì €ì¥
  submitBtn.addEventListener("click", async () => {
    if (!dateInput.value) { alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
    if (!validateRounds()) return;

    try {
      // âœ… GET ì¤‘ë³µí™•ì¸ (ê·¸ëŒ€ë¡œ ìœ ì§€)
      const res = await fetch(`${scriptUrl}?checkSaengmyeon=${encodeURIComponent(JSON.stringify({ date: dateInput.value }))}`);
      const data = await res.json();

      if (data.exists) {
        duplicateText.textContent = `âš ï¸ ${dateInput.value} ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`;
        duplicateMsg.style.display = "block";
        duplicateConfirmBtn.onclick = () => saveData(true);
        duplicateCancelBtn.onclick = () => {
          Object.keys(roundData).forEach(k => delete roundData[k]);
          document.querySelectorAll(".result").forEach(el => el.textContent = "");
          document.querySelectorAll(".btn").forEach(btn => btn.classList.remove("selected"));
          duplicateMsg.style.display = "none";
        };
      } else {
        saveData(false);
      }
    } catch (err) {
      alert("ì¤‘ë³µ í™•ì¸ ì‹¤íŒ¨: " + err.message);
    }
  });
});
</script>
</body>
</html>
