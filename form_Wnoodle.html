<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìƒë©´ê³µì • ì…ë ¥</title>
<style>
body, html {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: sans-serif;
}
.app-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}
.app-header {
  background-color: #4CAF50;
  color: white;
  text-align: center;
  padding: 20px;
  font-size: 2rem;
  flex: 0 0 auto;
}
.app-body {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 20px;
  box-sizing: border-box;
  background-color: #f9f9f9;
}
.app-footer {
  flex: 0 0 auto;
}
#submitBtn {
  width: 100%;
  font-size: 1.8rem;
  padding: 24px 0;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 0;
  cursor: pointer;
}

/* í•œ í–‰ ë ˆì´ì•„ì›ƒ ê³ ì • */
.row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  background: #fff;
  padding: 16px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  flex-wrap: nowrap; /* í•­ìƒ í•œ ì¤„ ìœ ì§€ */
}
.label {
  flex: 0 0 60px; /* ê³ ì •í­ */
  font-weight: bold;
  font-size: 1.4rem;
  text-align: left;
}
.btn {
  flex: 1 1 0;      /* ë‘ ë²„íŠ¼ì´ ë‚¨ì€ ê³µê°„ì„ ê· ë“± ë¶„ë°° */
  min-width: 0;     /* ê¸¸ì–´ì ¸ë„ ì¤„ë°”ê¿ˆ ì—†ì´ ì¶•ì†Œ */
  padding: 16px 12px;
  border-radius: 8px;
  cursor: pointer;
  border: none;
  font-size: 1.4rem;
  font-weight: bold;
  background: #e0e0e0; /* ê¸°ë³¸ íšŒìƒ‰ */
  color: #333;
  transition: background 0.2s, color 0.2s, box-shadow 0.2s;
}
.btn.selected {
  background: #4CAF50; /* ì„ íƒ ì‹œ ê³µí†µ ìƒ‰ìƒ */
  color: white;
  box-shadow: inset 0 0 0 2px #2e7d32;
}
.result {
  margin-left: auto;   /* ì˜¤ë¥¸ìª½ ëìœ¼ë¡œ ë°€ê¸° */
  flex: 0 0 auto;
  min-width: 110px;
  text-align: right;
  font-size: 1.4rem;
  font-weight: bold;
  color: #333;
}

/* ì¤‘ë³µ ë©”ì‹œì§€ */
#duplicateMsg {
  display: none;
  background-color: #ffcccc;
  color: #900;
  padding: 14px;
  margin-top: 8px;
  border: 1px solid #900;
  border-radius: 6px;
  font-weight: bold;
  font-size: 1.2rem;
}
#duplicateMsg button {
  margin-left: 14px;
  background-color: #900;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
}

/* ëª¨ë°”ì¼ ì „ìš©: í•œ ì¤„ ìœ ì§€í•˜ë©´ì„œ í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
@media (max-width: 768px) {
  .row { gap: 6px; padding: 14px; }
  .label { flex-basis: 56px; font-size: 1.6rem; }
  .btn { font-size: 1.6rem; padding: 16px 8px; }
  .result { font-size: 1.6rem; min-width: 100px; }
}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ìƒë©´ê³µì • ì ê²€ ì…ë ¥</div>

  <div class="app-body">
    <!-- ë‚ ì§œ -->
    <label for="date">ë‚ ì§œ</label>
    <input type="date" id="date" required style="font-size:1.4rem; padding:10px; width:100%; margin-bottom:20px;" />

    <!-- 1ì°¨~10ì°¨ -->
    <h3 style="margin-top:20px;">ì°¨ìˆ˜ë³„ ì…ë ¥</h3>
    <div id="rounds"></div>

    <!-- ì¤‘ë³µ ë©”ì‹œì§€ -->
    <div id="duplicateMsg">
      <span id="duplicateText"></span>
      <button id="duplicateConfirmBtn">í™•ì¸</button>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ“¥ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById("date");
  const submitBtn = document.getElementById("submitBtn");
  const roundsDiv = document.getElementById("rounds");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");

  const scriptUrl = "https://script.google.com/macros/s/AKfycbzuT-_RAwyZvrq8GmRmHcR8G3LI8u4xiqOw4SmMEqVOfOeJ-kNH5BCaS6nKsjK3WyDBtA/exec";

  // --- ë³´ì¡°: ë¡œë”© í‘œì‹œ ìš”ì†Œë¥¼ ë™ì ìœ¼ë¡œ ì¶”ê°€ (date ì…ë ¥ ë°”ë¡œ ì˜†ì— í‘œì‹œ)
  let loadingDiv = document.getElementById("saengLoading");
  if (!loadingDiv) {
    loadingDiv = document.createElement("div");
    loadingDiv.id = "saengLoading";
    loadingDiv.style.display = "none";
    loadingDiv.style.marginTop = "8px";
    loadingDiv.style.padding = "8px";
    loadingDiv.style.background = "#007bff";
    loadingDiv.style.color = "#fff";
    loadingDiv.style.borderRadius = "6px";
    loadingDiv.style.fontWeight = "bold";
    loadingDiv.textContent = "ì¤‘ë³µ í™•ì¸ ì¤‘...";
    // insert after date input
    if (dateInput && dateInput.parentNode) {
      dateInput.parentNode.insertBefore(loadingDiv, dateInput.nextSibling);
    } else {
      document.querySelector('.app-body').prepend(loadingDiv);
    }
  }

  // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì…ë ¥
  dateInput.valueAsDate = new Date();

  // ë°ì´í„° ì €ì¥ìš©
  let roundData = {};

  // UI ìƒì„±: 1~10ì°¨
  for (let i = 1; i <= 10; i++) {
    const row = document.createElement("div");
    row.className = "row";
    row.setAttribute('data-round', i);

    row.innerHTML = `
      <div class="label">${i}ì°¨</div>
      <button class="btn" type="button" onclick="selectOption(${i}, '3í¬')" aria-pressed="false">3í¬</button>
      <button class="btn" type="button" onclick="selectOption(${i}, '2í¬')" aria-pressed="false">2í¬</button>
      <div id="result${i}" class="result"></div>
    `;
    roundsDiv.appendChild(row);
  }

  // ì„ íƒ ì²˜ë¦¬ (í•´ë‹¹ í–‰ ìš”ì†Œ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì‘)
  window.selectOption = function(round, type) {
    const rowEl = roundsDiv.children[round - 1];          // ië²ˆì§¸ í–‰
    const btns = rowEl.querySelectorAll('.btn');          // í•´ë‹¹ í–‰ì˜ ë‘ ë²„íŠ¼

    let no, value;
    if (type === "3í¬") { no = 60; value = 1; }
    else { no = 40; value = 0.7; }

    roundData[round] = { no, value };
    document.getElementById("result"+round).textContent = `ì£¼ì • ${value} kg`;

    // ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸ í† ê¸€ (ì„ íƒ ë²„íŠ¼ë§Œ selected)
    btns.forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
    if (type === "3í¬") {
      btns[0].classList.add('selected');
      btns[0].setAttribute('aria-pressed','true');
    } else {
      btns[1].classList.add('selected');
      btns[1].setAttribute('aria-pressed','true');
    }
  }

  // --- ì¤‘ë³µ í™•ì¸ í•¨ìˆ˜ (ì„œë²„ì™€ í†µì‹ , ë¡œë”©/ë©”ì‹œì§€ í‘œì‹œ ì²˜ë¦¬)
  let lastCheckedDate = null;
  async function checkDuplicate(date) {
    if (!date) return;
    lastCheckedDate = date;

    // UI: ë¡œë”© í‘œì‹œ
    loadingDiv.style.display = "block";
    duplicateMsg.style.display = "none";
    submitBtn.disabled = true;

    try {
      const query = encodeURIComponent(JSON.stringify({ date }));
      const url = `${scriptUrl}?checkSaengmyeon=${query}`;

      const res = await fetch(url);
      // ì„œë²„ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹ˆê±°ë‚˜ íŒŒì‹± ì‹¤íŒ¨í•´ë„ catchë¡œ ì´ë™í•¨
      const data = await res.json();

      // ìš”ì²­-ì‘ë‹µ ìˆœì„œ ë³´ì¥: ì‚¬ìš©ìê°€ ë‹¤ë¥¸ ë‚ ì§œë¥¼ ì´ë¯¸ ë°”ê¿¨ë‹¤ë©´ ìµœì‹  ì²´í¬ ê²°ê³¼ê°€ ì•„ë‹ˆë¯€ë¡œ ë¬´ì‹œ
      if (lastCheckedDate !== date) {
        // ë¬´ì‹œ: ë‹¤ë¥¸ ì²´í¬ê°€ ì§„í–‰ì¤‘
        return;
      }

      if (data && data.exists) {
        duplicateText.textContent = `âš ï¸ ${date} ì— ì´ë¯¸ ì…ë ¥ëœ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.`;
        duplicateMsg.style.display = "block";
        submitBtn.disabled = true;
      } else {
        duplicateMsg.style.display = "none";
        submitBtn.disabled = false;
      }
    } catch (err) {
      console.error("ìƒë©´ê³µì • ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜:", err);
      // ì¤‘ë³µí™•ì¸ ì‹¤íŒ¨ ì‹œì—ëŠ” ì‚¬ìš©ìê°€ ì €ì¥ ëª»í•˜ë„ë¡ í•˜ê±°ë‚˜ í—ˆìš©í•  ìˆ˜ ìˆìŒ â€” ì—¬ê¸°ì„  ê²½ê³ ëŠ” ë„ìš°ê³  ì €ì¥ì€ í—ˆìš©í•˜ì§€ ì•ŠìŒ
      duplicateText.textContent = "ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
      duplicateMsg.style.display = "block";
      submitBtn.disabled = true;
    } finally {
      loadingDiv.style.display = "none";
    }
  }

  // date ë³€ê²½ ì‹œ ì¦‰ì‹œ ì¤‘ë³µ í™•ì¸
  dateInput.addEventListener("change", () => {
    if (dateInput.value) checkDuplicate(dateInput.value);
  });

  // duplicate confirm (ì‚¬ìš©ì ê°•ì œ ì €ì¥ í—ˆìš©)
  duplicateConfirmBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    submitBtn.disabled = false;
  });

  // --- ì €ì¥(ì œì¶œ) ì²˜ë¦¬
  submitBtn.addEventListener("click", async () => {
    if (!dateInput.value) {
      alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    // 1) ì°¨ìˆ˜ ì—°ì†ì„± ê²€ì‚¬: ì„ íƒëœ ì°¨ìˆ˜ë“¤ì— ëŒ€í•´ ì•ì°¨ìˆ˜ë“¤ ì²´í¬
    // roundDataì˜ í‚¤ë“¤ì„ ìˆ«ì ë°°ì—´ë¡œ
    const selectedRounds = Object.keys(roundData).map(x => parseInt(x,10)).sort((a,b)=>a-b);

    // ë°˜ë“œì‹œ 1ì°¨ê°€ ì„ íƒë˜ì–´ì•¼ í•¨
    if (!selectedRounds.includes(1)) {
      alert("ìµœì´ˆ 1ì°¨ëŠ” ë°˜ë“œì‹œ ì„ íƒë˜ì–´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

    // ëˆ„ë½ëœ ì•ì°¨ìˆ˜ ê²€ì‚¬: ì˜ˆë¥¼ ë“¤ì–´ 3ì°¨ê°€ ì„ íƒë˜ì—ˆìœ¼ë©´ 1~2ì°¨ê°€ ëª¨ë‘ ì„ íƒë˜ì–´ì•¼ í•¨
    const missing = new Set();
    for (const r of selectedRounds) {
      for (let k = 1; k < r; k++) {
        if (!selectedRounds.includes(k)) missing.add(k);
      }
    }
    if (missing.size > 0) {
      // ì •ë ¬í•´ì„œ ë©”ì‹œì§€ ë§Œë“¤ê¸°
      const arr = Array.from(missing).sort((a,b)=>a-b);
      const txt = arr.map(n => `${n}ì°¨`).join(", ");
      alert(`${txt} ì²´í¬ê°€ ì•ˆë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì•ì°¨ìˆ˜ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.`);
      return;
    }

    // 2) ì„œë²„ ì¤‘ë³µ ë©”ì‹œì§€ í‘œì‹œ ìƒíƒœ í™•ì¸: ë§Œì•½ duplicateMsg ë³´ì´ëŠ” ìƒíƒœë©´ ì €ì¥ ë¶ˆê°€(ë‹¨, ì‚¬ìš©ìê°€ í™•ì¸ ë²„íŠ¼ ëˆŒëŸ¬ ê°•ì œ ì €ì¥ í—ˆìš© ê°€ëŠ¥)
    if (duplicateMsg.style.display === "block" && submitBtn.disabled) {
      alert("ê°™ì€ ë‚ ì§œ ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ê³„ì†í•˜ë ¤ë©´ ì¤‘ë³µ ì•Œë¦¼ì—ì„œ í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
      return;
    }

    // ìˆ˜ì§‘ ë° ì „ì†¡
    const noArr = [], valueArr = [];
    for (let i = 1; i <= 10; i++) {
      if (roundData[i]) {
        noArr.push(roundData[i].no);
        valueArr.push(roundData[i].value);
      } else {
        noArr.push("");
        valueArr.push("");
      }
    }

    const payload = {
      date: dateInput.value,
      no: noArr,
      value: valueArr
    };

    try {
      // FormData ë°©ì‹ (ê¸°ì¡´ê³¼ í˜¸í™˜)
      const res = await fetch(scriptUrl, {
        method: "POST",
        body: new URLSearchParams({
          saengmyeon: JSON.stringify(payload)
        })
      });

      const text = await res.text();
      alert("ì €ì¥ ì™„ë£Œ: " + text);

      // ì €ì¥ ì„±ê³µ ì‹œ ì´ˆê¸°í™”
      Object.keys(roundData).forEach(k => delete roundData[k]);
      document.querySelectorAll(".result").forEach(el => el.textContent = "");
      document.querySelectorAll(".btn").forEach(btn => {
        btn.classList.remove("selected");
        btn.setAttribute('aria-pressed','false');
      });
      dateInput.valueAsDate = new Date();

      // ì €ì¥ í›„ ì¦‰ì‹œ ì¤‘ë³µ ì²´í¬ (ìƒˆë¡œìš´ ì˜¤ëŠ˜ ë‚ ì§œì— ëŒ€í•´)
      if (dateInput.value) checkDuplicate(dateInput.value);
    } catch (err) {
      alert("ì—ëŸ¬ ë°œìƒ: " + err.message);
    }
  });

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœì´ˆ ì¤‘ë³µ í™•ì¸
  if (dateInput.value) checkDuplicate(dateInput.value);
});
</script>

</body>
</html>
