<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>생면공정 입력폼</title>
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    padding: 0;
    background: #f9f9f9;
  }
  .container {
    max-width: 600px;
    margin: auto;
    padding: 16px;
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 16px;
  }
  input[type="date"], input[type="number"] {
    width: 100%;
    padding: 12px;
    font-size: 1.2rem;
    margin-top: 6px;
    box-sizing: border-box;
    text-align: center;
  }
  .round-row {
    margin-top: 16px;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    background: #fff;
  }
  .round-header {
    font-weight: bold;
    margin-bottom: 8px;
    cursor: pointer;
  }
  .btn-group {
    display: flex;
    gap: 10px;
  }
  .btn {
    flex: 1;
    padding: 16px;
    font-size: 1.2rem;
    background: #eee;
    border: 1px solid #ccc;
    cursor: pointer;
    border-radius: 8px;
    text-align: center;
  }
  .btn.selected {
    background: #007bff;
    color: #fff;
    border-color: #0056b3;
  }
  .result-input {
    margin-top: 8px;
  }
  .result-input input {
    width: 100%;
    padding: 12px;
    font-size: 1.2rem;
    text-align: center;
  }
  .submit-btn {
    width: 100%;
    font-size: 1.4rem;
    padding: 18px;
    margin-top: 20px;
    background: #28a745;
    border: none;
    color: #fff;
    cursor: pointer;
    border-radius: 8px;
  }
  .submit-btn:hover {
    background: #218838;
  }
  #duplicateMsg {
    background: #ffc107;
    color: #000;
    padding: 12px;
    margin-top: 12px;
    border-radius: 8px;
    display: none;
    text-align: center;
  }
  #duplicateMsg button {
    margin: 8px;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  #duplicateConfirmBtn {
    background: #007bff;
    color: #fff;
  }
  #duplicateCancelBtn {
    background: #6c757d;
    color: #fff;
  }
</style>
</head>
<body>
<div class="container">
  <h2>생면공정 입력</h2>
  <label>날짜
    <input type="date" id="date" />
  </label>

  <div id="roundsContainer"></div>

  <button class="submit-btn" id="submitBtn">저장</button>

  <div id="duplicateMsg">
    <span id="duplicateText"></span><br/>
    <button id="duplicateConfirmBtn">진행</button>
    <button id="duplicateCancelBtn">취소</button>
  </div>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbzuT-_RAwyZvrq8GmRmHcR8G3LI8u4xiqOw4SmMEqVOfOeJ-kNH5BCaS6nKsjK3WyDBtA/exec"; // Apps Script 웹앱 URL 넣으세요
const roundsContainer = document.getElementById("roundsContainer");
const submitBtn = document.getElementById("submitBtn");
const duplicateMsg = document.getElementById("duplicateMsg");
const duplicateText = document.getElementById("duplicateText");
const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
const duplicateCancelBtn = document.getElementById("duplicateCancelBtn");
const dateInput = document.getElementById("date");

let roundData = {}; // { round: {no: 60|40, value: number}}

dateInput.valueAsDate = new Date();

// 1차~10차 UI 생성
for (let i = 1; i <= 10; i++) {
  const row = document.createElement("div");
  row.className = "round-row";

  const header = document.createElement("div");
  header.className = "round-header";
  header.textContent = `${i}차`;
  header.dataset.round = i;
  // 클릭시 초기화
  header.addEventListener("click", () => {
    delete roundData[i];
    row.querySelectorAll(".btn").forEach(b => b.classList.remove("selected"));
    row.querySelector("input").value = "";
  });
  row.appendChild(header);

  const btnGroup = document.createElement("div");
  btnGroup.className = "btn-group";

  ["60", "40"].forEach(val => {
    const btn = document.createElement("div");
    btn.className = "btn";
    btn.textContent = val;
    btn.addEventListener("click", () => {
      row.querySelectorAll(".btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      if (!roundData[i]) roundData[i] = {};
      roundData[i].no = val;
    });
    btnGroup.appendChild(btn);
  });
  row.appendChild(btnGroup);

  const resultDiv = document.createElement("div");
  resultDiv.className = "result-input";
  resultDiv.innerHTML = `<input type="number" placeholder="결과값" />`;
  resultDiv.querySelector("input").addEventListener("input", e => {
    if (!roundData[i]) roundData[i] = {};
    roundData[i].value = e.target.value;
  });
  row.appendChild(resultDiv);

  roundsContainer.appendChild(row);
}

// 차수 연속성 체크
function validateRounds() {
  for (let i = 1; i <= 10; i++) {
    if (roundData[i]) {
      for (let j = 1; j < i; j++) {
        if (!roundData[j]) {
          alert(`${j}차수가 체크되지 않았습니다.`);
          return false;
        }
      }
    }
  }
  if (!roundData[1]) {
    alert("최초 1차는 반드시 선택되어야 합니다.");
    return false;
  }
  return true;
}

// 저장 버튼 클릭
submitBtn.addEventListener("click", async () => {
  if (!dateInput.value) {
    alert("날짜를 선택하세요.");
    return;
  }
  if (!validateRounds()) return;

  try {
    // ✅ 중복 확인 요청
    const res = await fetch(
      `${scriptUrl}?checkSaengmyeon=${encodeURIComponent(JSON.stringify({ date: dateInput.value }))}`
    );
    const data = await res.json();

    if (data.exists) {
      duplicateText.textContent = `⚠️ ${dateInput.value} 데이터가 이미 존재합니다.`;
      duplicateMsg.style.display = "block";

      duplicateConfirmBtn.onclick = () => {
        duplicateMsg.style.display = "none";
        saveData(true);
      };

      duplicateCancelBtn.onclick = () => {
        roundData = {};
        document.querySelectorAll(".btn").forEach(btn => btn.classList.remove("selected"));
        document.querySelectorAll(".result-input input").forEach(inp => inp.value = "");
        duplicateMsg.style.display = "none";
      };
    } else {
      saveData(false);
    }
  } catch (err) {
    alert("❌ 중복 확인 실패: " + err.message);
  }
});

async function saveData(isUpdate) {
  const payload = {
    date: dateInput.value,
    data: roundData,
    update: isUpdate
  };

  const formData = new FormData();
  formData.append("saengmyeon", JSON.stringify(payload));

  try {
    const res = await fetch(scriptUrl, {
      method: "POST",
      body: formData
    });
    const text = await res.text();
    alert("✅ 저장 완료\n" + text);

    // 초기화
    roundData = {};
    document.querySelectorAll(".btn").forEach(btn => btn.classList.remove("selected"));
    document.querySelectorAll(".result-input input").forEach(inp => inp.value = "");
    dateInput.valueAsDate = new Date();
  } catch (err) {
    alert("❌ 저장 실패: " + err.message);
  }
}
</script>
</body>
</html>
