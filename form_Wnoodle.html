<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ÏÉùÎ©¥Í≥µÏ†ï Ï†êÍ≤Ä</title>
<style>
body {
  font-family: sans-serif;
  margin: 0;
  padding: 0;
  background: #f9f9f9;
}
.app-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
}
.app-header {
  flex: 0 0 auto;
  background-color: #4CAF50;
  color: white;
  text-align: center;
  padding: 16px;
  font-size: 1.5rem;
}
.app-body {
  flex: 1 1 auto;
  overflow-y: auto;
  padding: 16px;
}
.app-footer {
  flex: 0 0 auto;
  position: sticky;
  bottom: 0;
}
button[type="submit"] {
  width: 100%;
  font-size: 1.4rem;
  padding: 18px 0;
  background-color: #28a745;
  color: white;
  border: none;
  border-radius: 0;
  cursor: pointer;
}
button[type="submit"]:hover {
  background-color: #218838;
}
label {
  display: block;
  margin-top: 20px;
  font-weight: bold;
}
input, select {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  box-sizing: border-box;
  text-align: center;
  font-size: 1.1rem;
}
.chasu-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}
.chasu-btn {
  flex: 1 1 30%;
  padding: 12px;
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.1rem;
}
.chasu-btn.selected {
  background: #007bff;
  color: white;
  border-color: #0056b3;
}
.result-cell {
  margin-top: 8px;
  text-align: right;
  font-weight: bold;
  color: #333;
}
#duplicateMsg {
  background-color: #ffc107;
  color: white;
  padding: 10px;
  margin-top: 10px;
  text-align: center;
  border-radius: 4px;
  display: none;
}
#duplicateMsg button {
  margin: 6px;
  padding: 8px 14px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
#duplicateProceed { background: #007bff; color: white; }
#duplicateCancel { background: #dc3545; color: white; }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ÏÉùÎ©¥Í≥µÏ†ï Ï†êÍ≤Ä</div>

  <form id="saengmyeonForm" class="app-body">
    <label>ÎÇ†Ïßú
      <input type="date" id="date" name="date" required />
    </label>

    <label>Ï∞®Ïàò ÏÑ†ÌÉù</label>
    <div class="chasu-row" id="chasuContainer"></div>
    <div id="resultArea" class="result-cell"></div>

    <div id="duplicateMsg">
      <div id="duplicateText"></div>
      <button type="button" id="duplicateProceed">ÏßÑÌñâ</button>
      <button type="button" id="duplicateCancel">Ï∑®ÏÜå</button>
    </div>
  </form>

  <div class="app-footer">
    <button type="submit" form="saengmyeonForm">Ï†ÄÏû•</button>
  </div>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbzuT-_RAwyZvrq8GmRmHcR8G3LI8u4xiqOw4SmMEqVOfOeJ-kNH5BCaS6nKsjK3WyDBtA/exec";

// ÎÇ†Ïßú Í∏∞Î≥∏Í∞í
const dateInput = document.getElementById("date");
dateInput.valueAsDate = new Date();

// Ï∞®Ïàò Î≤ÑÌäº ÏÉùÏÑ±
const chasuLabels = ["1Ï∞®(3Ìè¨)", "2Ï∞®(2Ìè¨)", "3Ï∞®(3Ìè¨)", "4Ï∞®(2Ìè¨)", "5Ï∞®(3Ìè¨)", "6Ï∞®(2Ìè¨)", "7Ï∞®(3Ìè¨)", "8Ï∞®(2Ìè¨)", "9Ï∞®(3Ìè¨)", "10Ï∞®(2Ìè¨)"];
const chasuContainer = document.getElementById("chasuContainer");
let selectedChasu = null;
let selectedResult = "";

chasuLabels.forEach((label, idx) => {
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "chasu-btn";
  btn.textContent = label;
  btn.dataset.chasu = idx + 1;
  btn.addEventListener("click", () => {
    // ÏÑ†ÌÉù Ï∑®ÏÜå
    if (btn.classList.contains("selected")) {
      btn.classList.remove("selected");
      selectedChasu = null;
      selectedResult = "";
      document.getElementById("resultArea").innerText = "";
      return;
    }

    // Îã§Î•∏ Î≤ÑÌäº Ìï¥Ï†ú
    document.querySelectorAll(".chasu-btn").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");

    selectedChasu = idx + 1;
    selectedResult = (label.includes("3Ìè¨") ? "Ï£ºÏ†ï 1kg" : "Ï£ºÏ†ï 0.7kg");
    document.getElementById("resultArea").innerText = `${label} ‚Üí ${selectedResult}`;
  });
  chasuContainer.appendChild(btn);
});

// Ï§ëÎ≥µ ÌôïÏù∏ Î©îÏãúÏßÄ
const duplicateMsg = document.getElementById("duplicateMsg");
const duplicateText = document.getElementById("duplicateText");
const duplicateProceed = document.getElementById("duplicateProceed");
const duplicateCancel = document.getElementById("duplicateCancel");

// Ìèº Ï†úÏ∂ú
document.getElementById("saengmyeonForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  if (!selectedChasu) {
    alert("Ï∞®ÏàòÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
    return;
  }

  const dateVal = dateInput.value;
  if (!dateVal) {
    alert("ÎÇ†ÏßúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
    return;
  }

  // üîπ 1Ï∞® ÎØ∏ÏÑ†ÌÉù Ïãú Ïù¥ÌõÑ Ï∞®Ïàò Î∂àÍ∞Ä
  if (selectedChasu > 1) {
    const missing = [];
    for (let i = 1; i < selectedChasu; i++) {
      // Ïã§Ï†úÎ°ú Ï≤¥ÌÅ¨ÌñàÎäîÏßÄ Í≤ÄÏ¶ù Î°úÏßÅ ÌïÑÏöî (ÏòàÏ†úÏóêÏÑúÎäî Îã®ÏàúÌûà ÏÑ†ÌÉùÍ∞íÎßå ÌôïÏù∏)
      if (i !== selectedChasu) missing.push(`${i}Ï∞®`);
    }
    if (missing.length > 0 && !document.querySelector(`.chasu-btn[data-chasu="1"]`).classList.contains("selected")) {
      alert(`‚ö†Ô∏è ${missing.join(", ")} Ï∞®ÏàòÍ∞Ä Ï≤¥ÌÅ¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.\nÏµúÏ¥à 1Ï∞®Îäî Î∞òÎìúÏãú ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§.`);
      return;
    }
  }

  // üîπ Ï†ÄÏû• Ï†Ñ Ï§ëÎ≥µ Ï≤¥ÌÅ¨
  try {
    const query = encodeURIComponent(dateVal);
    const res = await fetch(`${scriptUrl}?checkDate=${query}`);
    const result = await res.json();

    if (result.exists) {
      duplicateText.innerText = `‚ö†Ô∏è Ïù¥ÎØ∏ Í∞ôÏùÄ ÎÇ†Ïßú(${dateVal})Ïóê Îç∞Ïù¥ÌÑ∞Í∞Ä Ï°¥Ïû¨Ìï©ÎãàÎã§. ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
      duplicateMsg.style.display = "block";

      duplicateProceed.onclick = () => {
        duplicateMsg.style.display = "none";
        saveData(true);
      };
      duplicateCancel.onclick = () => {
        duplicateMsg.style.display = "none";
        document.getElementById("saengmyeonForm").reset();
        document.getElementById("resultArea").innerText = "";
        document.querySelectorAll(".chasu-btn").forEach(b => b.classList.remove("selected"));
        selectedChasu = null;
        selectedResult = "";
      };
    } else {
      saveData(false);
    }
  } catch (err) {
    alert("Ï§ëÎ≥µ ÌôïÏù∏ Ïò§Î•ò: " + err.message);
  }
});

// üîπ Ïã§Ï†ú Ï†ÄÏû• Ìï®Ïàò
async function saveData(update) {
  const data = {
    type: "saengmyeon",
    date: dateInput.value,
    chasu: selectedChasu,
    result: selectedResult,
    update
  };

  const formData = new FormData();
  formData.append("saengmyeon", JSON.stringify(data));

  try {
    const response = await fetch(scriptUrl, { method: "POST", body: formData });
    const result = await response.text();
    if (response.ok) {
      alert("‚úÖ Ï†ÄÏû• ÏôÑÎ£å:\n" + result);
      document.getElementById("saengmyeonForm").reset();
      document.getElementById("resultArea").innerText = "";
      document.querySelectorAll(".chasu-btn").forEach(b => b.classList.remove("selected"));
      selectedChasu = null;
      selectedResult = "";
      dateInput.valueAsDate = new Date();
    } else {
      alert("‚ùå ÏÑúÎ≤Ñ Ïò§Î•ò:\n" + result);
    }
  } catch (err) {
    alert("‚ùå Ï†ÄÏû• Ï§ë Ïò§Î•ò:\n" + err.message);
  }
}
</script>
</body>
</html>
