<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>생면공정 입력</title>
<style>
/* 레이아웃 */
body, html {
  margin: 0; padding: 0; height: 100%; font-family: sans-serif;
}
.app-container { display: flex; flex-direction: column; height: 100%; }
.app-header { background: #4CAF50; color: #fff; text-align: center; padding: 20px; font-size: 2rem; flex: 0 0 auto; }
.app-body { flex: 1 1 auto; overflow-y: auto; padding: 20px; box-sizing: border-box; background: #f9f9f9; }
.app-footer { flex: 0 0 auto; }
#submitBtn { width: 100%; font-size: 1.8rem; padding: 24px 0; background: #4CAF50; color: white; border: none; cursor: pointer; }

/* 행 */
.row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-wrap: nowrap; }
.label { flex: 0 0 60px; font-weight: bold; font-size: 1.4rem; }
.btn { flex: 1 1 0; min-width: 0; padding: 16px 12px; border-radius: 8px; cursor: pointer; border: none; font-size: 1.4rem; font-weight: bold; background: #e0e0e0; color: #333; transition: 0.2s; }
.btn.selected { background: #4CAF50; color: #fff; box-shadow: inset 0 0 0 2px #2e7d32; }
.result { margin-left: auto; flex: 0 0 auto; min-width: 110px; text-align: right; font-size: 1.4rem; font-weight: bold; color: #333; }

/* 중복 메시지 */
#duplicateMsg { display: none; background: #ffcccc; color: #900; padding: 14px; margin-top: 8px; border: 1px solid #900; border-radius: 6px; font-weight: bold; font-size: 1.2rem; }
#duplicateMsg button { margin-left: 14px; background: #900; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 1rem; }

/* 모바일 대응 */
@media (max-width: 768px) {
  .row { gap: 6px; padding: 14px; }
  .label { flex-basis: 56px; font-size: 1.6rem; }
  .btn { font-size: 1.6rem; padding: 16px 8px; }
  .result { font-size: 1.6rem; min-width: 100px; }
}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">생면공정 점검 입력</div>
  <div class="app-body">
    <!-- 날짜 -->
    <label for="date">날짜</label>
    <input type="date" id="date" required style="font-size:1.4rem; padding:10px; width:100%; margin-bottom:20px;" />

    <!-- 1차~10차 -->
    <h3 style="margin-top:20px;">차수별 입력</h3>
    <div id="rounds"></div>

    <!-- 중복 메시지 -->
    <div id="duplicateMsg">
      <span id="duplicateText"></span>
      <button id="duplicateConfirmBtn">확인</button>
      <button id="duplicateCancelBtn">취소</button>
    </div>
  </div>
  <div class="app-footer">
    <button id="submitBtn">📥 저장하기</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById("date");
  const submitBtn = document.getElementById("submitBtn");
  const roundsDiv = document.getElementById("rounds");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
  const duplicateCancelBtn = document.getElementById("duplicateCancelBtn");

  const scriptUrl = "https://script.google.com/macros/s/AKfycbzuT-_RAwyZvrq8GmRmHcR8G3LI8u4xiqOw4SmMEqVOfOeJ-kNH5BCaS6nKsjK3WyDBtA/exec";

  // 오늘 날짜 기본
  dateInput.valueAsDate = new Date();

  let roundData = {};

  // 1~10차 UI 생성
  for (let i = 1; i <= 10; i++) {
    const row = document.createElement("div");
    row.className = "row";
    row.setAttribute('data-round', i);

    row.innerHTML = `
      <div class="label" style="cursor:pointer;">${i}차</div>
      <button class="btn" type="button" onclick="selectOption(${i}, '3포')">3포</button>
      <button class="btn" type="button" onclick="selectOption(${i}, '2포')">2포</button>
      <div id="result${i}" class="result"></div>
    `;
    roundsDiv.appendChild(row);
  }

  // 선택 함수
  window.selectOption = function(round, type) {
    const rowEl = roundsDiv.children[round - 1];
    const btns = rowEl.querySelectorAll('.btn');
    let no, value;
    if (type === "3포") { no = 60; value = 1; }
    else { no = 40; value = 0.7; }

    roundData[round] = { no, value };
    document.getElementById("result"+round).textContent = `주정 ${value} kg`;

    btns.forEach(b => b.classList.remove('selected'));
    if (type === "3포") btns[0].classList.add('selected'); else btns[1].classList.add('selected');
  }

  // 행 라벨 클릭 → 초기화
  roundsDiv.addEventListener("click", (e) => {
    if (e.target.classList.contains("label")) {
      const round = e.target.parentElement.getAttribute("data-round");
      delete roundData[round];
      e.target.parentElement.querySelectorAll(".btn").forEach(btn => btn.classList.remove("selected"));
      e.target.parentElement.querySelector(".result").textContent = "";
    }
  });

  // 유효성 검사
  function validateRounds() {
    if (!roundData[1]) { alert("⚠️ 1차는 반드시 선택해야 합니다."); return false; }
    for (let i = 1; i <= 10; i++) {
      if (!roundData[i]) {
        for (let j = i+1; j <= 10; j++) {
          if (roundData[j]) { alert(`⚠️ ${i}차수가 비어 있습니다.`); return false; }
        }
      }
    }
    return true;
  }

  // 저장
  async function saveData(force = false) {
    const noArr = [], valueArr = [];
    for (let i = 1; i <= 10; i++) {
      noArr.push(roundData[i]?.no || "");
      valueArr.push(roundData[i]?.value || "");
    }

    const payload = { date: dateInput.value, no: noArr, value: valueArr };

    try {
      const res = await fetch(scriptUrl, {
        method: "POST",
        body: new URLSearchParams({ saengmyeon: JSON.stringify(payload), force: force ? "1" : "0" })
      });
      const text = await res.text();
      alert("저장 완료: " + text);

      // 초기화
      roundData = {};
      document.querySelectorAll(".result").forEach(el => el.textContent = "");
      document.querySelectorAll(".btn").forEach(btn => btn.classList.remove("selected"));
      dateInput.valueAsDate = new Date();
      duplicateMsg.style.display = "none";
    } catch (err) { alert("에러 발생: " + err.message); }
  }

  // 저장 버튼 → 중복 확인
  submitBtn.addEventListener("click", async () => {
    if (!dateInput.value) { alert("날짜 선택하세요"); return; }
    if (!validateRounds()) return;

    try {
      const res = await fetch(`${scriptUrl}?checkSaengmyeon=${encodeURIComponent(JSON.stringify({ date: dateInput.value }))}`);
      const data = await res.json();

      if (data.exists) {
        duplicateText.textContent = `⚠️ ${dateInput.value} 데이터가 이미 존재합니다.`;
        duplicateMsg.style.display = "block";
        duplicateConfirmBtn.onclick = () => saveData(true);
        duplicateCancelBtn.onclick = () => {
          roundData = {};
          document.querySelectorAll(".result").forEach(el => el.textContent = "");
          document.querySelectorAll(".btn").forEach(btn => btn.classList.remove("selected"));
          duplicateMsg.style.display = "none";
        };
      } else {
        saveData(false);
      }
    } catch (err) { alert("중복 확인 실패: " + err.message); }
  });
});
</script>
</body>
</html>
