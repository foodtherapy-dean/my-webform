<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>생면공정 입력</title>
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
.app-container { display:flex; flex-direction:column; height:100%; }
.app-header { background:#4CAF50; color:#fff; text-align:center; padding:20px; font-size:2rem; }
.app-body { flex:1 1 auto; overflow-y:auto; padding:20px; box-sizing:border-box; background:#f9f9f9; }
.app-footer { flex:0 0 auto; }
#submitBtn { width:100%; font-size:1.8rem; padding:24px 0; background:#4CAF50; color:#fff; border:none; cursor:pointer; }

.row { display:flex; align-items:center; gap:8px; margin-bottom:12px; background:#fff; padding:16px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex-wrap:nowrap; }
.label { flex:0 0 60px; font-weight:bold; font-size:1.4rem; cursor:pointer; }
.btn { flex:1 1 0; min-width:0; padding:16px 12px; border-radius:8px; cursor:pointer; border:none; font-size:1.4rem; font-weight:bold; background:#e0e0e0; color:#333; transition:background .2s,color .2s,box-shadow .2s; }
.btn.selected { background:#4CAF50; color:#fff; box-shadow:inset 0 0 0 2px #2e7d32; }
.result { margin-left:auto; flex:0 0 auto; min-width:110px; text-align:right; font-size:1.4rem; font-weight:bold; color:#333; }

#loadingMsg { display:none; margin:10px 0; font-size:1.2rem; color:#555; font-weight:bold; }
#duplicateMsg { display:none; background:#ffcccc; color:#900; padding:14px; margin-top:8px; border:1px solid #900; border-radius:6px; font-weight:bold; font-size:1.2rem; }
#duplicateMsg button { margin-left:14px; background:#900; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:1rem; }

#rounds { display:none; } /* 기본 숨김 */

@media (max-width:768px){
  .row{ gap:6px; padding:14px; }
  .label{ flex-basis:56px; font-size:1.6rem; }
  .btn{ font-size:1.6rem; padding:16px 8px; }
  .result{ font-size:1.6rem; min-width:100px; }
}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">생면공정 점검 입력1</div>

  <div class="app-body">
    <label for="date">날짜</label>
    <input type="date" id="date" required style="font-size:1.4rem; padding:10px; width:100%; margin-bottom:10px;" />
    <div id="loadingMsg">⏳ 중복 확인 중...</div>
    <div id="duplicateMsg">
      <span id="duplicateText"></span>
      <button id="duplicateConfirmBtn">확인</button>
      <button id="duplicateCancelBtn">취소</button>
    </div>
   
    <div id="rounds"></div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">📥 저장하기</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById("date");
  const submitBtn = document.getElementById("submitBtn");
  const roundsDiv = document.getElementById("rounds");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
  const duplicateCancelBtn = document.getElementById("duplicateCancelBtn");
  const loadingMsg = document.getElementById("loadingMsg");

  const scriptUrl = "https://script.google.com/macros/s/AKfycbw9cz3HUH_MVKRyzf2Zpzkmg9FK4OuxU803d2aWBdCY8Hqh8p9x1nR4WRJlZEIvrl5ygw/exec"; // Apps Script URL

  dateInput.valueAsDate = new Date();
  let roundData = {};

  // UI 생성
  for (let i = 1; i <= 10; i++) {
    const row = document.createElement("div");
    row.className = "row";
    row.setAttribute('data-round', i);
    row.innerHTML = `
      <div class="label">${i}차</div>
      <button class="btn" type="button" onclick="selectOption(${i}, '3포')">3포</button>
      <button class="btn" type="button" onclick="selectOption(${i}, '2포')">2포</button>
      <div id="result${i}" class="result"></div>
    `;
    row.querySelector(".label").addEventListener("click", () => {
      delete roundData[i];
      row.querySelectorAll(".btn").forEach(btn => {
        btn.classList.remove("selected");
        btn.setAttribute("aria-pressed","false");
      });
      document.getElementById("result"+i).textContent = "";
    });
    roundsDiv.appendChild(row);
  }

  window.selectOption = function(round, type) {
    const rowEl = roundsDiv.children[round - 1];
    const btns = rowEl.querySelectorAll('.btn');
    let no = (type==="3포")?60:40;
    let value = (type==="3포")?1:0.7;
    roundData[round] = { no, value };
    document.getElementById("result"+round).textContent = `주정 ${value} kg`;
    btns.forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
    if(type==="3포"){ btns[0].classList.add('selected'); btns[0].setAttribute('aria-pressed','true'); }
    else{ btns[1].classList.add('selected'); btns[1].setAttribute('aria-pressed','true'); }
  }

  async function checkDuplicate(date) {
    loadingMsg.style.display = "block";
    duplicateMsg.style.display = "none";
    roundsDiv.style.display = "none";
    submitBtn.disabled = true;

    try {
      const res = await fetch(`${scriptUrl}?checkSaengmyeon=${encodeURIComponent(JSON.stringify({ date }))}`);
      const data = await res.json();
      loadingMsg.style.display = "none";

      if(data && data.exists) {
        duplicateText.textContent = `⚠️ ${date} 에 이미 입력된 데이터가 있습니다.`;
        duplicateMsg.style.display = "block";
        roundsDiv.style.display = "none";
    
      } else {
        roundsDiv.style.display = "block";
 
        submitBtn.disabled = false;
      }
    } catch(err) {
      loadingMsg.style.display = "none";
      console.error("중복 확인 실패:", err);
      alert("중복 확인 중 오류가 발생했습니다.");
    }
  }

  dateInput.addEventListener("change", () => {
    if(dateInput.value) checkDuplicate(dateInput.value);
  });

  duplicateConfirmBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    roundsDiv.style.display = "block";

    submitBtn.disabled = false;
  });

  duplicateCancelBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    roundsDiv.style.display = "none";
 
    dateInput.valueAsDate = new Date();
  });

  submitBtn.addEventListener("click", async () => {
    if(!dateInput.value){ alert("날짜를 선택하세요."); return; }
    if(!roundData[1]){ alert("⚠️ 1차 입력은 반드시 필요합니다."); return; }
    for(let i=1;i<=10;i++){ if(!roundData[i] && roundData[i+1]){ alert(`${i}차가 비어있습니다.`); return; } }

    const noArr=[], valueArr=[];
    for(let i=1;i<=10;i++){ if(roundData[i]){ noArr.push(roundData[i].no); valueArr.push(roundData[i].value); } else{ noArr.push(""); valueArr.push(""); } }
    const payload = { date: dateInput.value, no:noArr, value:valueArr };

    try{
      const res = await fetch(scriptUrl,{ method:"POST", body:new URLSearchParams({ saengmyeon: JSON.stringify(payload) }) });
      const text = await res.text();
      alert("저장 완료: "+text);
      roundData = {};
      document.querySelectorAll(".result").forEach(el => el.textContent="");
      document.querySelectorAll(".btn").forEach(btn =>{ btn.classList.remove("selected"); btn.setAttribute("aria-pressed","false"); });
      dateInput.valueAsDate = new Date();
      checkDuplicate(dateInput.value);
    }catch(err){ alert("에러 발생: "+err.message); }
  });

  if(dateInput.value) checkDuplicate(dateInput.value);
});
</script>
</body>
</html>
