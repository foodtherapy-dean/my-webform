<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>정기검증 취합 (일별/월별 모드)</title>
<style>
body { font-family: Arial, sans-serif; margin:16px; }
h2 { text-align:center; margin-bottom:8px; }
.controls { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; }
button { padding:6px 10px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
button.active { background:#4caf50; color:#fff; border-color:#4caf50; }
.mode-toggle { display:flex; gap:8px; }
table { width:100%; border-collapse: collapse; margin-top:12px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#f5f5f5; }
td.clickable { cursor: pointer; text-decoration: underline; font-size: 20px; font-weight: bold; }
td.sunday { background:#ffecec; }
td.saturday { background:#e9f2ff; }
.small { font-size:12px; color:#666; }
.header-row { background:#fafafa; }
#note { text-align:center; margin-top:8px; color:#444; }
@media (max-width:800px){ .controls{flex-direction:column;} table{font-size:12px} td.clickable{font-size:16px} }
</style>
</head>
<body>

<h2>정기검증 취합</h2>

<div class="controls">
  <div style="display:flex; align-items:center; gap:8px;">
    <button id="prevMonth">&lt;</button>
    <input type="month" id="monthInput" />
    <button id="nextMonth">&gt;</button>
  </div>
  <div class="mode-toggle">
    <button id="dayModeBtn" class="active">일별</button>
    <button id="monthModeBtn">월별</button>
  </div>
</div>

<table id="statusTable">
  <thead id="tableHead">
    <!-- will be generated -->
  </thead>
  <tbody></tbody>
</table>

<div id="note" class="small">테이블의 ● = 완료, ○ = 미완료. 셀 클릭 시 입력폼이 새창으로 열립니다.</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbzuYooEWm1diXUWGZxls_dedq4_ybhoVHzBTTdb37mSSSArrYqIDbgh3o-jBfz27spusQ/exec";

// Day-mode CELL_MAP (주간/월간)
const CELL_MAP_DAY = [
  { period: "주간", item: "방재점검" },
  { period: "주간", item: "기타청소" },
  { period: "월간", item: "CCP검증" },
  { period: "월간", item: "위생교육" }
];

// Month-mode items (분기1, 반기2, 연간3)
const CELL_MAP_MONTH = [
  { period: "분기", item: "품질검사" },
  { period: "반기", item: "탱크청소" },
  { period: "반기", item: "에어필터" },
  { period: "연간", item: "지하수검사" },
  { period: "연간", item: "검교정" },
  { period: "연간", item: "유효성평가" }
];

const WEEKDAYS = ["일","월","화","수","목","금","토"]; 
const tbody = document.querySelector("#statusTable tbody");
const tableHead = document.querySelector("#tableHead");
const monthInput = document.getElementById("monthInput");
const prevBtn = document.getElementById("prevMonth");
const nextBtn = document.getElementById("nextMonth");
const dayModeBtn = document.getElementById("dayModeBtn");
const monthModeBtn = document.getElementById("monthModeBtn");

let currentYear, currentMonth;
let mode = 'day';
let lastLoadedData = null;

// 상태 아이콘 변환
function convertStatus(status) {
  if (!status) return "";
  if (status === "완료") return "●";
  if (status === "미완료") return "○";
  return "";
}

// 날짜 yyyy-mm-dd
function formatDateLocal(d){
  const year = d.getFullYear();
  const month = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${year}-${month}-${day}`;
}

// 월 전체 날짜 배열
function getMonthDates(year, month){
  const dates = [];
  const firstDay = new Date(year, month-1, 1);
  const lastDay = new Date(year, month, 0);
  for(let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate()+1)){
    dates.push(new Date(d.getTime()));
  }
  return dates;
}

// 데이터 불러오기
async function loadData(year, month){
  tbody.innerHTML = `<tr><td colspan="8">불러오는 중...</td></tr>`;
  try{
    const url = `${BASE_URL}?mode=data&year=${year}&month=${month}`;
    const resp = await fetch(url);
    const json = await resp.json();
    if (!json.success) throw new Error(json.error || '데이터 로드 실패');
    lastLoadedData = json.data;

    if(mode === 'day') renderDayTable(json.data, year, month);
    else renderMonthTable(json.data, year, month);

  }catch(err){
    tbody.innerHTML = `<tr><td colspan="8">오류: ${err.message}</td></tr>`;
    console.error(err);
  }
}

//
// ------------------- DAY MODE -------------------
function buildDayHead(){
  tableHead.innerHTML = '';
  const tr1 = document.createElement('tr');
  tr1.innerHTML = `<th rowspan="2">날짜</th><th rowspan="2">요일</th><th colspan="2">주간</th><th colspan="2">월간</th>`;
  
  const tr2 = document.createElement('tr');
  tr2.innerHTML = `<th>방재점검</th><th>기타청소</th><th>CCP검증</th><th>위생교육</th>`;
  
  tableHead.appendChild(tr1);
  tableHead.appendChild(tr2);
}

function renderDayTable(data, year, month){
  buildDayHead();
  tbody.innerHTML = '';

  const monthDates = getMonthDates(year, month);

  monthDates.forEach(d => {
    const dateStr = formatDateLocal(d);
    const day = d.getDate();
    const wday = WEEKDAYS[d.getDay()];
    const tr = document.createElement('tr');
    if (wday === '일') tr.classList.add('sunday');
    if (wday === '토') tr.classList.add('saturday');

    tr.innerHTML = `<td>${day}</td><td>${wday}</td>`;

    CELL_MAP_DAY.forEach(cell => {
      const td = document.createElement('td');
      td.classList.add('clickable');

      const record = data.find(r => r.date === dateStr &&
        r.statusArray &&
        r.statusArray.some(s => s.period === cell.period && s.item === cell.item)
      );

      if(record){
        const matched = record.statusArray.find(s => s.period === cell.period && s.item === cell.item);
        td.textContent = convertStatus(matched.status);
      }

      td.onclick = ()=> openForm(dateStr, cell.period, cell.item);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

//
// ------------------- MONTH MODE -------------------
function buildMonthHead(){
  tableHead.innerHTML = '';
  const tr1 = document.createElement('tr');
  tr1.innerHTML = `<th rowspan="2">월</th><th colspan="1">분기</th><th colspan="2">반기</th><th colspan="3">연간</th>`;
  
  const tr2 = document.createElement('tr');
  tr2.innerHTML = `<th>품질검사</th><th>탱크청소</th><th>에어필터</th><th>지하수검사</th><th>검교정</th><th>유효성평가</th>`;
  
  tableHead.appendChild(tr1);
  tableHead.appendChild(tr2);
}

// ★ 월별 모드 클릭 시 실제 날짜 불러오기 ★
function renderMonthTable(data, year, month){
  buildMonthHead();
  tbody.innerHTML = ''; // 테이블 초기화

  for(let m=1; m<=12; m++){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m}월</td>`;
    const ym = `${year}-${String(m).padStart(2,'0')}`;

    CELL_MAP_MONTH.forEach(cell=>{
      const td = document.createElement('td');
      td.classList.add('clickable');

      // ★ 반드시 현재 월 데이터만 필터링
      const monthData = data.filter(r=>{
        if(!r.date) return false;
        const [ry, rm] = r.date.split('-').map(Number);
        return ry === year && rm === m;
      });

      const matchedData = monthData.filter(r=>r.statusArray?.some(s=>s.period===cell.period && s.item===cell.item));

      if(matchedData.length > 0){
        const hasComplete = matchedData.some(r=>{
          const s = r.statusArray.find(s=>s.period===cell.period && s.item===cell.item);
          return s?.status === '완료';
        });
        td.textContent = hasComplete ? '●' : '○';
      } else {
        td.textContent = '';
      }

      td.onclick = ()=>{
        if(matchedData.length > 0){
          const completeData = matchedData.filter(r=>{
            const s = r.statusArray.find(s=>s.period===cell.period && s.item===cell.item);
            return s?.status === '완료';
          });
          const firstDate = completeData.length > 0 ? completeData[0].date : matchedData[0].date;
          openForm(firstDate, cell.period, cell.item);
        } else {
          openForm(`${ym}-01`, cell.period, cell.item);
        }
      };

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  }
}

//
// ------------------- FORM OPEN -------------------
function openForm(dateStr, period, item){
  const url = `https://foodtherapy-dean.github.io/my-webform/check/form_check.html?date=${dateStr}&period=${encodeURIComponent(period)}&item=${encodeURIComponent(item)}`;
  window.open(url, '_blank');
}

//
// ------------------- MONTH MOVE -------------------
function changeMonth(delta){
  let newMonth = currentMonth + delta;
  let newYear = currentYear;

  if(newMonth < 1){ newMonth = 12; newYear -= 1; }
  if(newMonth > 12){ newMonth = 1; newYear += 1; }

  currentYear = newYear;
  currentMonth = newMonth;
  monthInput.value = `${currentYear}-${String(currentMonth).padStart(2,'0')}`;

  // 월 변경 시 자동으로 일별 모드 활성화
  setMode('day');
}

//
// ------------------- MODE SWITCH -------------------
function setMode(newMode){
  mode = newMode;
  if(mode === 'day'){
    dayModeBtn.classList.add('active');
    monthModeBtn.classList.remove('active');
  } else {
    monthModeBtn.classList.add('active');
    dayModeBtn.classList.remove('active');
  }
  loadData(currentYear, currentMonth);
}

//
// ------------------- INIT -------------------
function init(){
  const today = new Date();
  currentYear = today.getFullYear();
  currentMonth = today.getMonth()+1;

  monthInput.value = `${currentYear}-${String(currentMonth).padStart(2,'0')}`;

  prevBtn.addEventListener('click', ()=> changeMonth(-1));
  nextBtn.addEventListener('click', ()=> changeMonth(1));

  monthInput.addEventListener('change', ()=>{
    const [y,m] = monthInput.value.split('-').map(Number);
    currentYear = y;
    currentMonth = m;
    loadData(currentYear, currentMonth);
  });

  dayModeBtn.addEventListener('click', ()=> setMode('day'));
  monthModeBtn.addEventListener('click', ()=> setMode('month'));

  loadData(currentYear, currentMonth);
}

window.onload = init;
</script>


</body>
</html>
