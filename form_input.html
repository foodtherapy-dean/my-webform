<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì…ë ¥ ë° ì¤‘ë³µí™•ì¸</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#loading { display:none; color:gray; }
#alertBox { display:none; margin-top:10px; padding:10px; border:1px solid #aaa; background:#f7f7f7; }
#formSection { display:none; margin-top:20px; }
.ox-row { margin:5px 0; }
button.ox { width:40px; margin-right:10px; }
button.selected { background:#4CAF50; color:white; }
</style>
</head>
<body>
  <h2>ğŸ“‹ ì›ìì¬ ì…ê³  í™•ì¸</h2>

  <label>ë‚ ì§œ:</label>
  <input type="date" id="dateInput"><br>
  <div id="loading">â³ ì¤‘ë³µ í™•ì¸ ì¤‘...</div>
  <div id="alertBox"></div>

  <div id="formSection">
    <label>í’ˆëª©ëª…:</label>
    <select id="productSelect">
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <option>ë°€ê°€ë£¨</option>
      <option>ì†Œê¸ˆ</option>
      <option>ì¹˜ìê°€ë£¨</option>
      <option>ë©”ë°€ê°€ë£¨</option>
    </select>
    <input type="number" id="countInput" placeholder="ìˆ˜ëŸ‰" disabled><br><br>

    <div id="oxContainer"></div>

    <button id="saveBtn">ì €ì¥</button>
  </div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbxS1N6NiqQWmwdDgJzq_cUGhx3uFbIpYgiv7s0j8rMFKefwhcnL3rTfit5Cw5BbzKlY7w/exec";

document.addEventListener("DOMContentLoaded", () => {
  const dateInput = document.getElementById("dateInput");
  const today = new Date().toISOString().split("T")[0];
  dateInput.value = today;
  checkDuplicate(today);

  dateInput.addEventListener("change", () => checkDuplicate(dateInput.value));

  document.getElementById("productSelect").addEventListener("change", (e) => {
    const enabled = e.target.value !== "";
    document.getElementById("countInput").disabled = !enabled;
    if (enabled) renderOxButtons();
  });

  document.getElementById("saveBtn").addEventListener("click", saveData);
});

function checkDuplicate(date) {
  document.getElementById("loading").style.display = "block";
  document.getElementById("alertBox").style.display = "none";
  document.getElementById("formSection").style.display = "none";

  fetch(`${BASE_URL}?checkInput=${JSON.stringify({ date })}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("loading").style.display = "none";
      if (data.exists) {
        document.getElementById("alertBox").innerHTML =
          `âš ï¸ ${date} ë°ì´í„°ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.<br>
           <button onclick="useExisting()">í™•ì¸</button>`;
        document.getElementById("alertBox").style.display = "block";
        window.existingData = data;
      } else {
        document.getElementById("formSection").style.display = "block";
      }
    });
}

function useExisting() {
  const d = window.existingData;
  document.getElementById("alertBox").style.display = "none";
  document.getElementById("formSection").style.display = "block";
  document.getElementById("productSelect").value = d.product;
  document.getElementById("countInput").value = d.count;
  document.getElementById("countInput").disabled = false;
  renderOxButtons(d.oxStates);
}

function renderOxButtons(existingStates = []) {
  const labels = ["ì°¨ëŸ‰ìƒíƒœ", "íŒŒë ˆíŠ¸ìƒíƒœ", "ì™¸í¬ì¥ì„±ìƒ", "í‘œì‹œê¸°ì¤€", "ì„±ì ì„œêµ¬ë¹„"];
  const container = document.getElementById("oxContainer");
  container.innerHTML = "";
  window.oxStates = existingStates.length ? existingStates : ["", "", "", "", ""];

  labels.forEach((label, i) => {
    const row = document.createElement("div");
    row.className = "ox-row";
    const span = document.createElement("span");
    span.textContent = label + ": ";
    const oBtn = document.createElement("button");
    const xBtn = document.createElement("button");
    oBtn.textContent = "O"; xBtn.textContent = "X";
    oBtn.className = xBtn.className = "ox";

    oBtn.onclick = () => setOx(i, "O", oBtn, xBtn);
    xBtn.onclick = () => setOx(i, "X", oBtn, xBtn);

    // ê¸°ì¡´ ë°ì´í„° ë°˜ì˜
    if (existingStates[i] === "O") oBtn.classList.add("selected");
    if (existingStates[i] === "X") xBtn.classList.add("selected");

    row.append(span, oBtn, xBtn);
    container.append(row);
  });
}

function setOx(i, val, oBtn, xBtn) {
  window.oxStates[i] = val;
  oBtn.classList.toggle("selected", val === "O");
  xBtn.classList.toggle("selected", val === "X");
}

function saveData() {
  const payload = {
    input: {
      date: document.getElementById("dateInput").value,
      product: document.getElementById("productSelect").value,
      count: document.getElementById("countInput").value,
      oxStates: window.oxStates || ["", "", "", "", ""]
    }
  };

  if (!payload.input.product) return alert("í’ˆëª©ëª…ì„ ì„ íƒí•˜ì„¸ìš”.");
  if (!payload.input.count) return alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.");

  fetch(BASE_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(msg => alert(msg));
}
</script>
</body>
</html>
