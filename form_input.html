<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>입력 및 중복확인</title>
<style>
body { font-family: sans-serif; margin: 20px; }
#loading { display:none; color:gray; }
#alertBox { display:none; margin-top:10px; padding:10px; border:1px solid #aaa; background:#f7f7f7; }
#formSection { display:none; margin-top:20px; }
.ox-row { margin:5px 0; }
button.ox { width:40px; margin-right:10px; }
button.selected { background:#4CAF50; color:white; }
</style>
</head>
<body>
  <h2>📋 원자재 입고 확인</h2>

  <label>날짜:</label>
  <input type="date" id="dateInput"><br>
  <div id="loading">⏳ 중복 확인 중...</div>
  <div id="alertBox"></div>

  <div id="formSection">
    <label>품목명:</label>
    <select id="productSelect">
      <option value="">선택하세요</option>
      <option>밀가루</option>
      <option>소금</option>
      <option>치자가루</option>
      <option>메밀가루</option>
    </select>
    <input type="number" id="countInput" placeholder="수량" disabled><br><br>

    <div id="oxContainer"></div>

    <button id="saveBtn">저장</button>
  </div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbxS1N6NiqQWmwdDgJzq_cUGhx3uFbIpYgiv7s0j8rMFKefwhcnL3rTfit5Cw5BbzKlY7w/exec";

document.addEventListener("DOMContentLoaded", () => {
  const dateInput = document.getElementById("dateInput");
  const today = new Date().toISOString().split("T")[0];
  dateInput.value = today;
  checkDuplicate(today);

  dateInput.addEventListener("change", () => checkDuplicate(dateInput.value));

  document.getElementById("productSelect").addEventListener("change", (e) => {
    const enabled = e.target.value !== "";
    document.getElementById("countInput").disabled = !enabled;
    if (enabled) renderOxButtons();
  });

  document.getElementById("saveBtn").addEventListener("click", saveData);
});

function checkDuplicate(date) {
  document.getElementById("loading").style.display = "block";
  document.getElementById("alertBox").style.display = "none";
  document.getElementById("formSection").style.display = "none";

  fetch(`${BASE_URL}?checkInput=${JSON.stringify({ date })}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("loading").style.display = "none";
      if (data.exists) {
        document.getElementById("alertBox").innerHTML =
          `⚠️ ${date} 데이터가 이미 존재합니다.<br>
           <button onclick="useExisting()">확인</button>`;
        document.getElementById("alertBox").style.display = "block";
        window.existingData = data;
      } else {
        document.getElementById("formSection").style.display = "block";
      }
    });
}

function useExisting() {
  const d = window.existingData;
  document.getElementById("alertBox").style.display = "none";
  document.getElementById("formSection").style.display = "block";
  document.getElementById("productSelect").value = d.product;
  document.getElementById("countInput").value = d.count;
  document.getElementById("countInput").disabled = false;
  renderOxButtons(d.oxStates);
}

function renderOxButtons(existingStates = []) {
  const labels = ["차량상태", "파레트상태", "외포장성상", "표시기준", "성적서구비"];
  const container = document.getElementById("oxContainer");
  container.innerHTML = "";
  window.oxStates = existingStates.length ? existingStates : ["", "", "", "", ""];

  labels.forEach((label, i) => {
    const row = document.createElement("div");
    row.className = "ox-row";
    const span = document.createElement("span");
    span.textContent = label + ": ";
    const oBtn = document.createElement("button");
    const xBtn = document.createElement("button");
    oBtn.textContent = "O"; xBtn.textContent = "X";
    oBtn.className = xBtn.className = "ox";

    oBtn.onclick = () => setOx(i, "O", oBtn, xBtn);
    xBtn.onclick = () => setOx(i, "X", oBtn, xBtn);

    // 기존 데이터 반영
    if (existingStates[i] === "O") oBtn.classList.add("selected");
    if (existingStates[i] === "X") xBtn.classList.add("selected");

    row.append(span, oBtn, xBtn);
    container.append(row);
  });
}

function setOx(i, val, oBtn, xBtn) {
  window.oxStates[i] = val;
  oBtn.classList.toggle("selected", val === "O");
  xBtn.classList.toggle("selected", val === "X");
}

function saveData() {
  const payload = {
    input: {
      date: document.getElementById("dateInput").value,
      product: document.getElementById("productSelect").value,
      count: document.getElementById("countInput").value,
      oxStates: window.oxStates || ["", "", "", "", ""]
    }
  };

  if (!payload.input.product) return alert("품목명을 선택하세요.");
  if (!payload.input.count) return alert("수량을 입력하세요.");

  fetch(BASE_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(msg => alert(msg));
}
</script>
</body>
</html>
