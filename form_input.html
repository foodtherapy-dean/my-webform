<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Input 시트 데이터 입력</title>
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
.app-container { display:flex; flex-direction:column; height:100%; }
.app-header { background:#3f51b5; color:#fff; text-align:center; padding:16px; font-size:1.6rem; }
.app-body { flex:1 1 auto; overflow-y:auto; padding:20px; background:#f9f9f9; }
.app-footer { flex:0 0 auto; padding:10px; }
input, select { width:100%; padding:10px; font-size:1.1rem; border:1px solid #ccc; border-radius:6px; margin-bottom:10px; }
button { font-size:1.2rem; padding:10px 0; border:none; border-radius:6px; cursor:pointer; }
#submitBtn { background:#3f51b5; color:#fff; width:100%; }
#duplicateMsg { display:none; background:#ffdddd; color:#900; padding:10px; border-radius:6px; margin-bottom:10px; text-align:center; }
.inline-row { display:flex; gap:10px; margin-bottom:10px; }
.selection-buttons button { width:100%; margin-bottom:6px; }
.selection-buttons button.active { background:#4caf50; color:#fff; }
.hidden { display:none; }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">📋 Input 데이터 입력</div>

  <div class="app-body">
    <label for="date">날짜</label>
    <input type="date" id="date">

    <div id="duplicateMsg">
      ⚠️ 중복된 날짜 데이터가 존재합니다.
      <button id="loadDuplicateBtn">중복 데이터 확인</button>
    </div>

    <label for="product">품목명</label>
    <select id="product" disabled>
      <option value="">선택하세요</option>
      <option value="밀가루">밀가루</option>
      <option value="소금">소금</option>
      <option value="치자가루">치자가루</option>
      <option value="메밀가루">메밀가루</option>
    </select>

    <div class="inline-row hidden" id="countRow">
      <label for="count">수량</label>
      <input type="number" id="count" min="0">
    </div>

    <div class="selection-buttons hidden" id="selectionBtns">
      <button id="btn1">차량상태</button>
      <button id="btn2">파레트상태</button>
      <button id="btn3">외포장상태</button>
      <button id="btn4">표시가준</button>
      <button id="btn5">성적서구비</button>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn" disabled>💾 저장하기</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const scriptUrl = "https://script.google.com/macros/s/AKfycbzeg9VImWLnm250LnI-OkjhjLuyQeRf6yQPLk_x8UPAG2wNIcn53sKs_0tdvSoRa4EJLw/exec";

  const dateInput = document.getElementById("date");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const loadDuplicateBtn = document.getElementById("loadDuplicateBtn");

  const productSelect = document.getElementById("product");
  const countInput = document.getElementById("count");
  const countRow = document.getElementById("countRow");
  const selectionBtnsDiv = document.getElementById("selectionBtns");
  const submitBtn = document.getElementById("submitBtn");

  const buttons = [
    document.getElementById("btn1"),
    document.getElementById("btn2"),
    document.getElementById("btn3"),
    document.getElementById("btn4"),
    document.getElementById("btn5")
  ];

  const buttonState = { btn1:0, btn2:0, btn3:0, btn4:0, btn5:0 };

  // 1️⃣ 오늘 날짜 자동 입력
  dateInput.valueAsDate = new Date();

  // 2️⃣ 날짜 변경 시 중복 체크
  async function checkDuplicateDate(dateVal) {
    duplicateMsg.style.display = "none";
    disableAllInputs(true);

    try {
      const query = encodeURIComponent(JSON.stringify({ date: dateVal }));
      const res = await fetch(`${scriptUrl}?getInput=${query}`);
      const data = res.ok ? await res.json() : {};
      if (data.exists) {
        duplicateMsg.style.display = "block";
      } else {
        productSelect.disabled = false;
      }
    } catch(err) { console.error(err); }
  }

  dateInput.addEventListener("change", () => {
    if (dateInput.value) checkDuplicateDate(dateInput.value);
    resetForm();
  });

  // 3️⃣ 중복 확인 버튼 클릭
  loadDuplicateBtn.addEventListener("click", async () => {
    const dateVal = dateInput.value;
    if (!dateVal) return;

    try {
      const query = encodeURIComponent(JSON.stringify({ date: dateVal }));
      const res = await fetch(`${scriptUrl}?checkInput=${query}`);
      const data = await res.json();

      enableProductSelection();

      if (data.exists) {
        const d = data.data;
        productSelect.value = d.product || "";
        countInput.value = d.count || 0;

        buttons.forEach((btn, idx) => {
          const key = "btn"+(idx+1);
          buttonState[key] = d[key] || 0;
          updateButtonVisual(btn, buttonState[key]);
        });
        countRow.classList.remove("hidden");
        selectionBtnsDiv.classList.remove("hidden");
      }
    } catch(err) { console.error(err); }
  });

  // 4️⃣ 품목 선택 시 수량/선택버튼 활성화
  productSelect.addEventListener("change", () => {
    const active = !!productSelect.value;
    countRow.classList.toggle("hidden", !active);
    selectionBtnsDiv.classList.toggle("hidden", !active);
    submitBtn.disabled = !active;
    if (!active) resetSelectionButtons();
  });

  // 5️⃣ 버튼 클릭 O/X 토글
  buttons.forEach((btn, idx) => {
    btn.addEventListener("click", () => {
      const key = "btn"+(idx+1);
      buttonState[key] = buttonState[key] ? 0 : 1;
      updateButtonVisual(btn, buttonState[key]);
    });
  });

  function updateButtonVisual(btn, state) {
    if (state) btn.classList.add("active");
    else btn.classList.remove("active");
  }

  function disableAllInputs(flag) {
    productSelect.disabled = flag;
    countInput.disabled = flag;
    buttons.forEach(b => b.disabled = flag);
    submitBtn.disabled = flag;
  }

  function enableProductSelection() {
    productSelect.disabled = false;
  }

  function resetForm() {
    productSelect.value = "";
    countInput.value = "";
    countRow.classList.add("hidden");
    selectionBtnsDiv.classList.add("hidden");
    submitBtn.disabled = true;
    resetSelectionButtons();
  }

  function resetSelectionButtons() {
    Object.keys(buttonState).forEach(k => buttonState[k] = 0);
    buttons.forEach(btn => btn.classList.remove("active"));
  }

  // 6️⃣ 저장
  submitBtn.addEventListener("click", async () => {
    if (!dateInput.value || !productSelect.value) return alert("날짜와 품목을 선택해주세요.");

    const payload = {
      date: dateInput.value,
      product: productSelect.value,
      count: countInput.value || 0,
      ...buttonState
    };

    try {
      const res = await fetch(scriptUrl, {
        method: "POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded" },
        body: "input=" + encodeURIComponent(JSON.stringify(payload))
      });
      const text = await res.text();
      alert("서버 응답: " + text);
      resetForm();
    } catch(err) { alert("서버 오류: " + err.message); }
  });

  // 초기 중복 체크
  if (dateInput.value) checkDuplicateDate(dateInput.value);
});
</script>
</body>
</html>
