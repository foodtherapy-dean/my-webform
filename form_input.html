<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>입력 점검표</title>
  <style>
    body {
      font-family: "Noto Sans KR", sans-serif;
      margin: 0; padding: 0;
      background: #f9f9f9;
    }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      background: #2196F3; color: #fff;
      text-align: center; padding: 12px; font-size: 18px;
      font-weight: bold;
    }
    main {
      padding: 80px 20px 100px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    select, input[type="date"], button {
      width: 100%; padding: 10px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 8px;
      font-size: 16px;
    }
    .ox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      text-align: center;
      margin-top: 5px;
    }
    .ox-btn {
      font-size: 18px;
      padding: 10px 0;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #fff;
    }
    .ox-btn.selected.O { background: #4CAF50; color: #fff; border: none; }
    .ox-btn.selected.X { background: #F44336; color: #fff; border: none; }

    footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #fff; border-top: 1px solid #ddd;
      padding: 10px 20px;
    }
    footer button {
      width: 100%;
      background: #2196F3;
      color: #fff;
      font-size: 18px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>입력 점검표</header>

  <main>
    <label>날짜</label>
    <input type="date" id="date" />

    <label>제품명</label>
    <select id="product">
      <option value="">선택하세요</option>
    </select>

    <label>차량상태</label>
    <div class="ox-group" data-key="A">
      <button class="ox-btn O">O</button>
      <button class="ox-btn X">X</button>
    </div>

    <label>파레트상태</label>
    <div class="ox-group" data-key="B">
      <button class="ox-btn O">O</button>
      <button class="ox-btn X">X</button>
    </div>

    <label>작업자위생</label>
    <div class="ox-group" data-key="C">
      <button class="ox-btn O">O</button>
      <button class="ox-btn X">X</button>
    </div>

    <label>설비상태</label>
    <div class="ox-group" data-key="D">
      <button class="ox-btn O">O</button>
      <button class="ox-btn X">X</button>
    </div>

    <label>위생상태</label>
    <div class="ox-group" data-key="E">
      <button class="ox-btn O">O</button>
      <button class="ox-btn X">X</button>
    </div>
  </main>

  <footer>
    <button id="saveBtn">저장하기</button>
  </footer>

  <script>
    const BASE_URL = "https://script.google.com/macros/s/AKfycbzBHdxfW-mPr3Qk1cPeoT95kmD6DmIIWdQHiKnjU3o2sRVQns0nXSBuZqEqqAyPiCGM3g/exec"; // ← Apps Script 배포 URL 입력

    document.addEventListener("DOMContentLoaded", () => {
      const dateInput = document.getElementById("date");
      const productSelect = document.getElementById("product");

      // 오늘 날짜 자동 지정
      const today = new Date().toISOString().split("T")[0];
      dateInput.value = today;

      // 날짜 변경 시 제품 목록 불러오기
      dateInput.addEventListener("change", loadProducts);
      // 제품 변경 시 기존 데이터 조회
      productSelect.addEventListener("change", loadExistingData);

      // OX 버튼 선택 토글
      document.querySelectorAll(".ox-group").forEach(group => {
        group.querySelectorAll(".ox-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            group.querySelectorAll(".ox-btn").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected", btn.textContent);
          });
        });
      });

      // 저장 버튼 클릭
      document.getElementById("saveBtn").addEventListener("click", saveData);
    });

    // === 날짜별 제품 목록 불러오기 ===
    async function loadProducts() {
      const date = document.getElementById("date").value;
      const select = document.getElementById("product");
      select.innerHTML = `<option value="">로딩중...</option>`;

      const params = new URLSearchParams({
        getInput: JSON.stringify({ date })
      });
      const res = await fetch(`${BASE_URL}?${params}`);
      const data = await res.json();

      select.innerHTML = `<option value="">선택하세요</option>`;
      data.products.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        select.appendChild(opt);
      });
    }

    // === 날짜+제품 조합 기존 데이터 불러오기 ===
    async function loadExistingData() {
      const date = document.getElementById("date").value;
      const product = document.getElementById("product").value;
      if (!date || !product) return;

      const params = new URLSearchParams({
        checkInput: JSON.stringify({ date, product })
      });
      const res = await fetch(`${BASE_URL}?${params}`);
      const data = await res.json();

      // 기존 선택 초기화
      document.querySelectorAll(".ox-group .ox-btn").forEach(b => b.classList.remove("selected"));

      if (data.found) {
        for (let key of ["A", "B", "C", "D", "E"]) {
          const value = data[key];
          if (value === "O" || value === "X") {
            const btn = document.querySelector(`.ox-group[data-key="${key}"] .${value}`);
            if (btn) btn.classList.add("selected", value);
          }
        }
      }
    }

    // === 저장 ===
    async function saveData() {
      const date = document.getElementById("date").value;
      const product = document.getElementById("product").value;
      if (!date || !product) return alert("날짜와 제품명을 선택하세요.");

      const data = {
        date,
        product,
        count: 0,
      };
      document.querySelectorAll(".ox-group").forEach(g => {
        const key = g.dataset.key;
        const selected = g.querySelector(".ox-btn.selected");
        data[key] = selected ? selected.textContent : "X"; // 미선택은 X
      });

      const params = new URLSearchParams({
        input: JSON.stringify(data)
      });

      const res = await fetch(BASE_URL, {
        method: "POST",
        body: params
      });

      const text = await res.text();
      alert(text.includes("✅") ? text : "저장 오류");
    }
  </script>
</body>
</html>
