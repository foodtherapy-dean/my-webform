<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Input ë°ì´í„° ì…ë ¥</title>
<style>
body, html { margin:0; padding:0; font-family:sans-serif; height:100%; }
.app-container { display:flex; flex-direction:column; height:100%; }
.app-header { background:#3f51b5; color:#fff; text-align:center; padding:16px; font-size:1.6rem; }
.app-body { flex:1 1 auto; overflow-y:auto; padding:20px; background:#f9f9f9; }
.app-footer { flex:0 0 auto; }
button { cursor:pointer; border:none; border-radius:6px; }
button:disabled { opacity:0.5; cursor:not-allowed; }

label { display:block; margin-top:16px; margin-bottom:6px; font-weight:bold; }
input, select { width:100%; padding:12px 14px; font-size:1.1rem; border:1px solid #ccc; border-radius:6px; }

#duplicateMsg { display:none; background:#ffdddd; color:#900; padding:10px; border-radius:6px; margin-top:8px; }
.option-row { display:flex; align-items:center; margin-bottom:12px; }
.option-label { width:120px; font-weight:normal; }
.option-buttons { flex:1; display:flex; justify-content:space-between; }
.option-buttons button { width:48%; padding:10px 0; font-size:1.1rem; border:1px solid #ccc; border-radius:6px; }
.option-buttons button.selected { background:#3f51b5; color:#fff; }
#submitBtn { width:100%; font-size:1.4rem; padding:20px 0; background:#3f51b5; color:#fff; margin-top:20px; border-radius:6px; }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ğŸ“‹ Input ë°ì´í„° ì…ë ¥</div>
  <div class="app-body">
    <label for="date">ë‚ ì§œ</label>
    <input type="date" id="date" />

    <label for="product">ì œí’ˆëª…</label>
    <select id="product">
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ë°€ê°€ë£¨">ë°€ê°€ë£¨</option>
      <option value="ì†Œê¸ˆ">ì†Œê¸ˆ</option>
      <option value="ì¹˜ìê°€ë£¨">ì¹˜ìê°€ë£¨</option>
      <option value="ë©”ë°€ê°€ë£¨">ë©”ë°€ê°€ë£¨</option>
    </select>

    <div id="duplicateMsg">
      ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ì…ë‹ˆë‹¤.
      <button id="confirmBtn">í™•ì¸</button>
    </div>

    <label for="count">ìˆ˜ëŸ‰</label>
    <input type="number" id="count" min="0" disabled />

    <div id="optionsContainer" style="display:none; margin-top:16px;">
      <div class="option-row"><div class="option-label">ì°¨ëŸ‰ìƒíƒœ</div><div class="option-buttons"><button>O</button><button>X</button></div></div>
      <div class="option-row"><div class="option-label">íŒŒë ˆíŠ¸ìƒíƒœ</div><div class="option-buttons"><button>O</button><button>X</button></div></div>
      <div class="option-row"><div class="option-label">ì™¸í¬ì¥ìƒíƒœ</div><div class="option-buttons"><button>O</button><button>X</button></div></div>
      <div class="option-row"><div class="option-label">í‘œì‹œê°€ì¤€</div><div class="option-buttons"><button>O</button><button>X</button></div></div>
      <div class="option-row"><div class="option-label">ì„±ì ì„œêµ¬ë¹„</div><div class="option-buttons"><button>O</button><button>X</button></div></div>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbyo6OcP1J9erEIEb2ZPDBtIZrOm2ti2Geu63vxowWzUBc864vhDxKW-ZxUfIn7zjX-wyQ/exec"; // ì‹¤ì œ Apps Script URLë¡œ ë³€ê²½í•˜ì„¸ìš”

document.addEventListener("DOMContentLoaded", () => {
  const dateInput = document.getElementById("date");
  const productSelect = document.getElementById("product");
  const countInput = document.getElementById("count");
  const optionsContainer = document.getElementById("optionsContainer");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const confirmBtn = document.getElementById("confirmBtn");
  const submitBtn = document.getElementById("submitBtn");

  // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì…ë ¥
  dateInput.valueAsDate = new Date();

  // O/X ë²„íŠ¼ í† ê¸€
  optionsContainer.querySelectorAll(".option-buttons").forEach(group => {
    group.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        group.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
      });
    });
  });

  // ----- ìœ í‹¸ í•¨ìˆ˜: ì´ˆê¸°í™” -----
  function clearAllInputs() {
    // ì œí’ˆì€ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ(ì œí’ˆ ì„ íƒ ì´ë²¤íŠ¸ì—ì„œ í˜¸ì¶œ ì‹œ ì œí’ˆê°’ì€ ìœ ì§€)
    // ìˆ˜ëŸ‰ ì´ˆê¸°í™” + ë¹„í™œì„±í™”
    countInput.value = "";
    countInput.disabled = true;
    // OX ì´ˆê¸°í™” + ìˆ¨ê¹€
    optionsContainer.style.display = "none";
    optionsContainer.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    // ì¤‘ë³µ ë©”ì‹œì§€ ìˆ¨ê¹€ & ê¸°ì¡´ confirm í•¸ë“¤ëŸ¬ ì œê±°
    duplicateMsg.style.display = "none";
    confirmBtn.onclick = null;
  }

  function clearProductInputs() {
    // ì œí’ˆ ì„ íƒ ë³€ê²½ ì‹œ ìˆ˜ëŸ‰/ì˜µì…˜ ëª¨ë‘ ì´ˆê¸°í™”
    countInput.value = "";
    countInput.disabled = true;
    optionsContainer.style.display = "none";
    optionsContainer.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    duplicateMsg.style.display = "none";
    confirmBtn.onclick = null;
  }

  // ë‚ ì§œ í´ë¦­/ë³€ê²½ ì‹œ: ëª¨ë“  ì…ë ¥/ì„ íƒ ì´ˆê¸°í™” ë° ì œí’ˆ ì„ íƒ ì´ˆê¸°í™”
  dateInput.addEventListener("change", () => {
    // ì œí’ˆ ì„ íƒ ì´ˆê¸°í™”
    productSelect.value = "";
    // ê¸°íƒ€ ì…ë ¥ ì´ˆê¸°í™”
    clearAllInputs();
  });

  // âœ… ì œí’ˆ ì„ íƒ ì‹œ ì¤‘ë³µí™•ì¸ ì‹¤í–‰ (ìš”ì²­í•˜ì‹  ë¡œì§ì— ë§ì¶° ë™ì‘)
  productSelect.addEventListener("change", async () => {
    // ì œí’ˆ ì„ íƒì´ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸°í™” í›„ ë°”ë¡œ ì¢…ë£Œ
    if (!productSelect.value) {
      clearProductInputs();
      return;
    }

    // ìš”ì²­í•˜ì‹  ëŒ€ë¡œ: ì œí’ˆì„ ì„ íƒí•˜ê±°ë‚˜ ë°”ê¿€ ë•Œ **ë¨¼ì € ì „ì²´ ì´ˆê¸°í™”**
    clearProductInputs();

    if (!dateInput.value) {
      alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
      productSelect.value = "";
      return;
    }

    // ì¤‘ë³µ í™•ì¸ (ì„œë²„)
    const query = encodeURIComponent(JSON.stringify({ date: dateInput.value, product: productSelect.value }));
    try {
      const res = await fetch(`${scriptUrl}?checkInput=${query}`);
      const data = await res.json();

      if (data.exists && data.data) {
        // ì¤‘ë³µ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ (í™•ì¸ ëˆ„ë¥´ë©´ ê°’ ë¡œë“œ)
        duplicateMsg.style.display = "block";

        // ì•ˆì „í•˜ê²Œ ì´ì „ onclick ì œê±° í›„ ìƒˆë¡œ ì„¤ì •
        confirmBtn.onclick = null;
        confirmBtn.onclick = () => {
          // í™•ì¸ í´ë¦­ ì‹œ: ë©”ì‹œì§€ ìˆ¨ê¸°ê³  ì…ë ¥ì°½ í™œì„±í™” ë° ê°’ ë¡œë“œ
          duplicateMsg.style.display = "none";
          countInput.disabled = false;
          optionsContainer.style.display = "block";

          countInput.value = data.data.count || 0;
          ["A","B","C","D","E"].forEach((k,i)=>{
            const val = data.data[k];
            const btns = optionsContainer.querySelectorAll(`.option-row:nth-child(${i+1}) .option-buttons button`);
            btns.forEach(b => b.classList.remove("selected"));
            if(val==="O") btns[0].classList.add("selected");
            else if(val==="X") btns[1].classList.add("selected");
          });
        };
      } else {
        // ì¤‘ë³µ ë°ì´í„° ì—†ìŒ -> ìƒˆ ì…ë ¥: í™œì„±í™”(ë¹ˆ ìƒíƒœ)
        countInput.disabled = false;
        optionsContainer.style.display = "block";
        countInput.value = "";
        optionsContainer.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
        duplicateMsg.style.display = "none";
        confirmBtn.onclick = null;
      }
    } catch(err){
      alert("ì„œë²„ ì˜¤ë¥˜: " + err.message);
      // ì˜¤ë¥˜ ì‹œì—ë„ ì…ë ¥ì°½ì€ ì‚¬ìš©ìê°€ ì…ë ¥ ê°€ëŠ¥í•˜ë„ë¡ í™œì„±í™”
      countInput.disabled = false;
      optionsContainer.style.display = "block";
    }
  });

  // âœ… ì €ì¥
submitBtn.addEventListener("click", async () => {
  if (!dateInput.value) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  if (!productSelect.value) return alert("ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.");

  const payload = {
    date: dateInput.value,
    product: productSelect.value,
    count: countInput.value || 0,
    A: optionsContainer.querySelector('.option-row:nth-child(1) .option-buttons button.selected')?.textContent || "",
    B: optionsContainer.querySelector('.option-row:nth-child(2) .option-buttons button.selected')?.textContent || "",
    C: optionsContainer.querySelector('.option-row:nth-child(3) .option-buttons button.selected')?.textContent || "",
    D: optionsContainer.querySelector('.option-row:nth-child(4) .option-buttons button.selected')?.textContent || "",
    E: optionsContainer.querySelector('.option-row:nth-child(5) .option-buttons button.selected')?.textContent || ""
  };

  try {
    const res = await fetch(scriptUrl, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "input=" + encodeURIComponent(JSON.stringify(payload))
    });
    
    // âœ… ì„œë²„(GAS)ì—ì„œ ë°˜í™˜ëœ ë¬¸êµ¬ë¥¼ ê·¸ëŒ€ë¡œ í‘œì‹œ
    const msg = await res.text();
    alert(msg || "ì €ì¥ ì™„ë£Œ!");

    // âœ… ì…ë ¥ì°½ ì´ˆê¸°í™”
    productSelect.value = "";
    countInput.value = "";
    countInput.disabled = true;
    optionsContainer.style.display = "none";
    optionsContainer.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    duplicateMsg.style.display = "none";
  } catch (err) {
    alert("ì„œë²„ ì˜¤ë¥˜: " + err.message);
  }
});

});
</script>
</body>
</html>
