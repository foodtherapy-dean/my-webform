<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Input ì‹œíŠ¸ ë°ì´í„° ì…ë ¥</title>
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
.app-container { display:flex; flex-direction:column; height:100%; }
.app-header { background:#3f51b5; color:#fff; text-align:center; padding:16px; font-size:1.6rem; }
.app-body { flex:1 1 auto; overflow-y:auto; padding:20px; background:#f9f9f9; }
.app-footer { flex:0 0 auto; padding:10px; }
input, select { width:100%; padding:10px; font-size:1.1rem; border:1px solid #ccc; border-radius:6px; margin-bottom:10px; }
button { font-size:1.2rem; padding:10px 0; border:none; border-radius:6px; cursor:pointer; }
#submitBtn { background:#3f51b5; color:#fff; width:100%; }
#duplicateMsg { display:none; background:#ffdddd; color:#900; padding:10px; border-radius:6px; margin-bottom:10px; text-align:center; }
.inline-row { display:flex; gap:10px; margin-bottom:10px; }
.selection-buttons button { width:100%; margin-bottom:6px; }
.selection-buttons button.active { background:#4caf50; color:#fff; }
.hidden { display:none; }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ğŸ“‹ Input ë°ì´í„° ì…ë ¥</div>

  <div class="app-body">
    <label for="date">ë‚ ì§œ</label>
    <input type="date" id="date">

    <div id="duplicateMsg">
      âš ï¸ ì¤‘ë³µëœ ë‚ ì§œ ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.
      <button id="loadDuplicateBtn">ì¤‘ë³µ ë°ì´í„° í™•ì¸</button>
    </div>

    <label for="product">í’ˆëª©ëª…</label>
    <select id="product" disabled>
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ë°€ê°€ë£¨">ë°€ê°€ë£¨</option>
      <option value="ì†Œê¸ˆ">ì†Œê¸ˆ</option>
      <option value="ì¹˜ìê°€ë£¨">ì¹˜ìê°€ë£¨</option>
      <option value="ë©”ë°€ê°€ë£¨">ë©”ë°€ê°€ë£¨</option>
    </select>

    <div class="inline-row hidden" id="countRow">
      <label for="count">ìˆ˜ëŸ‰</label>
      <input type="number" id="count" min="0">
    </div>

    <div class="selection-buttons hidden" id="selectionBtns">
      <button id="btn1">ì°¨ëŸ‰ìƒíƒœ</button>
      <button id="btn2">íŒŒë ˆíŠ¸ìƒíƒœ</button>
      <button id="btn3">ì™¸í¬ì¥ìƒíƒœ</button>
      <button id="btn4">í‘œì‹œê°€ì¤€</button>
      <button id="btn5">ì„±ì ì„œêµ¬ë¹„</button>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn" disabled>ğŸ’¾ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const scriptUrl = "https://script.google.com/macros/s/AKfycbzeg9VImWLnm250LnI-OkjhjLuyQeRf6yQPLk_x8UPAG2wNIcn53sKs_0tdvSoRa4EJLw/exec";

  const dateInput = document.getElementById("date");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const loadDuplicateBtn = document.getElementById("loadDuplicateBtn");

  const productSelect = document.getElementById("product");
  const countInput = document.getElementById("count");
  const countRow = document.getElementById("countRow");
  const selectionBtnsDiv = document.getElementById("selectionBtns");
  const submitBtn = document.getElementById("submitBtn");

  const buttons = [
    document.getElementById("btn1"),
    document.getElementById("btn2"),
    document.getElementById("btn3"),
    document.getElementById("btn4"),
    document.getElementById("btn5")
  ];

  const buttonState = { btn1:0, btn2:0, btn3:0, btn4:0, btn5:0 };

  // 1ï¸âƒ£ ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì…ë ¥
  dateInput.valueAsDate = new Date();

  // 2ï¸âƒ£ ë‚ ì§œ ë³€ê²½ ì‹œ ì¤‘ë³µ ì²´í¬
  async function checkDuplicateDate(dateVal) {
    duplicateMsg.style.display = "none";
    disableAllInputs(true);

    try {
      const query = encodeURIComponent(JSON.stringify({ date: dateVal }));
      const res = await fetch(`${scriptUrl}?getInput=${query}`);
      const data = res.ok ? await res.json() : {};
      if (data.exists) {
        duplicateMsg.style.display = "block";
      } else {
        productSelect.disabled = false;
      }
    } catch(err) { console.error(err); }
  }

  dateInput.addEventListener("change", () => {
    if (dateInput.value) checkDuplicateDate(dateInput.value);
    resetForm();
  });

  // 3ï¸âƒ£ ì¤‘ë³µ í™•ì¸ ë²„íŠ¼ í´ë¦­
  loadDuplicateBtn.addEventListener("click", async () => {
    const dateVal = dateInput.value;
    if (!dateVal) return;

    try {
      const query = encodeURIComponent(JSON.stringify({ date: dateVal }));
      const res = await fetch(`${scriptUrl}?checkInput=${query}`);
      const data = await res.json();

      enableProductSelection();

      if (data.exists) {
        const d = data.data;
        productSelect.value = d.product || "";
        countInput.value = d.count || 0;

        buttons.forEach((btn, idx) => {
          const key = "btn"+(idx+1);
          buttonState[key] = d[key] || 0;
          updateButtonVisual(btn, buttonState[key]);
        });
        countRow.classList.remove("hidden");
        selectionBtnsDiv.classList.remove("hidden");
      }
    } catch(err) { console.error(err); }
  });

  // 4ï¸âƒ£ í’ˆëª© ì„ íƒ ì‹œ ìˆ˜ëŸ‰/ì„ íƒë²„íŠ¼ í™œì„±í™”
  productSelect.addEventListener("change", () => {
    const active = !!productSelect.value;
    countRow.classList.toggle("hidden", !active);
    selectionBtnsDiv.classList.toggle("hidden", !active);
    submitBtn.disabled = !active;
    if (!active) resetSelectionButtons();
  });

  // 5ï¸âƒ£ ë²„íŠ¼ í´ë¦­ O/X í† ê¸€
  buttons.forEach((btn, idx) => {
    btn.addEventListener("click", () => {
      const key = "btn"+(idx+1);
      buttonState[key] = buttonState[key] ? 0 : 1;
      updateButtonVisual(btn, buttonState[key]);
    });
  });

  function updateButtonVisual(btn, state) {
    if (state) btn.classList.add("active");
    else btn.classList.remove("active");
  }

  function disableAllInputs(flag) {
    productSelect.disabled = flag;
    countInput.disabled = flag;
    buttons.forEach(b => b.disabled = flag);
    submitBtn.disabled = flag;
  }

  function enableProductSelection() {
    productSelect.disabled = false;
  }

  function resetForm() {
    productSelect.value = "";
    countInput.value = "";
    countRow.classList.add("hidden");
    selectionBtnsDiv.classList.add("hidden");
    submitBtn.disabled = true;
    resetSelectionButtons();
  }

  function resetSelectionButtons() {
    Object.keys(buttonState).forEach(k => buttonState[k] = 0);
    buttons.forEach(btn => btn.classList.remove("active"));
  }

  // 6ï¸âƒ£ ì €ì¥
  submitBtn.addEventListener("click", async () => {
    if (!dateInput.value || !productSelect.value) return alert("ë‚ ì§œì™€ í’ˆëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

    const payload = {
      date: dateInput.value,
      product: productSelect.value,
      count: countInput.value || 0,
      ...buttonState
    };

    try {
      const res = await fetch(scriptUrl, {
        method: "POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded" },
        body: "input=" + encodeURIComponent(JSON.stringify(payload))
      });
      const text = await res.text();
      alert("ì„œë²„ ì‘ë‹µ: " + text);
      resetForm();
    } catch(err) { alert("ì„œë²„ ì˜¤ë¥˜: " + err.message); }
  });

  // ì´ˆê¸° ì¤‘ë³µ ì²´í¬
  if (dateInput.value) checkDuplicateDate(dateInput.value);
});
</script>
</body>
</html>
