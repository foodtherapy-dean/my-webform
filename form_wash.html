<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>위생 점검</title>
  <style>
    /* 기존 스타일 코드 그대로 유지 */
  </style>
</head>
<body>
  <div class="app-container">
    <div class="app-header">위생 점검</div>

    <form id="inspectForm" class="app-body">
      <label>날짜
        <input type="date" id="date" name="date" />
      </label>

      <label>점검 옵션
        <select id="option" name="option" required>
          <option value="">선택하세요</option>
          <option value="작업전">작업전</option>
          <option value="작업중">작업중</option>
          <option value="작업후">작업후</option>
          <option value="수시점검">수시점검</option>
        </select>
      </label>

      <div id="loadingMsg">중복 확인 중...</div>

      <div id="duplicateMsg">
        <span id="duplicateText"></span>
        <button type="button" id="duplicateConfirmBtn">확인</button>
      </div>

      <div id="oxContainer" class="ox-group"></div>
    </form>

    <div class="app-footer">
      <button type="submit" form="inspectForm">저장</button>
    </div>
  </div>

  <script>
    // 날짜 기본값 오늘
    const dateInput = document.getElementById("date");
    dateInput.valueAsDate = new Date();

    // 각 옵션별 항목 정의
    const items = {
      "작업전": ["개인위생 - 복장구분 보관여부", "개인위생 - 건강/장신구/위생복 착용여부"],
      "작업중": ["공정관리 - 구역분리 및 오염관리", "공정관리 - 완제품 포장상태"],
      "작업후": ["방충방서 - 생산부산물 별도구획 보관 및 반출", "청소소독 - 작업장/설비/위생시설"],
      "수시점검": ["입고검수 - 원부재료 입고검수 준수여부"]
    };

    let oxValues = {};

    // 선택 시 하위 항목 표시
    const optionSelect = document.getElementById("option");
    const oxContainer = document.getElementById("oxContainer");

    optionSelect.addEventListener("change", async (e) => {
      oxContainer.innerHTML = "";
      oxValues = {};
      const opt = e.target.value;

      if (!opt || !items[opt]) return;

      // 로딩 메시지 보이기
      document.getElementById("loadingMsg").style.display = "block";

      try {
        // 중복 체크 URL 만들기
        const query = encodeURIComponent(JSON.stringify({ date: dateInput.value, option: opt }));
        const url = `https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?checkData=${query}`;
        const res = await fetch(url);
        const result = await res.json();

        // 중복 확인 메시지
        if (result.exists) {
          document.getElementById("duplicateText").innerText = `⚠️ 이미 같은 날짜(${dateInput.value})와 옵션(${opt})의 데이터가 존재합니다.`;
          document.getElementById("duplicateMsg").style.display = "block";
        } else {
          document.getElementById("duplicateMsg").style.display = "none";
        }

      } catch (err) {
        console.error("중복 체크 오류:", err);
      }

      // 로딩 메시지 숨기기
      document.getElementById("loadingMsg").style.display = "none";

      // 항목 표시
      items[opt].forEach((label) => {
        const oxSet = document.createElement("div");
        oxSet.className = "ox-set";
        oxSet.innerHTML = `
          <div>${label}</div>
          <div class="ox-buttons">
            <button type="button" class="ox" data-label="${label}" data-value="O">O</button>
            <button type="button" class="ox" data-label="${label}" data-value="X">X</button>
          </div>
        `;
        oxContainer.appendChild(oxSet);
      });
    });

    // OX 선택 처리
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("ox")) {
        const btn = e.target;
        const label = btn.dataset.label;
        oxValues[label] = btn.dataset.value;
        document.querySelectorAll(`.ox[data-label="${label}"]`).forEach((b) => {
          b.classList.toggle("selected", b === btn);
        });
      }
    });

    // 중복 확인 확인 버튼
    document.getElementById("duplicateConfirmBtn").addEventListener("click", () => {
      document.getElementById("duplicateMsg").style.display = "none";
    });

    // 폼 제출 처리
    document.getElementById("inspectForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!optionSelect.value) {
        alert("점검 옵션을 선택하세요");
        return;
      }

      // 필수 항목 체크
      for (const label of items[optionSelect.value]) {
        if (!(label in oxValues)) {
          alert(`'${label}' 항목을 선택하세요.`);
          return;
        }
      }

      const data = {
        date: dateInput.value,
        option: optionSelect.value,
        states: oxValues,
      };

      const formData = new FormData();
      formData.append("inspect", JSON.stringify(data));

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbzuT-_RAwyZvrq8GmRmHcR8G3LI8u4xiqOw4SmMEqVOfOeJ-kNH5BCaS6nKsjK3WyDBtA/exec", {
          method: "POST",
          body: formData,
        });

        const result = await response.text();
        if (response.ok) {
          alert("✅ 저장 완료:\n" + result);
          e.target.reset();
          oxContainer.innerHTML = "";
          oxValues = {};
        } else {
          alert("❌ 오류:\n" + result);
        }
      } catch (err) {
        alert("❌ 저장 중 오류:\n" + err.message);
      }
    });
  </script>
</body>
</html>
