<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>건면공정 모니터링</title>
<style>
  :root{--green:#4CAF50;}
  body,html{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;}
  .app-container{display:flex;flex-direction:column;height:100%;}
  .app-header{background:var(--green);color:#fff;padding:16px;text-align:center;font-size:1.25rem;}
  .app-body{flex:1 1 auto;overflow:auto;padding:18px;box-sizing:border-box;background:#f9f9f9;}
  label{display:block;margin-top:12px;margin-bottom:6px;font-weight:600;font-size:0.95rem;}
  input[type="date"], input[type="number"], select, .custom-select .selected-option {
    width:100%; padding:12px 14px; box-sizing:border-box; font-size:1rem;
    border:1px solid #ccc; border-radius:8px; background:#fff;
  }
  .inline-row{display:flex;gap:14px;margin-top:8px;}
  .inline-row>div{flex:1;}
  #duplicateMsg{display:none;background:#fff3f3;color:#900;padding:10px;border:1px solid #900;border-radius:8px;margin-top:10px;font-weight:700;}
  #duplicateMsg button{margin-left:12px;background:#900;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}
  #loadingMsg{display:none;background:#fff7e0;padding:8px;border-radius:8px;margin-top:10px;font-weight:700;color:#333;}
  .custom-select{position:relative;width:100%;}
  .custom-select .selected-option{cursor:pointer;border-radius:8px;}
  .custom-select ul.options{
    position:absolute; left:0; right:0; top:100%; margin:8px 0 0 0; padding:0; list-style:none;
    border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.12); background:#fff; border:1px solid #ddd;
    z-index:2000; display:none;
  }
  .custom-select.open ul.options{display:block;}
  .custom-select ul.options li{padding:12px 14px; cursor:pointer; font-size:1rem; border-bottom:1px solid #f0f0f0;}
  .custom-select ul.options li:last-child{border-bottom:none;}
  .custom-select ul.options li:hover{background:var(--green);color:#fff;}
  @media (max-width:480px){
    .custom-select ul.options{margin:6px 0 0 0;}
    .custom-select ul.options li{padding:14px 16px;}
  }
  #recommended { margin-top:6px; font-weight:700; color:var(--green); min-height:20px; }
  .app-footer{padding:12px;}
  #submitBtn{width:100%;padding:14px 16px;font-size:1.05rem;background:var(--green);color:#fff;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">건면공정 점검 입력</div>

  <div class="app-body">
    <label for="date">날짜</label>
    <input id="date" type="date" />

    <label for="group">점검 옵션</label>
    <div class="custom-select" id="customGroup">
      <div class="selected-option">선택하세요</div>
      <ul class="options" role="listbox" aria-label="점검 옵션"></ul>
    </div>

    

    <div id="duplicateMsg"><span id="duplicateText"></span><button id="duplicateConfirmBtn" type="button">확인</button></div>
    <div id="loadingMsg">중복 확인 중...</div>

    <div class="inline-row" id="timeRow" style="display:none;">
      <div>
        <label for="hour">시간 (시)</label>
        <select id="hour" aria-label="시간 시"></select>
      </div>
      <div>
        <label for="minute">시간 (분)</label>
        <select id="minute" aria-label="시간 분"></select>
      </div>
    </div>
    <div id="recommended"></div>

    <div class="inline-row" id="thRow" style="display:none;">
      <div>
        <label for="temp">온도(℃)</label>
        <input id="temp" type="number" step="0.1" min="0" max="100" />
      </div>
      <div>
        <label for="humidity">습도(%)</label>
        <input id="humidity" type="number" step="0.1" min="0" max="100" />
      </div>
    </div>

    <div class="inline-row" id="productRow" style="display:none;">
      <div>
        <label for="product">제품명</label>
        <select id="product">
          <option value="">선택하세요</option>
          <option value="일반국수">일반국수</option>
          <option value="치자국수">치자국수</option>
          <option value="메밀국수">메밀국수</option>
        </select>
      </div>
      <div>
        <label for="count">수량</label>
        <input id="count" type="number" min="1" />
      </div>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">📥 서버로 전송</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const scriptUrl = "https://script.google.com/macros/s/AKfycbwTDib5h0YwBWyZjgT-r4NkcD2yzXSmx3TCITQed4v3WNmqE0Lx5zZQkWbTTS8MLdouIg/exec";

  const dateInput = document.getElementById('date');
  const customGroup = document.getElementById('customGroup');
  const selectedDiv = customGroup.querySelector('.selected-option');
  const optionsList = customGroup.querySelector('.options');
  const recommendedDiv = document.getElementById('recommended');
  const duplicateMsg = document.getElementById('duplicateMsg');
  const duplicateText = document.getElementById('duplicateText');
  const duplicateConfirmBtn = document.getElementById('duplicateConfirmBtn');
  const loadingMsg = document.getElementById('loadingMsg');
  const timeRow = document.getElementById('timeRow');
  const hourSelect = document.getElementById('hour');
  const minuteSelect = document.getElementById('minute');
  const thRow = document.getElementById('thRow');
  const tempInput = document.getElementById('temp');
  const humidityInput = document.getElementById('humidity');
  const productRow = document.getElementById('productRow');
  const productSelect = document.getElementById('product');
  const countInput = document.getElementById('count');
  const submitBtn = document.getElementById('submitBtn');

  const optionItems = ["생산제품","시스템ON","1차점검","2차점검","시스템OFF"];
  const orderMap = ["시스템ON","1차점검","2차점검","시스템OFF"];
  let loadedData = {};
  let optionsLoadedForDate = null;

  dateInput.valueAsDate = new Date();

  function fillTimeOptions(){
    hourSelect.innerHTML = '<option value=""></option>';
    for(let h=1; h<=24; h++){ hourSelect.innerHTML += `<option value="${String(h).padStart(2,"0")}">${String(h).padStart(2,"0")}</option>`; }
    minuteSelect.innerHTML = '<option value=""></option>';
    for(let m=0; m<60; m+=10){ minuteSelect.innerHTML += `<option value="${String(m).padStart(2,"0")}">${String(m).padStart(2,"0")}</option>`; }
  }
  fillTimeOptions();

  function renderOptions(existing=[]){
    optionsList.innerHTML = "";
    optionItems.forEach(opt=>{
      const li = document.createElement('li');
      li.dataset.value = opt;
      li.textContent = existing.includes(opt) ? `${opt}(완료)` : opt;
      optionsList.appendChild(li);
    });
  }

  async function updateOptionCompletion(dateVal){
    if(!dateVal){ renderOptions([]); optionsLoadedForDate = null; return; }
    try{
      const query = encodeURIComponent(JSON.stringify({date: dateVal}));
      const res = await fetch(`${scriptUrl}?getNoodle=${query}`);
      const data = res.ok ? await res.json() : {};
      const existing = data.options || [];
      optionsLoadedForDate = dateVal;
      renderOptions(existing);
    } catch(err){
      console.error("updateOptionCompletion error", err);
      renderOptions([]);
    }
  }

  function applyGroupDataToInputs(d){
    if(!d){ hourSelect.value=""; minuteSelect.value=""; tempInput.value=""; humidityInput.value=""; productSelect.value=""; countInput.value=""; return; }
    hourSelect.value = d.hour ? String(d.hour).padStart(2,'0') : "";
    minuteSelect.value = d.minute ? String(d.minute).padStart(2,'0') : "";
    tempInput.value = d.temp || "";
    humidityInput.value = d.humi || "";
    productSelect.value = d.product || "";
    countInput.value = d.count || "";
  }

  async function checkDuplicate(date, group, internal=false){
    if(!date || !group) return {ok:false};
    try{
      const res = await fetch(`${scriptUrl}?checkNoodle=` + encodeURIComponent(JSON.stringify({date,group})));
      const data = await res.json();
      const exists = Boolean(data.exists);
      const dat = data.data || null;
      loadedData[group] = { fetched:true, exists: exists, data: dat };
      if(!internal){
        if(exists){
          applyGroupDataToInputs(dat);
          duplicateText.textContent = `⚠️ 이미 같은 날짜(${date})와 옵션(${group}) 데이터가 존재합니다.`;
          duplicateMsg.style.display = "block";
        } else {
          duplicateMsg.style.display = "none";
        }
      }
      return {ok:true, exists, data: dat};
    } catch(err){
      console.error("checkDuplicate error", err);
      if(!internal){
        duplicateText.textContent = "중복 확인 오류!";
        duplicateMsg.style.display = "block";
      }
      return {ok:false};
    }
  }

  function fmtHourWrap(n){ const v = (((Number(n)||0)-1)%24+24)%24+1; return String(v).padStart(2,'0'); }

  function updateSuggestion(selected){
    const sel = selected || (selectedDiv.dataset.value || "");
    if(!sel){ recommendedDiv.textContent = ""; return; }
    let out = "";
    if(sel === "1차점검"){
      const sys = loadedData["시스템ON"];
      out = (sys && sys.data && sys.data.hour) ? `추천: ${fmtHourWrap(Number(sys.data.hour)+7)}시` : "시스템ON 미입력";
    } else if(sel === "2차점검"){
      const first = loadedData["1차점검"];
      out = (first && first.data && first.data.hour) ? `추천: ${fmtHourWrap(Number(first.data.hour)+1)}시` : "1차점검 미입력";
    } else if(sel === "시스템OFF"){
      const second = loadedData["2차점검"];
      if(!second || !second.data || !second.data.hour){ out = "2차점검 미입력"; }
      else {
        const sys = loadedData["시스템ON"];
        out = (sys && sys.data && sys.data.hour) ? `추천: ${fmtHourWrap(Number(sys.data.hour)+10)}시` : "시스템ON 미입력";
      }
    }
    recommendedDiv.textContent = out ? ` ${out}` : "";
  }

  function updateInputFields(selected){
    const sel = selected || (selectedDiv.dataset.value || "");
    if(sel === "시스템ON" || sel === "시스템OFF"){ timeRow.style.display = "flex"; thRow.style.display = "none"; productRow.style.display = "none"; }
    else if(sel === "1차점검" || sel === "2차점검"){ timeRow.style.display = "flex"; thRow.style.display = "flex"; productRow.style.display = "none"; }
    else if(sel === "생산제품"){ timeRow.style.display = "none"; thRow.style.display = "none"; productRow.style.display = "flex"; }
    else { timeRow.style.display = "none"; thRow.style.display = "none"; productRow.style.display = "none"; }
  }

  duplicateConfirmBtn.addEventListener('click', ()=> { duplicateMsg.style.display = "none"; });
  renderOptions([]);

  // 점검옵션 클릭 이벤트
  customGroup.addEventListener('click', (e) => {
    if(e.target.classList.contains('selected-option')){
      // 클릭 시 loading 표시 후 중복 확인
      const dateVal = dateInput.value;
      if(!dateVal) return;
      loadingMsg.style.display = "block";
      optionsList.innerHTML = ""; // 옵션 숨김
      (async ()=>{
        // 날짜 기준 캐시 확인
        if(optionsLoadedForDate !== dateVal){
          await updateOptionCompletion(dateVal);
        }
        // 모든 옵션 중복 체크 병렬
        const promises = orderMap.map(opt => checkDuplicate(dateVal, opt, true));
        await Promise.all(promises);
        // 완료 여부 표시
        renderOptions(orderMap.filter(opt=>loadedData[opt]?.exists));
        loadingMsg.style.display = "none";
        customGroup.classList.add('open');
      })();
      return;
    }

    // LI 선택 시
    if(e.target.tagName === 'LI'){
      const value = e.target.dataset.value;
      selectedDiv.textContent = e.target.textContent;
      selectedDiv.dataset.value = value;

      (async ()=>{
        duplicateMsg.style.display = "none";
        duplicateText.textContent = "";
        applyGroupDataToInputs(null);
        await checkDuplicate(dateInput.value, value, false);
        updateInputFields(value);
        updateSuggestion(value);
      })();
    }
  });

  document.addEventListener('click', (e)=>{ if(!customGroup.contains(e.target)) customGroup.classList.remove('open'); });
  document.addEventListener('keydown', (e) => { if(e.key === 'Escape') customGroup.classList.remove('open'); });

  dateInput.addEventListener('change', async ()=>{
    selectedDiv.textContent = "선택하세요"; selectedDiv.dataset.value = "";
    duplicateMsg.style.display = "none"; duplicateText.textContent = "";
    applyGroupDataToInputs(null);
    recommendedDiv.textContent = "";
    loadedData = {}; optionsLoadedForDate = null; updateInputFields();
    await updateOptionCompletion(dateInput.value);
  });

  hourSelect.addEventListener('change', ()=>{
    const sel = selectedDiv.dataset.value || "";
    if(sel){
      if(!loadedData[sel]) loadedData[sel] = { fetched:false, exists:false, data: {} };
      loadedData[sel].data = loadedData[sel].data || {};
      loadedData[sel].data.hour = hourSelect.value ? parseInt(hourSelect.value,10) : null;
    }
    updateSuggestion(sel);
  });

  submitBtn.addEventListener('click', async ()=>{
    const sel = selectedDiv.dataset.value || "";
    if(!sel){ alert("점검 옵션을 선택하세요."); return; }
    if(!dateInput.value){ alert("날짜를 선택하세요."); return; }
    if(timeRow.style.display !== "none"){ if(!hourSelect.value){ alert("시간(시) 선택"); return; } if(!minuteSelect.value){ alert("시간(분) 선택"); return; } }
    if(thRow.style.display !== "none"){ if(!tempInput.value){ alert("온도 입력"); return; } if(!humidityInput.value){ alert("습도 입력"); return; } }
    if(productRow.style.display !== "none"){ if(!productSelect.value){ alert("제품명 선택"); return; } if(!countInput.value){ alert("수량 입력"); return; } }

    let entries;
    if(productRow.style.display !== "none"){
      entries = [{ product: productSelect.value, count: countInput.value }];
    } else {
      entries = [{ hour: hourSelect.value, minute: minuteSelect.value, temp: tempInput.value, humi: humidityInput.value, product: productSelect.value || "", count: countInput.value || "" }];
    }
    const payload = { date: dateInput.value, group: sel, entries: entries };
    try{
      const res = await fetch(scriptUrl, { method:"POST", body: JSON.stringify({ noodle: payload }) });
      const txt = await res.text();
      alert("✅ 서버 응답: " + txt);
      await updateOptionCompletion(dateInput.value);
    } catch(err){ alert("❌ 서버 전송 오류: " + err.message); }
  });

  updateOptionCompletion(dateInput.value);
});
</script>

</body>
</html>
