<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê±´ë©´ê³µì • ëª¨ë‹ˆí„°ë§</title>
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
.app-container { display:flex; flex-direction:column; height:100%; }
.app-header { background:#4CAF50; color:#fff; text-align:center; padding:16px; font-size:1.6rem; }
.app-body { flex:1 1 auto; overflow-y:auto; padding:20px; box-sizing:border-box; background:#f9f9f9; }
.app-footer { flex:0 0 auto; }
#submitBtn { width:100%; font-size:1.5rem; padding:20px 0; background:#4CAF50; color:#fff; border:none; cursor:pointer; }
.inline-row { display:flex; gap:20px; margin-top:10px; }
.inline-row > * { flex:1; }
label { display:block; margin-bottom:6px; }
input, select { width:100%; padding:14px 16px; font-size:1.2rem; border:1px solid #ccc; border-radius:6px; }
#duplicateMsg { display:none; background:#ffcccc; color:#900; padding:12px; margin-top:6px; border:1px solid #900; border-radius:6px; font-weight:bold; }
#duplicateMsg button { margin-left:12px; background:#900; color:#fff; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; }
#loadingMsg { display:none; background:#ffe599; color:#333; padding:8px; margin-bottom:10px; border-radius:6px; font-weight:bold; }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ê±´ë©´ê³µì • ì ê²€ ì…ë ¥</div>

  <div class="app-body">
    <!-- ë‚ ì§œ -->
    <label for="date">ë‚ ì§œ</label>
    <input type="date" id="date" required />

    <!-- ì ê²€ ì˜µì…˜ -->
    <label for="group" style="margin-top:20px;">ì ê²€ ì˜µì…˜</label>
    <select id="group" required>
      <option value="">ì„ íƒí•˜ì„¸ìš”</option>
      <option value="ìƒì‚°ì œí’ˆ">ìƒì‚°ì œí’ˆ</option>
      <option value="ì‹œìŠ¤í…œON">ì‹œìŠ¤í…œON</option>
      <option value="1ì°¨ì ê²€">1ì°¨ì ê²€</option>
      <option value="2ì°¨ì ê²€">2ì°¨ì ê²€</option>
      <option value="ì‹œìŠ¤í…œOFF">ì‹œìŠ¤í…œOFF</option>
    </select>

    <!-- ì¤‘ë³µ ë©”ì‹œì§€ -->
    <div id="duplicateMsg">
      <span id="duplicateText"></span>
      <button id="duplicateConfirmBtn">í™•ì¸</button>
    </div>

    <!-- ë¡œë”© ë©”ì‹œì§€ -->
    <div id="loadingMsg">ì¤‘ë³µ í™•ì¸ ì¤‘...</div>

    <!-- ì‹œê°„ ì…ë ¥ -->
    <div class="inline-row" id="timeRow">
      <div>
        <label for="hour">ì‹œê°„ (ì‹œ)</label>
        <select id="hour"></select>
      </div>
      <div>
        <label for="minute">ì‹œê°„ (ë¶„)</label>
        <select id="minute"></select>
      </div>
    </div>

    <!-- ì˜¨ë„ / ìŠµë„ ì…ë ¥ -->
    <div class="inline-row" id="thRow">
      <div>
        <label for="temp">ì˜¨ë„(â„ƒ)</label>
        <input type="number" id="temp" step="0.1" min="0" max="100" />
      </div>
      <div>
        <label for="humidity">ìŠµë„(%)</label>
        <input type="number" id="humidity" step="0.1" min="0" max="100" />
      </div>
    </div>

    <!-- ìƒì‚°ì œí’ˆ ì…ë ¥ -->
    <div class="inline-row" id="productRow" style="display:none;">
      <div>
        <label for="product">ì œí’ˆëª…</label>
        <select id="product">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ì¼ë°˜êµ­ìˆ˜">ì¼ë°˜êµ­ìˆ˜</option>
          <option value="ì¹˜ìêµ­ìˆ˜">ì¹˜ìêµ­ìˆ˜</option>
          <option value="ë©”ë°€êµ­ìˆ˜">ë©”ë°€êµ­ìˆ˜</option>
        </select>
      </div>
      <div>
        <label for="count">ìˆ˜ëŸ‰</label>
        <input type="number" id="count" min="1" />
      </div>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ“¥ ì„œë²„ë¡œ ì „ì†¡</button>
  </div>
</div>

<script>
// ====== ê¸°ë³¸ ì„¸íŒ… ======
const dateInput = document.getElementById("date");
const optionSelect = document.getElementById("option");
const hourSelect = document.getElementById("hour");
const minuteSelect = document.getElementById("minute");
const formFields = document.getElementById("form-fields");
const recommendBox = document.getElementById("recommend-box");

dateInput.valueAsDate = new Date();

// ====== ë¡œì»¬ ì €ì¥ì†Œ (ì¡°íšŒëœ ë°ì´í„° ìºì‹±) ======
let loadedData = {};  

// ====== ì˜µì…˜ë³„ ì´ì „ ì°¨ìˆ˜ ë§¤í•‘ ======
const prevMap = {
  "1ì°¨ì ê²€": "ì‹œìŠ¤í…œON",
  "2ì°¨ì ê²€": "1ì°¨ì ê²€",
  "ì‹œìŠ¤í…œOFF": "2ì°¨ì ê²€"
};

// ====== ì˜µì…˜ í´ë¦­ ì´ë²¤íŠ¸ ======
optionSelect.addEventListener("change", async () => {
  // 1. ì…ë ¥ì°½ê³¼ ì¶”ì²œì‹œê°„ ì¦‰ì‹œ ìˆ¨ê¹€
  formFields.style.display = "none";
  recommendBox.style.display = "none";
  recommendBox.textContent = "";

  const date = dateInput.value;
  const option = optionSelect.value;
  if (!date || !option) return;

  try {
    // 2. ì„œë²„ì— ë°ì´í„° ìš”ì²­ (í˜„ì¬ ì°¨ìˆ˜ í¬í•¨, ì´ì „ ì°¨ìˆ˜ê¹Œì§€)
    const response = await fetch(
      `${SCRIPT_URL}?action=getData&date=${encodeURIComponent(date)}`
    );
    const result = await response.json();

    // 3. loadedData ì´ˆê¸°í™” í›„ ì±„ìš°ê¸°
    loadedData = result || {};

    // 4. í˜„ì¬ ì°¨ìˆ˜ ë°ì´í„° í‘œì‹œ (ìˆìœ¼ë©´ ì±„ì›€)
    if (loadedData[option]) {
      const { hour, minute } = loadedData[option];
      hourSelect.value = hour || "";
      minuteSelect.value = minute || "";
    } else {
      hourSelect.value = "";
      minuteSelect.value = "";
    }

    // 5. ì¶”ì²œì‹œê°„ ê³„ì‚°/í‘œì‹œ
    showRecommendTime(option);

    // 6. ì…ë ¥ì°½ í‘œì‹œ
    formFields.style.display = "block";
  } catch (err) {
    console.error("ì¤‘ë³µí™•ì¸ ì˜¤ë¥˜:", err);
    alert("ì¤‘ë³µí™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

// ====== ì¶”ì²œì‹œê°„ í‘œì‹œ í•¨ìˆ˜ ======
function showRecommendTime(option) {
  recommendBox.style.display = "block";

  // ì‹œìŠ¤í…œONì€ ì¶”ì²œì‹œê°„ ì—†ìŒ
  if (option === "ì‹œìŠ¤í…œON") {
    recommendBox.textContent = "ì¶”ì²œì‹œê°„ ì—†ìŒ";
    return;
  }

  const prevOption = prevMap[option];
  const prevData = loadedData[prevOption];

  if (!prevData || !prevData.hour) {
    recommendBox.textContent = `${prevOption} ë¯¸ì…ë ¥`;
    return;
  }

  // ì‹œê°„ ê³„ì‚°
  let h = parseInt(prevData.hour, 10);
  let m = parseInt(prevData.minute || "0", 10);

  if (option === "1ì°¨ì ê²€") {
    h += 4;
  } else if (option === "2ì°¨ì ê²€") {
    h += 4;
  } else if (option === "ì‹œìŠ¤í…œOFF") {
    h += 10;
  }

  if (m >= 60) {
    h += Math.floor(m / 60);
    m = m % 60;
  }
  h = h % 24;

  const hh = h.toString().padStart(2, "0");
  const mm = m.toString().padStart(2, "0");

  recommendBox.textContent = `ì¶”ì²œì‹œê°„: ${hh}:${mm}`;
}
</script>

<style>
/* ì¶”ì²œì‹œê°„ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
#recommend-box {
  margin-top: 6px;
  padding: 6px 10px;
  border-radius: 6px;
  background: #f9f9f9;
  border: 1px solid #ddd;
  font-size: 14px;
  color: #333;
  display: none;
}
</style>

</body>
</html>
