<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>건면공정 모니터링</title>
<style>
  :root{--green:#4CAF50;}
  body,html{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;}
  .app-container{display:flex;flex-direction:column;height:100%;}
  .app-header{background:var(--green);color:#fff;padding:16px;text-align:center;font-size:1.25rem;}
  .app-body{flex:1 1 auto;overflow:auto;padding:18px;box-sizing:border-box;background:#f9f9f9;}
  label{display:block;margin-top:12px;margin-bottom:6px;font-weight:600;font-size:0.95rem;}
  input[type="date"], input[type="number"], select, .custom-select .selected-option {
    width:100%; padding:12px 14px; box-sizing:border-box; font-size:1rem;
    border:1px solid #ccc; border-radius:8px; background:#fff;
  }
  .inline-row{display:flex;gap:14px;margin-top:8px;}
  .inline-row>div{flex:1;}
  #duplicateMsg{display:none;background:#fff3f3;color:#900;padding:10px;border:1px solid #900;border-radius:8px;margin-top:10px;font-weight:700;}
  #duplicateMsg button{margin-left:12px;background:#900;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}
  #loadingMsg{display:none;background:#fff7e0;padding:8px;border-radius:8px;margin-top:10px;font-weight:700;color:#333;}
  .custom-select{position:relative;width:100%;}
  .custom-select .selected-option{cursor:pointer;border-radius:8px;}
  .custom-select ul.options{
    position:absolute; left:0; right:0; top:100%; margin:8px 0 0 0; padding:0; list-style:none;
    border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.12); background:#fff; border:1px solid #ddd;
    z-index:2000; display:none;
  }
  .custom-select.open ul.options{display:block;}
  .custom-select ul.options li{padding:12px 14px; cursor:pointer; font-size:1rem; border-bottom:1px solid #f0f0f0;}
  .custom-select ul.options li:last-child{border-bottom:none;}
  .custom-select ul.options li:hover{background:var(--green);color:#fff;}
  @media (max-width:480px){
    .custom-select ul.options{margin:6px 0 0 0;}
    .custom-select ul.options li{padding:14px 16px;}
  }
  #recommended { margin-top:6px; font-weight:700; color:var(--green); min-height:20px; }
  .app-footer{padding:12px;}
  #submitBtn{width:100%;padding:14px 16px;font-size:1.05rem;background:var(--green);color:#fff;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">건면공정 점검 입력</div>

  <div class="app-body">
    <label for="date">날짜</label>
    <input id="date" type="date" />

    <label for="group">점검 옵션</label>
    <select id="group">
      <option value="">선택하세요</option>
      <option value="생산제품">생산제품</option>
      <option value="시스템ON">시스템ON</option>
      <option value="1차점검">1차점검</option>
      <option value="2차점검">2차점검</option>
      <option value="시스템OFF">시스템OFF</option>
    </select>

    <div id="loadingMsg">중복 확인 중...</div>
    <div id="duplicateMsg"><span id="duplicateText"></span><button id="duplicateConfirmBtn" type="button">확인</button></div>

    <div class="inline-row" id="timeRow" style="display:none;">
      <div>
        <label for="hour">시간 (시)</label>
        <select id="hour"></select>
      </div>
      <div>
        <label for="minute">시간 (분)</label>
        <select id="minute"></select>
      </div>
    </div>
    <div id="recommended"></div>

    <div class="inline-row" id="thRow" style="display:none;">
      <div>
        <label for="temp">온도(℃)</label>
        <input id="temp" type="number" step="0.1" min="0" max="100" />
      </div>
      <div>
        <label for="humidity">습도(%)</label>
        <input id="humidity" type="number" step="0.1" min="0" max="100" />
      </div>
    </div>

    <div class="inline-row" id="productRow" style="display:none;">
      <div>
        <label for="product">제품명</label>
        <select id="product">
          <option value="">선택하세요</option>
          <option value="일반국수">일반국수</option>
          <option value="치자국수">치자국수</option>
          <option value="메밀국수">메밀국수</option>
        </select>
      </div>
      <div>
        <label for="count">수량</label>
        <input id="count" type="number" min="1" />
      </div>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">📥 서버로 전송</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const scriptUrl = "https://script.google.com/macros/s/AKfycbwTDib5h0YwBWyZjgT-r4NkcD2yzXSmx3TCITQed4v3WNmqE0Lx5zZQkWbTTS8MLdouIg/exec";

  const dateInput = document.getElementById('date');
  const groupSelect = document.getElementById('group');
  const recommendedDiv = document.getElementById('recommended');
  const duplicateMsg = document.getElementById('duplicateMsg');
  const duplicateText = document.getElementById('duplicateText');
  const duplicateConfirmBtn = document.getElementById('duplicateConfirmBtn');
  const loadingMsg = document.getElementById('loadingMsg');

  const timeRow = document.getElementById('timeRow');
  const hourSelect = document.getElementById('hour');
  const minuteSelect = document.getElementById('minute');
  const thRow = document.getElementById('thRow');
  const tempInput = document.getElementById('temp');
  const humidityInput = document.getElementById('humidity');
  const productRow = document.getElementById('productRow');
  const productSelect = document.getElementById('product');
  const countInput = document.getElementById('count');
  const submitBtn = document.getElementById('submitBtn');

  const optionOrder = ["시스템ON","1차점검","2차점검","시스템OFF"];
  let loadedData = {};

  dateInput.valueAsDate = new Date();

  function fillTimeOptions(){
    hourSelect.innerHTML='<option value=""></option>';
    for(let h=1;h<=24;h++){hourSelect.innerHTML+=`<option value="${String(h).padStart(2,"0")}">${String(h).padStart(2,"0")}</option>`;}
    minuteSelect.innerHTML='<option value=""></option>';
    for(let m=0;m<60;m+=10){minuteSelect.innerHTML+=`<option value="${String(m).padStart(2,"0")}">${String(m).padStart(2,"0")}</option>`;}
  }
  fillTimeOptions();

  async function checkDuplicate(date, group){
    if(!date || !group) return;
    loadingMsg.style.display="block";
    submitBtn.disabled=true;
    try{
      const res = await fetch(`${scriptUrl}?checkNoodle=${encodeURIComponent(JSON.stringify({date,group}))}`);
      const data = await res.json();
      loadingMsg.style.display="none";
      submitBtn.disabled=false;

      loadedData[group] = { exists: data.exists, data: data.data || {} };

      if(data.exists){
        hourSelect.value = data.data.hour || "";
        minuteSelect.value = data.data.minute || "";
        tempInput.value = data.data.temp || "";
        humidityInput.value = data.data.humi || "";
        productSelect.value = data.data.product || "";
        countInput.value = data.data.count || "";

        duplicateText.textContent=`⚠️ 이미 같은 날짜(${date})와 옵션(${group}) 데이터가 존재합니다.`;
        duplicateMsg.style.display="block";
      } else {
        duplicateMsg.style.display="none";
        duplicateText.textContent="";
      }
    } catch(err){
      loadingMsg.style.display="none";
      submitBtn.disabled=false;
      console.error(err);
      duplicateText.textContent="중복 확인 오류!";
      duplicateMsg.style.display="block";
    }
  }

  function fmtHourWrap(n){return String((((Number(n)||0)-1+24)%24)+1).padStart(2,'0');}

  function updateSuggestion(selected){
    const sel = selected || groupSelect.value;
    if(!sel){recommendedDiv.textContent=""; return;}
    let out="";
    if(sel==="1차점검"){const sys=loadedData["시스템ON"]; out=sys&&sys.data&&sys.data.hour?`추천: ${fmtHourWrap(Number(sys.data.hour)+7)}시`:"시스템ON 미입력";}
    else if(sel==="2차점검"){const first=loadedData["1차점검"]; out=first&&first.data&&first.data.hour?`추천: ${fmtHourWrap(Number(first.data.hour)+1)}시`:"1차점검 미입력";}
    else if(sel==="시스템OFF"){const second=loadedData["2차점검"]; if(!second||!second.data||!second.data.hour){out="2차점검 미입력";}else{const sys=loadedData["시스템ON"]; out=sys&&sys.data&&sys.data.hour?`추천: ${fmtHourWrap(Number(sys.data.hour)+10)}시`:"시스템ON 미입력";}}
    else out="";
    recommendedDiv.textContent=out?` ${out}`:"";
  }

  function updateInputFields(){
    const sel = groupSelect.value;
    if(sel==="시스템ON"||sel==="시스템OFF"){timeRow.style.display="flex"; thRow.style.display="none"; productRow.style.display="none";}
    else if(sel==="1차점검"||sel==="2차점검"){timeRow.style.display="flex"; thRow.style.display="flex"; productRow.style.display="none";}
    else if(sel==="생산제품"){timeRow.style.display="none"; thRow.style.display="none"; productRow.style.display="flex";}
    else {timeRow.style.display="none"; thRow.style.display="none"; productRow.style.display="none";}
  }

  duplicateConfirmBtn.addEventListener('click', ()=>{duplicateMsg.style.display="none";});

  // 옵션 클릭 시: 중복체크 후 드롭다운 활성화
  groupSelect.addEventListener('mousedown', async (e)=>{
    e.preventDefault();
    await checkDuplicate(dateInput.value, groupSelect.value);
    groupSelect.showPicker();
  });

  // 옵션 변경 시: 입력창 초기화 후 기존 데이터 로드
  groupSelect.addEventListener('change', async ()=>{
    timeRow.style.display="none"; thRow.style.display="none"; productRow.style.display="none";
    hourSelect.value=""; minuteSelect.value=""; tempInput.value=""; humidityInput.value=""; productSelect.value=""; countInput.value="";
    recommendedDiv.textContent="";
    duplicateMsg.style.display="none"; duplicateText.textContent="";

    const selected = groupSelect.value;
    if(!selected) return;
    await checkDuplicate(dateInput.value, selected);
    updateInputFields();
    updateSuggestion();
  });

  dateInput.addEventListener('change', ()=>{
    groupSelect.value="";
    timeRow.style.display="none"; thRow.style.display="none"; productRow.style.display="none";
    hourSelect.value=""; minuteSelect.value=""; tempInput.value=""; humidityInput.value=""; productSelect.value=""; countInput.value="";
    recommendedDiv.textContent="";
    loadedData={};
    duplicateMsg.style.display="none"; duplicateText.textContent="";
  });

  hourSelect.addEventListener('change', ()=>{updateSuggestion();});

  submitBtn.addEventListener('click', async ()=>{
    const sel = groupSelect.value;
    if(!sel){alert("점검 옵션을 선택하세요."); return;}
    if(!dateInput.value){alert("날짜를 선택하세요."); return;}
    if(timeRow.style.display!=="none"){if(!hourSelect.value||!minuteSelect.value){alert("시간 선택"); return;}}
    if(thRow.style.display!=="none"){if(!tempInput.value||!humidityInput.value){alert("온도/습도 입력"); return;}}
    if(productRow.style.display!=="none"){if(!productSelect.value||!countInput.value){alert("제품명/수량 선택"); return;}}

    let entries;
    if(productRow.style.display!=="none"){entries=[{product:productSelect.value,count:countInput.value}];}
    else{entries=[{hour:hourSelect.value,minute:minuteSelect.value,temp:tempInput.value,humi:humidityInput.value,product:productSelect.value||"",count:countInput.value||""}];}

    const payload={date:dateInput.value,group:sel,entries:entries};
    try{
      const res=await fetch(scriptUrl,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'noodle='+encodeURIComponent(JSON.stringify(payload))});
      const text=await res.text();
      alert('서버 응답: '+text);
      location.reload();
    }catch(err){alert('에러: '+(err.message||err));}
  });

});
</script>
</body>
</html>
