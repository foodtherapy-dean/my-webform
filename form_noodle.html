<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>건면공정 모니터링</title>
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
.app-container { display:flex; flex-direction:column; height:100%; }
.app-header { background:#4CAF50; color:#fff; text-align:center; padding:16px; font-size:1.6rem; }
.app-body { flex:1 1 auto; overflow-y:auto; padding:20px; box-sizing:border-box; background:#f9f9f9; }
.app-footer { flex:0 0 auto; }
#submitBtn { width:100%; font-size:1.5rem; padding:20px 0; background:#4CAF50; color:#fff; border:none; cursor:pointer; }
.inline-row { display:flex; gap:20px; margin-top:10px; }
.inline-row > * { flex:1; }
label { display:block; margin-bottom:6px; }
input, select { width:100%; padding:14px 16px; font-size:1.2rem; border:1px solid #ccc; border-radius:6px; }
#duplicateMsg { display:none; background:#ffcccc; color:#900; padding:12px; margin-top:6px; border:1px solid #900; border-radius:6px; font-weight:bold; }
#duplicateMsg button { margin-left:12px; background:#900; color:#fff; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; }
#loadingMsg { display:none; background:#ffe599; color:#333; padding:8px; margin-bottom:10px; border-radius:6px; font-weight:bold; }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">건면공정 점검 입력</div>

  <div class="app-body">
    <!-- 날짜 -->
    <label for="date">날짜</label>
    <input type="date" id="date" required />

    <!-- 점검 옵션 -->
    <label for="group" style="margin-top:20px;">점검 옵션</label>
    <select id="group" required>
      <option value="">선택하세요</option>
      <option value="생산제품">생산제품</option>
      <option value="시스템ON">시스템ON</option>
      <option value="1차점검">1차점검</option>
      <option value="2차점검">2차점검</option>
      <option value="시스템OFF">시스템OFF</option>
    </select>

    <!-- 중복 메시지 -->
    <div id="duplicateMsg">
      <span id="duplicateText"></span>
      <button id="duplicateConfirmBtn">확인</button>
    </div>

    <!-- 로딩 메시지 -->
    <div id="loadingMsg">중복 확인 중...</div>

    <!-- 시간 입력 -->
    <div class="inline-row" id="timeRow">
      <div>
        <label for="hour">시간 (시)</label>
        <select id="hour"></select>
      </div>
      <div>
        <label for="minute">시간 (분)</label>
        <select id="minute"></select>
      </div>
    </div>

    <!-- 온도 / 습도 입력 -->
    <div class="inline-row" id="thRow">
      <div>
        <label for="temp">온도(℃)</label>
        <input type="number" id="temp" step="0.1" min="0" max="100" />
      </div>
      <div>
        <label for="humidity">습도(%)</label>
        <input type="number" id="humidity" step="0.1" min="0" max="100" />
      </div>
    </div>

    <!-- 생산제품 입력 -->
    <div class="inline-row" id="productRow" style="display:none;">
      <div>
        <label for="product">제품명</label>
        <select id="product">
          <option value="">선택하세요</option>
          <option value="일반국수">일반국수</option>
          <option value="치자국수">치자국수</option>
          <option value="메밀국수">메밀국수</option>
        </select>
      </div>
      <div>
        <label for="count">수량</label>
        <input type="number" id="count" min="1" />
      </div>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">📥 서버로 전송</button>
  </div>
</div>

<script>
// ====== 기본 세팅 ======
const dateInput = document.getElementById("date");
const optionSelect = document.getElementById("option");
const hourSelect = document.getElementById("hour");
const minuteSelect = document.getElementById("minute");
const formFields = document.getElementById("form-fields");
const recommendBox = document.getElementById("recommend-box");

dateInput.valueAsDate = new Date();

// ====== 로컬 저장소 (조회된 데이터 캐싱) ======
let loadedData = {};  

// ====== 옵션별 이전 차수 매핑 ======
const prevMap = {
  "1차점검": "시스템ON",
  "2차점검": "1차점검",
  "시스템OFF": "2차점검"
};

// ====== 옵션 클릭 이벤트 ======
optionSelect.addEventListener("change", async () => {
  // 1. 입력창과 추천시간 즉시 숨김
  formFields.style.display = "none";
  recommendBox.style.display = "none";
  recommendBox.textContent = "";

  const date = dateInput.value;
  const option = optionSelect.value;
  if (!date || !option) return;

  try {
    // 2. 서버에 데이터 요청 (현재 차수 포함, 이전 차수까지)
    const response = await fetch(
      `${SCRIPT_URL}?action=getData&date=${encodeURIComponent(date)}`
    );
    const result = await response.json();

    // 3. loadedData 초기화 후 채우기
    loadedData = result || {};

    // 4. 현재 차수 데이터 표시 (있으면 채움)
    if (loadedData[option]) {
      const { hour, minute } = loadedData[option];
      hourSelect.value = hour || "";
      minuteSelect.value = minute || "";
    } else {
      hourSelect.value = "";
      minuteSelect.value = "";
    }

    // 5. 추천시간 계산/표시
    showRecommendTime(option);

    // 6. 입력창 표시
    formFields.style.display = "block";
  } catch (err) {
    console.error("중복확인 오류:", err);
    alert("중복확인 중 오류가 발생했습니다.");
  }
});

// ====== 추천시간 표시 함수 ======
function showRecommendTime(option) {
  recommendBox.style.display = "block";

  // 시스템ON은 추천시간 없음
  if (option === "시스템ON") {
    recommendBox.textContent = "추천시간 없음";
    return;
  }

  const prevOption = prevMap[option];
  const prevData = loadedData[prevOption];

  if (!prevData || !prevData.hour) {
    recommendBox.textContent = `${prevOption} 미입력`;
    return;
  }

  // 시간 계산
  let h = parseInt(prevData.hour, 10);
  let m = parseInt(prevData.minute || "0", 10);

  if (option === "1차점검") {
    h += 4;
  } else if (option === "2차점검") {
    h += 4;
  } else if (option === "시스템OFF") {
    h += 10;
  }

  if (m >= 60) {
    h += Math.floor(m / 60);
    m = m % 60;
  }
  h = h % 24;

  const hh = h.toString().padStart(2, "0");
  const mm = m.toString().padStart(2, "0");

  recommendBox.textContent = `추천시간: ${hh}:${mm}`;
}
</script>

<style>
/* 추천시간 박스 스타일 */
#recommend-box {
  margin-top: 6px;
  padding: 6px 10px;
  border-radius: 6px;
  background: #f9f9f9;
  border: 1px solid #ddd;
  font-size: 14px;
  color: #333;
  display: none;
}
</style>

</body>
</html>
