<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ê±´ë©´ê³µì • ëª¨ë‹ˆí„°ë§</title>
<style>
  :root{--green:#4CAF50;}
  body,html{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;}
  .app-container{display:flex;flex-direction:column;height:100%;}
  .app-header{background:var(--green);color:#fff;padding:16px;text-align:center;font-size:1.25rem;}
  .app-body{flex:1 1 auto;overflow:auto;padding:18px;box-sizing:border-box;background:#f9f9f9;}
  label{display:block;margin-top:12px;margin-bottom:6px;font-weight:600;font-size:0.95rem;}
  input[type="date"], input[type="number"], select, .custom-select .selected-option {
    width:100%; padding:12px 14px; box-sizing:border-box; font-size:1rem;
    border:1px solid #ccc; border-radius:8px; background:#fff;
  }
  .inline-row{display:flex;gap:14px;margin-top:8px;}
  .inline-row>div{flex:1;}
  #duplicateMsg{display:none;background:#fff3f3;color:#900;padding:10px;border:1px solid #900;border-radius:8px;margin-top:10px;font-weight:700;}
  #duplicateMsg button{margin-left:12px;background:#900;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;}
  #loadingMsg{display:none;background:#fff7e0;padding:8px;border-radius:8px;margin-top:10px;font-weight:700;color:#333;}
  .custom-select{position:relative;width:100%;}
  .custom-select .selected-option{cursor:pointer;border-radius:8px;}
  .custom-select ul.options{
    position:absolute; left:0; right:0; top:100%; margin:8px 0 0 0; padding:0; list-style:none;
    border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.12); background:#fff; border:1px solid #ddd;
    z-index:2000; display:none;
  }
  .custom-select.open ul.options{display:block;}
  .custom-select ul.options li{padding:12px 14px; cursor:pointer; font-size:1rem; border-bottom:1px solid #f0f0f0;}
  .custom-select ul.options li:last-child{border-bottom:none;}
  .custom-select ul.options li:hover{background:var(--green);color:#fff;}
  @media (max-width:480px){
    .custom-select ul.options{margin:6px 0 0 0;}
    .custom-select ul.options li{padding:14px 16px;}
  }
  #recommended { margin-top:6px; font-weight:700; color:var(--green); min-height:20px; }
  .app-footer{padding:12px;}
  #submitBtn{width:100%;padding:14px 16px;font-size:1.05rem;background:var(--green);color:#fff;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ê±´ë©´ê³µì • ì ê²€ ì…ë ¥</div>

  <div class="app-body">
    <label for="date">ë‚ ì§œ</label>
    <input id="date" type="date" />

    <label for="group">ì ê²€ ì˜µì…˜</label>
    <div class="custom-select" id="customGroup">
      <div class="selected-option">ì„ íƒí•˜ì„¸ìš”</div>
      <ul class="options" role="listbox" aria-label="ì ê²€ ì˜µì…˜"></ul>
    </div>

    

    <div id="duplicateMsg"><span id="duplicateText"></span><button id="duplicateConfirmBtn" type="button">í™•ì¸</button></div>
    <div id="loadingMsg">ì¤‘ë³µ í™•ì¸ ì¤‘...</div>

    <div class="inline-row" id="timeRow" style="display:none;">
      <div>
        <label for="hour">ì‹œê°„ (ì‹œ)</label>
        <select id="hour" aria-label="ì‹œê°„ ì‹œ"></select>
      </div>
      <div>
        <label for="minute">ì‹œê°„ (ë¶„)</label>
        <select id="minute" aria-label="ì‹œê°„ ë¶„"></select>
      </div>
    </div>
    <div id="recommended"></div>

    <div class="inline-row" id="thRow" style="display:none;">
      <div>
        <label for="temp">ì˜¨ë„(â„ƒ)</label>
        <input id="temp" type="number" step="0.1" min="0" max="100" />
      </div>
      <div>
        <label for="humidity">ìŠµë„(%)</label>
        <input id="humidity" type="number" step="0.1" min="0" max="100" />
      </div>
    </div>

    <div class="inline-row" id="productRow" style="display:none;">
      <div>
        <label for="product">ì œí’ˆëª…</label>
        <select id="product">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          <option value="ì¼ë°˜êµ­ìˆ˜">ì¼ë°˜êµ­ìˆ˜</option>
          <option value="ì¹˜ìêµ­ìˆ˜">ì¹˜ìêµ­ìˆ˜</option>
          <option value="ë©”ë°€êµ­ìˆ˜">ë©”ë°€êµ­ìˆ˜</option>
        </select>
      </div>
      <div>
        <label for="count">ìˆ˜ëŸ‰</label>
        <input id="count" type="number" min="1" />
      </div>
    </div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ“¥ ì„œë²„ë¡œ ì „ì†¡</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const scriptUrl = "https://script.google.com/macros/s/AKfycbwTDib5h0YwBWyZjgT-r4NkcD2yzXSmx3TCITQed4v3WNmqE0Lx5zZQkWbTTS8MLdouIg/exec";

  const dateInput = document.getElementById('date');
  const customGroup = document.getElementById('customGroup');
  const selectedDiv = customGroup.querySelector('.selected-option');
  const optionsList = customGroup.querySelector('.options');
  const recommendedDiv = document.getElementById('recommended');
  const duplicateMsg = document.getElementById('duplicateMsg');
  const duplicateText = document.getElementById('duplicateText');
  const duplicateConfirmBtn = document.getElementById('duplicateConfirmBtn');
  const loadingMsg = document.getElementById('loadingMsg');
  const timeRow = document.getElementById('timeRow');
  const hourSelect = document.getElementById('hour');
  const minuteSelect = document.getElementById('minute');
  const thRow = document.getElementById('thRow');
  const tempInput = document.getElementById('temp');
  const humidityInput = document.getElementById('humidity');
  const productRow = document.getElementById('productRow');
  const productSelect = document.getElementById('product');
  const countInput = document.getElementById('count');
  const submitBtn = document.getElementById('submitBtn');

  const optionItems = ["ìƒì‚°ì œí’ˆ","ì‹œìŠ¤í…œON","1ì°¨ì ê²€","2ì°¨ì ê²€","ì‹œìŠ¤í…œOFF"];
  const orderMap = ["ì‹œìŠ¤í…œON","1ì°¨ì ê²€","2ì°¨ì ê²€","ì‹œìŠ¤í…œOFF"];
  let loadedData = {};
  let optionsLoadedForDate = null;

  dateInput.valueAsDate = new Date();

  function fillTimeOptions(){
    hourSelect.innerHTML = '<option value=""></option>';
    for(let h=1; h<=24; h++){ hourSelect.innerHTML += `<option value="${String(h).padStart(2,"0")}">${String(h).padStart(2,"0")}</option>`; }
    minuteSelect.innerHTML = '<option value=""></option>';
    for(let m=0; m<60; m+=10){ minuteSelect.innerHTML += `<option value="${String(m).padStart(2,"0")}">${String(m).padStart(2,"0")}</option>`; }
  }
  fillTimeOptions();

  function renderOptions(existing=[]){
    optionsList.innerHTML = "";
    optionItems.forEach(opt=>{
      const li = document.createElement('li');
      li.dataset.value = opt;
      li.textContent = existing.includes(opt) ? `${opt}(ì™„ë£Œ)` : opt;
      optionsList.appendChild(li);
    });
  }

  async function updateOptionCompletion(dateVal){
    if(!dateVal){ renderOptions([]); optionsLoadedForDate = null; return; }
    try{
      const query = encodeURIComponent(JSON.stringify({date: dateVal}));
      const res = await fetch(`${scriptUrl}?getNoodle=${query}`);
      const data = res.ok ? await res.json() : {};
      const existing = data.options || [];
      optionsLoadedForDate = dateVal;
      renderOptions(existing);
    } catch(err){
      console.error("updateOptionCompletion error", err);
      renderOptions([]);
    }
  }

  function applyGroupDataToInputs(d){
    if(!d){ hourSelect.value=""; minuteSelect.value=""; tempInput.value=""; humidityInput.value=""; productSelect.value=""; countInput.value=""; return; }
    hourSelect.value = d.hour ? String(d.hour).padStart(2,'0') : "";
    minuteSelect.value = d.minute ? String(d.minute).padStart(2,'0') : "";
    tempInput.value = d.temp || "";
    humidityInput.value = d.humi || "";
    productSelect.value = d.product || "";
    countInput.value = d.count || "";
  }

  async function checkDuplicate(date, group, internal=false){
    if(!date || !group) return {ok:false};
    try{
      const res = await fetch(`${scriptUrl}?checkNoodle=` + encodeURIComponent(JSON.stringify({date,group})));
      const data = await res.json();
      const exists = Boolean(data.exists);
      const dat = data.data || null;
      loadedData[group] = { fetched:true, exists: exists, data: dat };
      if(!internal){
        if(exists){
          applyGroupDataToInputs(dat);
          duplicateText.textContent = `âš ï¸ ì´ë¯¸ ê°™ì€ ë‚ ì§œ(${date})ì™€ ì˜µì…˜(${group}) ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.`;
          duplicateMsg.style.display = "block";
        } else {
          duplicateMsg.style.display = "none";
        }
      }
      return {ok:true, exists, data: dat};
    } catch(err){
      console.error("checkDuplicate error", err);
      if(!internal){
        duplicateText.textContent = "ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜!";
        duplicateMsg.style.display = "block";
      }
      return {ok:false};
    }
  }

  function fmtHourWrap(n){ const v = (((Number(n)||0)-1)%24+24)%24+1; return String(v).padStart(2,'0'); }

  function updateSuggestion(selected){
    const sel = selected || (selectedDiv.dataset.value || "");
    if(!sel){ recommendedDiv.textContent = ""; return; }
    let out = "";
    if(sel === "1ì°¨ì ê²€"){
      const sys = loadedData["ì‹œìŠ¤í…œON"];
      out = (sys && sys.data && sys.data.hour) ? `ì¶”ì²œ: ${fmtHourWrap(Number(sys.data.hour)+7)}ì‹œ` : "ì‹œìŠ¤í…œON ë¯¸ì…ë ¥";
    } else if(sel === "2ì°¨ì ê²€"){
      const first = loadedData["1ì°¨ì ê²€"];
      out = (first && first.data && first.data.hour) ? `ì¶”ì²œ: ${fmtHourWrap(Number(first.data.hour)+1)}ì‹œ` : "1ì°¨ì ê²€ ë¯¸ì…ë ¥";
    } else if(sel === "ì‹œìŠ¤í…œOFF"){
      const second = loadedData["2ì°¨ì ê²€"];
      if(!second || !second.data || !second.data.hour){ out = "2ì°¨ì ê²€ ë¯¸ì…ë ¥"; }
      else {
        const sys = loadedData["ì‹œìŠ¤í…œON"];
        out = (sys && sys.data && sys.data.hour) ? `ì¶”ì²œ: ${fmtHourWrap(Number(sys.data.hour)+10)}ì‹œ` : "ì‹œìŠ¤í…œON ë¯¸ì…ë ¥";
      }
    }
    recommendedDiv.textContent = out ? ` ${out}` : "";
  }

  function updateInputFields(selected){
    const sel = selected || (selectedDiv.dataset.value || "");
    if(sel === "ì‹œìŠ¤í…œON" || sel === "ì‹œìŠ¤í…œOFF"){ timeRow.style.display = "flex"; thRow.style.display = "none"; productRow.style.display = "none"; }
    else if(sel === "1ì°¨ì ê²€" || sel === "2ì°¨ì ê²€"){ timeRow.style.display = "flex"; thRow.style.display = "flex"; productRow.style.display = "none"; }
    else if(sel === "ìƒì‚°ì œí’ˆ"){ timeRow.style.display = "none"; thRow.style.display = "none"; productRow.style.display = "flex"; }
    else { timeRow.style.display = "none"; thRow.style.display = "none"; productRow.style.display = "none"; }
  }

  duplicateConfirmBtn.addEventListener('click', ()=> { duplicateMsg.style.display = "none"; });
  renderOptions([]);

  // ì ê²€ì˜µì…˜ í´ë¦­ ì´ë²¤íŠ¸
  customGroup.addEventListener('click', (e) => {
    if(e.target.classList.contains('selected-option')){
      // í´ë¦­ ì‹œ loading í‘œì‹œ í›„ ì¤‘ë³µ í™•ì¸
      const dateVal = dateInput.value;
      if(!dateVal) return;
      loadingMsg.style.display = "block";
      optionsList.innerHTML = ""; // ì˜µì…˜ ìˆ¨ê¹€
      (async ()=>{
        // ë‚ ì§œ ê¸°ì¤€ ìºì‹œ í™•ì¸
        if(optionsLoadedForDate !== dateVal){
          await updateOptionCompletion(dateVal);
        }
        // ëª¨ë“  ì˜µì…˜ ì¤‘ë³µ ì²´í¬ ë³‘ë ¬
        const promises = orderMap.map(opt => checkDuplicate(dateVal, opt, true));
        await Promise.all(promises);
        // ì™„ë£Œ ì—¬ë¶€ í‘œì‹œ
        renderOptions(orderMap.filter(opt=>loadedData[opt]?.exists));
        loadingMsg.style.display = "none";
        customGroup.classList.add('open');
      })();
      return;
    }

    // LI ì„ íƒ ì‹œ
    if(e.target.tagName === 'LI'){
      const value = e.target.dataset.value;
      selectedDiv.textContent = e.target.textContent;
      selectedDiv.dataset.value = value;

      (async ()=>{
        duplicateMsg.style.display = "none";
        duplicateText.textContent = "";
        applyGroupDataToInputs(null);
        await checkDuplicate(dateInput.value, value, false);
        updateInputFields(value);
        updateSuggestion(value);
      })();
    }
  });

  document.addEventListener('click', (e)=>{ if(!customGroup.contains(e.target)) customGroup.classList.remove('open'); });
  document.addEventListener('keydown', (e) => { if(e.key === 'Escape') customGroup.classList.remove('open'); });

  dateInput.addEventListener('change', async ()=>{
    selectedDiv.textContent = "ì„ íƒí•˜ì„¸ìš”"; selectedDiv.dataset.value = "";
    duplicateMsg.style.display = "none"; duplicateText.textContent = "";
    applyGroupDataToInputs(null);
    recommendedDiv.textContent = "";
    loadedData = {}; optionsLoadedForDate = null; updateInputFields();
    await updateOptionCompletion(dateInput.value);
  });

  hourSelect.addEventListener('change', ()=>{
    const sel = selectedDiv.dataset.value || "";
    if(sel){
      if(!loadedData[sel]) loadedData[sel] = { fetched:false, exists:false, data: {} };
      loadedData[sel].data = loadedData[sel].data || {};
      loadedData[sel].data.hour = hourSelect.value ? parseInt(hourSelect.value,10) : null;
    }
    updateSuggestion(sel);
  });

  submitBtn.addEventListener('click', async ()=>{
    const sel = selectedDiv.dataset.value || "";
    if(!sel){ alert("ì ê²€ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
    if(!dateInput.value){ alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
    if(timeRow.style.display !== "none"){ if(!hourSelect.value){ alert("ì‹œê°„(ì‹œ) ì„ íƒ"); return; } if(!minuteSelect.value){ alert("ì‹œê°„(ë¶„) ì„ íƒ"); return; } }
    if(thRow.style.display !== "none"){ if(!tempInput.value){ alert("ì˜¨ë„ ì…ë ¥"); return; } if(!humidityInput.value){ alert("ìŠµë„ ì…ë ¥"); return; } }
    if(productRow.style.display !== "none"){ if(!productSelect.value){ alert("ì œí’ˆëª… ì„ íƒ"); return; } if(!countInput.value){ alert("ìˆ˜ëŸ‰ ì…ë ¥"); return; } }

    let entries;
    if(productRow.style.display !== "none"){
      entries = [{ product: productSelect.value, count: countInput.value }];
    } else {
      entries = [{ hour: hourSelect.value, minute: minuteSelect.value, temp: tempInput.value, humi: humidityInput.value, product: productSelect.value || "", count: countInput.value || "" }];
    }
    const payload = { date: dateInput.value, group: sel, entries: entries };
    try{
      const res = await fetch(scriptUrl, { method:"POST", body: JSON.stringify({ noodle: payload }) });
      const txt = await res.text();
      alert("âœ… ì„œë²„ ì‘ë‹µ: " + txt);
      await updateOptionCompletion(dateInput.value);
    } catch(err){ alert("âŒ ì„œë²„ ì „ì†¡ ì˜¤ë¥˜: " + err.message); }
  });

  updateOptionCompletion(dateInput.value);
});
</script>

</body>
</html>
