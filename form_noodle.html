<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>점검 웹폼</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    label { display: inline-block; width: 100px; }
    .row { margin: 8px 0; }
    .hidden { display: none; }
    #duplicateMsg { color: red; margin: 10px 0; }
    #recommended { color: blue; margin: 10px 0; }
  </style>
</head>
<body>
  <h2>점검 입력</h2>
  
  <div class="row">
    <label>날짜</label>
    <input type="date" id="date">
  </div>

  <div class="row">
    <label>점검옵션</label>
    <select id="group">
      <option value="">-- 선택 --</option>
      <option value="시스템ON">시스템ON</option>
      <option value="1차점검">1차점검</option>
      <option value="2차점검">2차점검</option>
      <option value="시스템OFF">시스템OFF</option>
    </select>
  </div>

  <div id="duplicateMsg" class="hidden">
    <span id="duplicateText"></span>
  </div>

  <div id="recommended"></div>

  <!-- 시간 -->
  <div class="row hidden" id="timeRow">
    <label>시간</label>
    <select id="hour"></select>시
    <select id="minute"></select>분
  </div>

  <!-- 온도/습도 -->
  <div class="row hidden" id="thRow">
    <label>온도</label>
    <input type="number" id="temp" step="0.1"> ℃
    <label>습도</label>
    <input type="number" id="humidity" step="0.1"> %
  </div>

  <!-- 제품/수량 -->
  <div class="row hidden" id="productRow">
    <label>제품</label>
    <select id="product">
      <option value="">-- 선택 --</option>
      <option value="라면">라면</option>
      <option value="우동">우동</option>
      <option value="파스타">파스타</option>
    </select>
    <label>수량</label>
    <input type="number" id="count">
  </div>

  <div class="row">
    <button id="saveBtn">저장</button>
  </div>

<script>
const dateInput = document.getElementById("date");
const groupSelect = document.getElementById("group");
const duplicateMsg = document.getElementById("duplicateMsg");
const duplicateText = document.getElementById("duplicateText");
const recommendedDiv = document.getElementById("recommended");
const timeRow = document.getElementById("timeRow");
const thRow = document.getElementById("thRow");
const productRow = document.getElementById("productRow");
const hourSelect = document.getElementById("hour");
const minuteSelect = document.getElementById("minute");
const tempInput = document.getElementById("temp");
const humidityInput = document.getElementById("humidity");
const productSelect = document.getElementById("product");
const countInput = document.getElementById("count");

// 기본 날짜 = 오늘
dateInput.valueAsDate = new Date();

// 시/분 드롭다운 채우기
for(let h=0; h<24; h++){
  hourSelect.add(new Option(h, h));
}
for(let m=0; m<60; m+=10){
  minuteSelect.add(new Option(m, m));
}

// 데이터 캐시
let loadedData = {};
let lastSystemOnHour = null;
let lastFirstCheckHour = null;
let currentGroup = null;
const orderMap = ["시스템ON","1차점검","2차점검","시스템OFF"];

// ====== 서버 중복체크 (예시 더미) ======
async function checkDuplicate(date, option){
  // 👉 실제는 fetch 호출
  return new Promise(resolve=>{
    setTimeout(()=>{
      // 예시: 임의로 일부 데이터 제공
      let data = null;
      if(option==="시스템ON") data = {hour:8,minute:0,temp:22,humidity:40};
      if(option==="1차점검") data = {hour:15,minute:0};
      resolve(data);
    },300);
  });
}

// ====== 추천시간 계산 ======
function updateSuggestion(){
  let recHour = null;
  if(currentGroup==="1차점검"){
    if(lastSystemOnHour!==null){
      recHour = lastSystemOnHour + 7;
    } else {
      recommendedDiv.textContent="시스템ON 미입력";
      return;
    }
  }
  if(currentGroup==="2차점검"){
    if(lastFirstCheckHour!==null){
      recHour = lastFirstCheckHour + 1;
    } else {
      recommendedDiv.textContent="1차점검 미입력";
      return;
    }
  }
  if(currentGroup==="시스템OFF"){
    if(lastSystemOnHour!==null){
      recHour = lastSystemOnHour + 10;
    } else {
      recommendedDiv.textContent="시스템ON 미입력";
      return;
    }
  }
  if(recHour!==null){
    recHour = ((recHour-1)%24)+1;
    recommendedDiv.textContent=`추천: ${recHour}시`;
  } else {
    recommendedDiv.textContent="";
  }
}

// ====== 입력창 업데이트 ======
function updateInputFields(){
  timeRow.style.display="none";
  thRow.style.display="none";
  productRow.style.display="none";

  if(!currentGroup) return;
  timeRow.style.display="block";

  if(currentGroup==="시스템ON"){
    thRow.style.display="block";
  }
  if(currentGroup==="시스템OFF"){
    productRow.style.display="block";
  }
}

// ====== 옵션 상태 업데이트 ======
async function updateOptionCompletion(date){
  for(const opt of orderMap){
    const data = await checkDuplicate(date,opt);
    if(data){
      loadedData[opt] = data;
      const optionEl = [...groupSelect.options].find(o=>o.value===opt);
      if(optionEl && !optionEl.text.includes("(완료)")){
        optionEl.text = opt+" (완료)";
      }
    }
  }
}

// ====== 이벤트 ======

// 옵션 클릭시: 먼저 중복체크 완료 후 드롭다운 열기
groupSelect.addEventListener("mousedown", async (e)=>{
  e.preventDefault();
  await updateOptionCompletion(dateInput.value);
  if(groupSelect.showPicker){ groupSelect.showPicker(); }
  else { groupSelect.focus(); }
});

// 옵션 변경시
groupSelect.addEventListener("change", async ()=>{
  // 입력창 먼저 닫기
  timeRow.style.display="none";
  thRow.style.display="none";
  productRow.style.display="none";
  hourSelect.value=""; minuteSelect.value="";
  tempInput.value=""; humidityInput.value="";
  productSelect.value=""; countInput.value="";

  duplicateMsg.classList.add("hidden");
  duplicateText.textContent="";

  currentGroup = groupSelect.value;
  if(!currentGroup) return;

  const data = await checkDuplicate(dateInput.value, currentGroup);
  if(data){
    loadedData[currentGroup] = data;
    // 값 채우기
    if(data.hour!==undefined) hourSelect.value=data.hour;
    if(data.minute!==undefined) minuteSelect.value=data.minute;
    if(data.temp!==undefined) tempInput.value=data.temp;
    if(data.humidity!==undefined) humidityInput.value=data.humidity;
    if(data.product!==undefined) productSelect.value=data.product;
    if(data.count!==undefined) countInput.value=data.count;

    if(currentGroup==="시스템ON") lastSystemOnHour = data.hour;
    if(currentGroup==="1차점검") lastFirstCheckHour = data.hour;
  }
  updateInputFields();
  updateSuggestion();
});

// 시간 변경시 추천시간 갱신
hourSelect.addEventListener("change",()=>{
  const val=parseInt(hourSelect.value);
  if(currentGroup==="시스템ON") lastSystemOnHour=val;
  if(currentGroup==="1차점검") lastFirstCheckHour=val;
  updateSuggestion();
});
</script>
</body>
</html>
