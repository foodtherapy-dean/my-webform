<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì ê²€ ì›¹í¼</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    label { display: inline-block; width: 100px; }
    .row { margin: 8px 0; }
    .hidden { display: none; }
    #duplicateMsg { color: red; margin: 10px 0; }
    #recommended { color: blue; margin: 10px 0; }
  </style>
</head>
<body>
  <h2>ì ê²€ ì…ë ¥</h2>
  
  <div class="row">
    <label>ë‚ ì§œ</label>
    <input type="date" id="date">
  </div>

  <div class="row">
    <label>ì ê²€ì˜µì…˜</label>
    <select id="group">
      <option value="">-- ì„ íƒ --</option>
      <option value="ì‹œìŠ¤í…œON">ì‹œìŠ¤í…œON</option>
      <option value="1ì°¨ì ê²€">1ì°¨ì ê²€</option>
      <option value="2ì°¨ì ê²€">2ì°¨ì ê²€</option>
      <option value="ì‹œìŠ¤í…œOFF">ì‹œìŠ¤í…œOFF</option>
    </select>
  </div>

  <div id="duplicateMsg" class="hidden">
    <span id="duplicateText"></span>
  </div>

  <div id="recommended"></div>

  <!-- ì‹œê°„ -->
  <div class="row hidden" id="timeRow">
    <label>ì‹œê°„</label>
    <select id="hour"></select>ì‹œ
    <select id="minute"></select>ë¶„
  </div>

  <!-- ì˜¨ë„/ìŠµë„ -->
  <div class="row hidden" id="thRow">
    <label>ì˜¨ë„</label>
    <input type="number" id="temp" step="0.1"> â„ƒ
    <label>ìŠµë„</label>
    <input type="number" id="humidity" step="0.1"> %
  </div>

  <!-- ì œí’ˆ/ìˆ˜ëŸ‰ -->
  <div class="row hidden" id="productRow">
    <label>ì œí’ˆ</label>
    <select id="product">
      <option value="">-- ì„ íƒ --</option>
      <option value="ë¼ë©´">ë¼ë©´</option>
      <option value="ìš°ë™">ìš°ë™</option>
      <option value="íŒŒìŠ¤íƒ€">íŒŒìŠ¤íƒ€</option>
    </select>
    <label>ìˆ˜ëŸ‰</label>
    <input type="number" id="count">
  </div>

  <div class="row">
    <button id="saveBtn">ì €ì¥</button>
  </div>

<script>
const dateInput = document.getElementById("date");
const groupSelect = document.getElementById("group");
const duplicateMsg = document.getElementById("duplicateMsg");
const duplicateText = document.getElementById("duplicateText");
const recommendedDiv = document.getElementById("recommended");
const timeRow = document.getElementById("timeRow");
const thRow = document.getElementById("thRow");
const productRow = document.getElementById("productRow");
const hourSelect = document.getElementById("hour");
const minuteSelect = document.getElementById("minute");
const tempInput = document.getElementById("temp");
const humidityInput = document.getElementById("humidity");
const productSelect = document.getElementById("product");
const countInput = document.getElementById("count");

// ê¸°ë³¸ ë‚ ì§œ = ì˜¤ëŠ˜
dateInput.valueAsDate = new Date();

// ì‹œ/ë¶„ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
for(let h=0; h<24; h++){
  hourSelect.add(new Option(h, h));
}
for(let m=0; m<60; m+=10){
  minuteSelect.add(new Option(m, m));
}

// ë°ì´í„° ìºì‹œ
let loadedData = {};
let lastSystemOnHour = null;
let lastFirstCheckHour = null;
let currentGroup = null;
const orderMap = ["ì‹œìŠ¤í…œON","1ì°¨ì ê²€","2ì°¨ì ê²€","ì‹œìŠ¤í…œOFF"];

// ====== ì„œë²„ ì¤‘ë³µì²´í¬ (ì˜ˆì‹œ ë”ë¯¸) ======
async function checkDuplicate(date, option){
  // ğŸ‘‰ ì‹¤ì œëŠ” fetch í˜¸ì¶œ
  return new Promise(resolve=>{
    setTimeout(()=>{
      // ì˜ˆì‹œ: ì„ì˜ë¡œ ì¼ë¶€ ë°ì´í„° ì œê³µ
      let data = null;
      if(option==="ì‹œìŠ¤í…œON") data = {hour:8,minute:0,temp:22,humidity:40};
      if(option==="1ì°¨ì ê²€") data = {hour:15,minute:0};
      resolve(data);
    },300);
  });
}

// ====== ì¶”ì²œì‹œê°„ ê³„ì‚° ======
function updateSuggestion(){
  let recHour = null;
  if(currentGroup==="1ì°¨ì ê²€"){
    if(lastSystemOnHour!==null){
      recHour = lastSystemOnHour + 7;
    } else {
      recommendedDiv.textContent="ì‹œìŠ¤í…œON ë¯¸ì…ë ¥";
      return;
    }
  }
  if(currentGroup==="2ì°¨ì ê²€"){
    if(lastFirstCheckHour!==null){
      recHour = lastFirstCheckHour + 1;
    } else {
      recommendedDiv.textContent="1ì°¨ì ê²€ ë¯¸ì…ë ¥";
      return;
    }
  }
  if(currentGroup==="ì‹œìŠ¤í…œOFF"){
    if(lastSystemOnHour!==null){
      recHour = lastSystemOnHour + 10;
    } else {
      recommendedDiv.textContent="ì‹œìŠ¤í…œON ë¯¸ì…ë ¥";
      return;
    }
  }
  if(recHour!==null){
    recHour = ((recHour-1)%24)+1;
    recommendedDiv.textContent=`ì¶”ì²œ: ${recHour}ì‹œ`;
  } else {
    recommendedDiv.textContent="";
  }
}

// ====== ì…ë ¥ì°½ ì—…ë°ì´íŠ¸ ======
function updateInputFields(){
  timeRow.style.display="none";
  thRow.style.display="none";
  productRow.style.display="none";

  if(!currentGroup) return;
  timeRow.style.display="block";

  if(currentGroup==="ì‹œìŠ¤í…œON"){
    thRow.style.display="block";
  }
  if(currentGroup==="ì‹œìŠ¤í…œOFF"){
    productRow.style.display="block";
  }
}

// ====== ì˜µì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ ======
async function updateOptionCompletion(date){
  for(const opt of orderMap){
    const data = await checkDuplicate(date,opt);
    if(data){
      loadedData[opt] = data;
      const optionEl = [...groupSelect.options].find(o=>o.value===opt);
      if(optionEl && !optionEl.text.includes("(ì™„ë£Œ)")){
        optionEl.text = opt+" (ì™„ë£Œ)";
      }
    }
  }
}

// ====== ì´ë²¤íŠ¸ ======

// ì˜µì…˜ í´ë¦­ì‹œ: ë¨¼ì € ì¤‘ë³µì²´í¬ ì™„ë£Œ í›„ ë“œë¡­ë‹¤ìš´ ì—´ê¸°
groupSelect.addEventListener("mousedown", async (e)=>{
  e.preventDefault();
  await updateOptionCompletion(dateInput.value);
  if(groupSelect.showPicker){ groupSelect.showPicker(); }
  else { groupSelect.focus(); }
});

// ì˜µì…˜ ë³€ê²½ì‹œ
groupSelect.addEventListener("change", async ()=>{
  // ì…ë ¥ì°½ ë¨¼ì € ë‹«ê¸°
  timeRow.style.display="none";
  thRow.style.display="none";
  productRow.style.display="none";
  hourSelect.value=""; minuteSelect.value="";
  tempInput.value=""; humidityInput.value="";
  productSelect.value=""; countInput.value="";

  duplicateMsg.classList.add("hidden");
  duplicateText.textContent="";

  currentGroup = groupSelect.value;
  if(!currentGroup) return;

  const data = await checkDuplicate(dateInput.value, currentGroup);
  if(data){
    loadedData[currentGroup] = data;
    // ê°’ ì±„ìš°ê¸°
    if(data.hour!==undefined) hourSelect.value=data.hour;
    if(data.minute!==undefined) minuteSelect.value=data.minute;
    if(data.temp!==undefined) tempInput.value=data.temp;
    if(data.humidity!==undefined) humidityInput.value=data.humidity;
    if(data.product!==undefined) productSelect.value=data.product;
    if(data.count!==undefined) countInput.value=data.count;

    if(currentGroup==="ì‹œìŠ¤í…œON") lastSystemOnHour = data.hour;
    if(currentGroup==="1ì°¨ì ê²€") lastFirstCheckHour = data.hour;
  }
  updateInputFields();
  updateSuggestion();
});

// ì‹œê°„ ë³€ê²½ì‹œ ì¶”ì²œì‹œê°„ ê°±ì‹ 
hourSelect.addEventListener("change",()=>{
  const val=parseInt(hourSelect.value);
  if(currentGroup==="ì‹œìŠ¤í…œON") lastSystemOnHour=val;
  if(currentGroup==="1ì°¨ì ê²€") lastFirstCheckHour=val;
  updateSuggestion();
});
</script>
</body>
</html>
