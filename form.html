<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í•´ì¶© ì ê²€ ì…ë ¥</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 600px; margin: auto; }
    label, select, input { display: block; margin: 10px 0; width: 100%; }
    .category-block { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>

  <h2>í•´ì¶© ì ê²€ ì…ë ¥</h2>

  <label for="date">ë‚ ì§œ</label>
  <input type="date" id="date" required>

  <label for="group">êµ¬ì—­</label>
  <select id="group" required>
    <option value="">-- ì„ íƒ --</option>
    <option value="ê±´ë©´ë™">ê±´ë©´ë™</option>
    <option value="ìƒë©´ë™">ìƒë©´ë™</option>
  </select>

  <div id="categories">
    <div class="category-block">
      <label>ì¹´í…Œê³ ë¦¬: í¬ì¶©ë“±(ì…êµ¬)</label>
      <input type="number" placeholder="íŒŒë¦¬" data-category="í¬ì¶©ë“±(ì…êµ¬)" data-subcategory="íŒŒë¦¬">
      <input type="number" placeholder="ë‚˜ë°©" data-category="í¬ì¶©ë“±(ì…êµ¬)" data-subcategory="ë‚˜ë°©">
    </div>
    <!-- í•„ìš”ì‹œ ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ ë¸”ë¡ ì¶”ê°€ -->
  </div>

  <button id="saveBtn">ì €ì¥</button>

  <p id="statusMessage"></p>

  <script>
    const serverUrl = "https://script.google.com/macros/s/AKfycbxPop9R_o9wIyfq1-fFV1LBkkKMBJYxoEj5dA3e8r_e_Jj2ktuNAR8qo1FwA2Hk8iJUvA/exec";

    const dateInput = document.getElementById("date");
    const groupSelect = document.getElementById("group");
    const statusMessage = document.getElementById("statusMessage");
    const saveBtn = document.getElementById("saveBtn");

    const inputs = document.querySelectorAll("input[data-category]");

    function showMessage(msg, isError = false) {
      statusMessage.textContent = msg;
      statusMessage.style.color = isError ? "red" : "green";
    }

    // âœ… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadData() {
      const date = dateInput.value;
      const group = groupSelect.value;
      if (!date || !group) return;

      showMessage("ğŸ“¦ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");

      try {
        const response = await fetch(`${serverUrl}?action=load&date=${encodeURIComponent(date)}&group_name=${encodeURIComponent(group)}`);
        const result = await response.json();

        if (Array.isArray(result.rows)) {
          inputs.forEach(input => {
            const cat = input.dataset.category;
            const sub = input.dataset.subcategory;
            const row = result.rows.find(r => r.category === cat && r.subcategory === sub);
            input.value = row ? row.value : "";
          });
          showMessage("âœ… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
        } else {
          showMessage("ğŸ“­ ë°ì´í„° ì—†ìŒ");
          inputs.forEach(input => input.value = "");
        }
      } catch (err) {
        showMessage("âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + err.message, true);
      }
    }

    // âœ… ì €ì¥
    async function saveData() {
      const date = dateInput.value;
      const group = groupSelect.value;
      if (!date || !group) {
        showMessage("â— ë‚ ì§œì™€ êµ¬ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”", true);
        return;
      }

      const data = Array.from(inputs).map(input => ({
        date,
        group_name: group,
        category: input.dataset.category,
        subcategory: input.dataset.subcategory,
        value: input.value || "0"
      }));

      showMessage("ğŸ“¤ ì €ì¥ ì¤‘...");

      try {
        const response = await fetch(serverUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data })
        });

        const result = await response.text();
        showMessage("âœ… ì €ì¥ ì™„ë£Œ: " + result);
      } catch (err) {
        showMessage("âŒ ì €ì¥ ì‹¤íŒ¨: " + err.message, true);
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    dateInput.addEventListener("change", loadData);
    groupSelect.addEventListener("change", loadData);
    saveBtn.addEventListener("click", saveData);
  </script>

</body>
</html>
