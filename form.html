<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>해충 점검 입력</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 10px; max-width: 600px; margin: auto; }
    label, select, input { display: block; margin: 10px 0; width: 100%; }
    .category-block { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>

  <h2>해충 점검 입력</h2>

  <label for="date">날짜</label>
  <input type="date" id="date" required>

  <label for="group">구역</label>
  <select id="group" required>
    <option value="">-- 선택 --</option>
    <option value="건면동">건면동</option>
    <option value="생면동">생면동</option>
  </select>

  <div id="categories">
    <div class="category-block">
      <label>카테고리: 포충등(입구)</label>
      <input type="number" placeholder="파리" data-category="포충등(입구)" data-subcategory="파리">
      <input type="number" placeholder="나방" data-category="포충등(입구)" data-subcategory="나방">
    </div>
    <!-- 필요시 다른 카테고리 블록 추가 -->
  </div>

  <button id="saveBtn">저장</button>

  <p id="statusMessage"></p>

  <script>
    const serverUrl = "https://script.google.com/macros/s/AKfycbxPop9R_o9wIyfq1-fFV1LBkkKMBJYxoEj5dA3e8r_e_Jj2ktuNAR8qo1FwA2Hk8iJUvA/exec";

    const dateInput = document.getElementById("date");
    const groupSelect = document.getElementById("group");
    const statusMessage = document.getElementById("statusMessage");
    const saveBtn = document.getElementById("saveBtn");

    const inputs = document.querySelectorAll("input[data-category]");

    function showMessage(msg, isError = false) {
      statusMessage.textContent = msg;
      statusMessage.style.color = isError ? "red" : "green";
    }

    // ✅ 데이터 불러오기
    async function loadData() {
      const date = dateInput.value;
      const group = groupSelect.value;
      if (!date || !group) return;

      showMessage("📦 데이터 불러오는 중...");

      try {
        const response = await fetch(`${serverUrl}?action=load&date=${encodeURIComponent(date)}&group_name=${encodeURIComponent(group)}`);
        const result = await response.json();

        if (Array.isArray(result.rows)) {
          inputs.forEach(input => {
            const cat = input.dataset.category;
            const sub = input.dataset.subcategory;
            const row = result.rows.find(r => r.category === cat && r.subcategory === sub);
            input.value = row ? row.value : "";
          });
          showMessage("✅ 데이터 불러오기 완료");
        } else {
          showMessage("📭 데이터 없음");
          inputs.forEach(input => input.value = "");
        }
      } catch (err) {
        showMessage("❌ 데이터 로드 실패: " + err.message, true);
      }
    }

    // ✅ 저장
    async function saveData() {
      const date = dateInput.value;
      const group = groupSelect.value;
      if (!date || !group) {
        showMessage("❗ 날짜와 구역을 선택해주세요", true);
        return;
      }

      const data = Array.from(inputs).map(input => ({
        date,
        group_name: group,
        category: input.dataset.category,
        subcategory: input.dataset.subcategory,
        value: input.value || "0"
      }));

      showMessage("📤 저장 중...");

      try {
        const response = await fetch(serverUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data })
        });

        const result = await response.text();
        showMessage("✅ 저장 완료: " + result);
      } catch (err) {
        showMessage("❌ 저장 실패: " + err.message, true);
      }
    }

    // 이벤트 바인딩
    dateInput.addEventListener("change", loadData);
    groupSelect.addEventListener("change", loadData);
    saveBtn.addEventListener("click", saveData);
  </script>

</body>
</html>
