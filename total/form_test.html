<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>월별 데이터 취합</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:16px}
    .controls{display:flex;gap:8px;align-items:center}
    select, button{padding:6px 10px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ccc;padding:6px;text-align:center}
    th{background:#f5f5f5}
    .small{font-size:13px;color:#666}
    .loading{margin-left:8px;font-size:13px}

    /* 요일 헤더 */
    th:nth-child(2) {
      background: #eeeeee !important;
    }

    /* 요일 열 */
    td.weekday {
      background: #f5f5f5;
    }

    /* 일요일 줄 */
    tr.sunday {
      background: #ffecec;
    }

    /* 토요일 줄 */
    tr.saturday {
      background: #e9f2ff;
    }

    /* 클릭 가능 표시 */
    td.clickable {
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h2>월별 데이터 취합</h2>
  <div class="controls">
    <label for="monthSelector">월 선택: </label>
    <select id="monthSelector"></select>
    <button id="prevBtn">&lt;</button>
    <button id="nextBtn">&gt;</button>
    <span id="statusText" class="loading"></span>
  </div>

  <table id="statusTable">
    <thead>
      <tr>
        <th>일</th>
        <th>요일</th>
        <th>위생</th>
        <th>건면</th>
        <th>생면</th>
        <th>금속</th>
        <th>입고</th>
        <th>방재</th>
        <th>급수</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // ============================
  //   1) URL 설정
  // ============================
  const BASE_URL = "https://script.google.com/macros/s/AKfycbxaDUGKeljXJP6cNeV8z4nOgyYH76Pv5ZxGMMOo42A9YZUe71Ha6ONTsL5V_rdp88JOAQ/exec";

  // 웹폼 URL 매핑
  const FORM_URLS = {
    "위생": "/my-webform/sanitation/form_sanitation.html",
    "건면": "/my-webform/noodle/form_noodle.html",
    "생면": "/my-webform/fresh/form_fresh.html",
    "금속": "/my-webform/magnet/form_magnet.html",
    "입고": "/my-webform/inbound/form_inbound.html",
    "방재": "/my-webform/pest/form_pest.html",
    "급수": "/my-webform/water/form_water.html"
  };

  const HEADERS = ["위생","건면","생면","금속","입고","방재","급수"];

  const monthSel = document.getElementById("monthSelector");
  const statusText = document.getElementById("statusText");


  // ============================
  //   2) 초기화
  // ============================
  function init() {
    populateMonths();
    document.getElementById("prevBtn").addEventListener("click", () => changeMonth(-1));
    document.getElementById("nextBtn").addEventListener("click", () => changeMonth(1));
    monthSel.addEventListener("change", loadSelectedMonth);
    setToCurrentMonth();
  }


  // ============================
  //   3) 월 리스트 구성
  // ============================
  function populateMonths() {
    const today = new Date();
    const thisYear = today.getFullYear();
    const startYear = thisYear - 1;
    const endYear = thisYear + 1;
    for (let y = startYear; y <= endYear; y++) {
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        const val = `${y}-${String(m).padStart(2,"0")}`;
        opt.value = val;
        opt.textContent = `${y}년 ${m}월`;
        monthSel.appendChild(opt);
      }
    }
  }

  function setToCurrentMonth() {
    const t = new Date();
    const v = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;
    monthSel.value = v;
    loadSelectedMonth();
  }

  function changeMonth(delta) {
    const [y, m] = monthSel.value.split("-").map(Number);
    let newY = y, newM = m + delta;
    if (newM < 1) { newM = 12; newY -= 1; }
    if (newM > 12) { newM = 1; newY += 1; }
    const val = `${newY}-${String(newM).padStart(2,'0')}`;
    monthSel.value = val;
    loadSelectedMonth();
  }


  // ============================
  //   4) 데이터 불러오기
  // ============================
  async function loadSelectedMonth() {
    const val = monthSel.value;
    const [year, month] = val.split("-").map(Number);
    statusText.textContent = "불러오는 중...";
    try {
      const url = `${BASE_URL}?mode=data&year=${year}&month=${month}`;
      const resp = await fetch(url);
      const json = await resp.json();
      if (!json.success) throw new Error(json.error || "데이터 로드 실패");
      renderTable(json.data);
      statusText.textContent = `완료 — ${year}년 ${month}월`;
    } catch (err) {
      statusText.textContent = "오류: " + (err.message || err);
      document.querySelector("#statusTable tbody").innerHTML = "";
      console.error(err);
    }
  }


  // ============================
  //   5) 특정 웹폼 열기 함수
  // ============================
  function openForm(headerName, dateStr) {
    const base = FORM_URLS[headerName];
    if (!base) return;

    // 날짜 입력 전달 → 새창 열기
    window.open(`${base}?date=${dateStr}`, "_blank");
  }


  // ============================
  //   6) 테이블 렌더링 (클릭 기능 포함)
  // ============================
  function renderTable(data) {
    const tbody = document.querySelector("#statusTable tbody");
    tbody.innerHTML = "";

    const weekDays = ["일","월","화","수","목","금","토"];

    data.forEach(item => {
      const dt = new Date(item.date);
      const day = dt.getDate();
      const w = weekDays[dt.getDay()];
      const dateStr = item.date; // YYYY-MM-DD

      const tr = document.createElement("tr");

      // 주말 배경색
      if (w === "일") tr.classList.add("sunday");
      if (w === "토") tr.classList.add("saturday");

      // 날짜 + 요일
      tr.innerHTML = `
        <td>${day}</td>
        <td class="weekday">${w}</td>
      `;

      // 7개 해드 (클릭 시 해당 웹폼 열림)
      item.status.forEach((s, idx) => {
        const headerName = HEADERS[idx];
        const td = document.createElement("td");

        td.textContent = s;  // 값(O 또는 빈칸)
        td.classList.add("clickable");

        td.onclick = () => openForm(headerName, dateStr);

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  }

  window.onload = init;
</script>
</body>
</html>
