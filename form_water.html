<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì§€í•˜ìˆ˜ ì ê²€</title>
  <style>
    body {
      font-family: "Noto Sans KR", sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f4f7fb;
    }
    header {
      background: #0078d7;
      color: white;
      padding: 14px;
      font-weight: bold;
      text-align: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 10;
    }
    main {
      flex: 1;
      overflow-y: auto;
      padding: 70px 15px 100px;
    }
    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    #valueBox { margin-top: 15px; }
    .checklist {
      display: none;
      margin-top: 20px;
    }
    .item {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .item-title {
      font-weight: bold;
      margin-bottom: 6px;
    }
    .ox-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 6px;
    }
    .ox-btn {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f2f2f2;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
    }
    .ox-btn.active {
      background: #0078d7;
      color: white;
      border-color: #0078d7;
    }
    #dupBox {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 8px;
    }
    #dupBox button {
      margin-top: 8px;
      background: #0078d7;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: white;
      padding: 12px 16px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    button#saveBtn {
      width: 100%;
      background: #0078d7;
      color: white;
      border: none;
      padding: 14px;
      font-size: 18px;
      border-radius: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>ğŸ’§ ì§€í•˜ìˆ˜ ì ê²€</header>

  <main>
    <form id="waterForm">
      <label>ë‚ ì§œ</label>
      <input type="date" id="date" required />

      <label>ì ê²€ êµ¬ë¶„</label>
      <select id="option" required>
        <option value="ê²€ì¹¨" selected>ê²€ì¹¨</option>
        <option value="ì •ê¸°ì ê²€">ì •ê¸°ì ê²€</option>
      </select>

      <div id="dupBox">
        <span>âš ï¸ ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.</span><br>
        <button type="button" id="loadBtn">í™•ì¸</button>
      </div>

      <div id="valueBox">
        <label>ìˆ˜ì¹˜ ì…ë ¥</label>
        <input type="number" id="value" step="0.01" placeholder="ì˜ˆ: 12.4" />
      </div>

      <div class="checklist" id="checklist"></div>
    </form>
  </main>

  <footer>
    <button id="saveBtn" type="button">ì €ì¥í•˜ê¸°</button>
  </footer>

  <script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbwKgMIoLZEry7gCt3ovyYmBc8z0y5mJsjH_9wQp3y9D-tTuG-B8BMnKjVjoU2VzB79FhQ/exec";
const dateInput = document.getElementById("date");
const optionSelect = document.getElementById("option");
const valueInput = document.getElementById("valueInput");
const checklistContainer = document.getElementById("checklistContainer");
const saveBtn = document.getElementById("saveBtn");

let currentOption = "ê²€ì¹¨";
let currentChecklist = {}; // OX ìƒíƒœ ì €ì¥

// âœ… 1ï¸âƒ£ ì˜µì…˜ ì„ íƒì‹œ ë™ì‘
optionSelect.addEventListener("change", async () => {
  currentOption = optionSelect.value;
  checklistContainer.innerHTML = "";
  valueInput.value = "";
  valueInput.disabled = true;
  saveBtn.disabled = true;

  if (!dateInput.value) {
    alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
    optionSelect.value = "";
    return;
  }

  // ğŸ”¹ 1. ì¤‘ë³µ ì—¬ë¶€ í™•ì¸
  const payload = { date: dateInput.value, option: currentOption };
  const res = await fetch(`${BASE_URL}?checkWater=${JSON.stringify(payload)}`);
  const data = await res.json();

  if (data.exists) {
    // ğŸ”¸ ì¤‘ë³µë°ì´í„° ì¡´ì¬ â†’ ë©”ì‹œì§€ ë„ìš°ê¸°
    if (confirm(`ì´ë¯¸ '${currentOption}' ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      // âœ… ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
      const fetchRes = await fetch(`${BASE_URL}?getWater=${JSON.stringify(payload)}`);
      const result = await fetchRes.json();
      if (result.exists) {
        if (currentOption === "ê²€ì¹¨") {
          valueInput.disabled = false;
          valueInput.value = result.data.value || "";
        } else if (currentOption === "ì •ê¸°ì ê²€") {
          renderChecklist(result.data);
        }
      }
      saveBtn.disabled = false;
    }
  } else {
    // ğŸ”¹ ìƒˆ ë°ì´í„°
    if (currentOption === "ê²€ì¹¨") {
      valueInput.disabled = false;
      checklistContainer.innerHTML = "";
    } else if (currentOption === "ì •ê¸°ì ê²€") {
      renderChecklist(); // ì‹ ê·œ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    }
    saveBtn.disabled = false;
  }
});

// âœ… 2ï¸âƒ£ ì •ê¸°ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸ UI ìƒì„±
function renderChecklist(dataObj = {}) {
  const items = [
    "ì“°ë ˆê¸° ë“± ë¶ˆí•„ìš”í•œ ë¬¼ê±´ ë°©ì¹˜ì—¬ë¶€",
    "ì²­ì†Œìƒíƒœ ì–‘í˜¸ì—¬ë¶€",
    "ì¥ê¸ˆì¥ì¹˜ ìƒíƒœ",
    "ì˜¤ì—¼ì› ì–‘í˜¸ì—¬ë¶€",
    "ì €ìˆ˜ì¡° ê· ì—´ì—¬ë¶€",
    "ì €ìˆ˜ì¡°ë‚´ ì¹¨ì „ë¬¼ ìƒíƒœ",
    "ì €ìˆ˜ì¡°ë‚´ ë¶€ìœ ë¬¼ ìƒíƒœ",
    "ë°°ê´€ ëˆ„ìˆ˜ ìƒíƒœ",
    "ê¸‰ìˆ˜íŒí”„ ì‘ë™ìœ ë¬´",
    "ì ‘í•©ë¶€ ê³ ì •ì—¬ë¶€",
  ];

  checklistContainer.innerHTML = "";
  valueInput.disabled = true;

  items.forEach((label, idx) => {
    const div = document.createElement("div");
    div.className = "check-row";
    div.innerHTML = `
      <label>${label}</label>
      <button type="button" class="ox-btn" data-key="${idx}" data-val="O">O</button>
      <button type="button" class="ox-btn" data-key="${idx}" data-val="X">X</button>
    `;
    checklistContainer.appendChild(div);

    // ê¸°ì¡´ê°’ ë°˜ì˜
    if (dataObj[`col${idx+4}`]) {
      const val = dataObj[`col${idx+4}`];
      currentChecklist[idx] = val;
      const btn = div.querySelector(`button[data-val="${val}"]`);
      if (btn) btn.classList.add("selected");
    }
  });

  checklistContainer.querySelectorAll(".ox-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      const key = e.target.dataset.key;
      const val = e.target.dataset.val;
      currentChecklist[key] = val;
      // í† ê¸€ ì²˜ë¦¬
      e.target.parentElement.querySelectorAll(".ox-btn").forEach(b => b.classList.remove("selected"));
      e.target.classList.add("selected");
    });
  });
}

// âœ… 3ï¸âƒ£ ì €ì¥
saveBtn.addEventListener("click", async () => {
  if (!dateInput.value || !currentOption) return alert("ë‚ ì§œì™€ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.");

  let payload = { date: dateInput.value, option: currentOption };

  if (currentOption === "ê²€ì¹¨") {
    if (!valueInput.value) return alert("ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    payload.value = valueInput.value;
  } else if (currentOption === "ì •ê¸°ì ê²€") {
    payload.checklist = Object.values(currentChecklist);
  }

  const params = new URLSearchParams();
  params.append("water", JSON.stringify(payload));

  const res = await fetch(`${BASE_URL}`, {
    method: "POST",
    body: params,
  });

  const text = await res.text();
  alert(text);
});
</script>

</body>
</html>
