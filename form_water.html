<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>지하수 점검</title>
  <style>
    body { font-family: "Noto Sans KR", sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f7fb; }
    header { background: #0078d7; color: white; padding: 14px; font-weight: bold; text-align: center; position: fixed; width: 100%; top: 0; z-index: 10; }
    main { flex: 1; overflow-y: auto; padding: 70px 15px 100px; }
    label { font-weight: 600; margin-top: 10px; display: block; }
    input, select { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-top: 5px; }
    #valueBox { margin-top: 15px; }
    .checklist { display: none; margin-top: 20px; }
    .item { background: #fff; border-radius: 10px; padding: 10px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .item-title { font-weight: bold; margin-bottom: 6px; }
    .ox-buttons { display: flex; gap: 8px; justify-content: center; margin-top: 6px; }
    .ox-btn { flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc; background: #f2f2f2; text-align: center; font-weight: bold; cursor: pointer; }
    .ox-btn.active { background: #0078d7; color: white; border-color: #0078d7; }
    #dupBox { display: none; margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; }
    #dupBox button { margin-top: 8px; background: #0078d7; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    footer { position: fixed; bottom: 0; width: 100%; background: white; padding: 12px 16px; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); }
    button#saveBtn { width: 100%; background: #0078d7; color: white; border: none; padding: 14px; font-size: 18px; border-radius: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <header>💧 지하수 점검</header>

  <main>
    <form id="waterForm">
      <label>날짜</label>
      <input type="date" id="date" required />

      <label>점검 구분</label>
      <select id="option" required>
        <option value="검침" selected>검침</option>
        <option value="정기점검">정기점검</option>
      </select>

      <div id="dupBox">
        <span>⚠️ 기존 데이터가 있습니다.</span><br>
        <button type="button" id="loadBtn">확인</button>
      </div>

      <div id="valueBox">
        <label>수치 입력</label>
        <input type="number" id="value" step="0.01" placeholder="예: 12.4" />
      </div>

      <div class="checklist" id="checklist"></div>
    </form>
  </main>

  <footer>
    <button id="saveBtn" type="button">저장하기</button>
  </footer>

  <script>
    const BASE_URL = "https://script.google.com/macros/s/AKfycbwKgMIoLZEry7gCt3ovyYmBc8z0y5mJsjH_9wQp3y9D-tTuG-B8BMnKjVjoU2VzB79FhQ/exec";

    const checkItems = [
      "쓰레기 등 불필요한 물건 방치여부",
      "청소상태 양호여부",
      "잠금장치 상태",
      "오염원 양호여부",
      "저수조 균열여부",
      "저수조내 침전물 상태",
      "저수조내 부유물 상태",
      "배관 누수 상태",
      "급수펌프 작동유무",
      "접합부 고정여부"
    ];

    const dateInput = document.getElementById("date");
    const optionSelect = document.getElementById("option");
    const valueBox = document.getElementById("valueBox");
    const valueInput = document.getElementById("value");
    const checklistDiv = document.getElementById("checklist");
    const dupBox = document.getElementById("dupBox");
    const loadBtn = document.getElementById("loadBtn");
    const saveBtn = document.getElementById("saveBtn");

    let currentChecklist = {};

    // 오늘 날짜 기본값
    dateInput.valueAsDate = new Date();

    // --- 체크리스트 렌더링 ---
    function renderChecklist(data = {}){
      checklistDiv.innerHTML = "";
      checkItems.forEach((item, idx)=>{
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-title">${idx+1}. ${item}</div>
          <div class="ox-buttons">
            <div class="ox-btn" data-key="${idx}" data-value="O">O</div>
            <div class="ox-btn" data-key="${idx}" data-value="X">X</div>
          </div>
        `;
        checklistDiv.appendChild(div);

        // 기존값 버튼 active
        const val = data[idx] || "";
        currentChecklist[idx] = val;
      });

      checklistDiv.querySelectorAll(".ox-btn").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const key = e.target.dataset.key;
          currentChecklist[key] = e.target.dataset.value;
          e.target.parentElement.querySelectorAll(".ox-btn").forEach(b=>b.classList.remove("active"));
          e.target.classList.add("active");
        });

        const key = btn.dataset.key;
        if(currentChecklist[key] === btn.dataset.value) btn.classList.add("active");
      });
    }

    // --- 입력창 활성화 ---
    function activateInputs(option){
      if(option==="검침"){
        valueBox.style.display="block";
        valueInput.disabled=false;
        checklistDiv.style.display="none";
      } else {
        valueBox.style.display="none";
        checklistDiv.style.display="block";
        renderChecklist(currentChecklist);
      }
      saveBtn.disabled=false;
    }

    // --- 중복 확인 ---
    async function checkDuplicate(){
      const date = dateInput.value;
      const option = optionSelect.value;
      if(!date || !option) return;

      try {
        const res = await fetch(`${BASE_URL}?checkWater=${JSON.stringify({date, option})}`);
        const data = await res.json();
        if(data.exists){
          dupBox.style.display = "block";
          valueInput.disabled = true;
          checklistDiv.style.display = "none";
        } else {
          dupBox.style.display = "none";
          activateInputs(option);
        }
      } catch {
        dupBox.style.display = "none";
        activateInputs(option);
      }
    }

    // --- 기존 데이터 불러오기 ---
    loadBtn.addEventListener("click", async ()=>{
      const date = dateInput.value;
      const option = optionSelect.value;
      try{
        const res = await fetch(`${BASE_URL}?getWater=${JSON.stringify({date, option})}`);
        const data = await res.json();

        if(option==="검침"){
          valueInput.value = data.data?.value || "";
        } else {
          // D~M열 값 가져오기
          const checklistData = {};
          for(let i=0;i<10;i++){
            checklistData[i] = data.data ? data.data[String(i+4)] || "" : "";
          }
          currentChecklist = {...checklistData};
          renderChecklist(checklistData);
        }

        dupBox.style.display="none";
        activateInputs(option);
      }catch(e){
        alert("데이터 불러오기 실패");
      }
    });

    // --- 옵션 변경 ---
    optionSelect.addEventListener("change", ()=>{
      if(optionSelect.value==="정기점검"){
        valueInput.value="";
        valueBox.style.display="none";
        checklistDiv.style.display="block";
      } else {
        valueBox.style.display="block";
        checklistDiv.style.display="none";
      }
      checkDuplicate();
    });

    dateInput.addEventListener("change", checkDuplicate);

    // --- 저장 ---
    saveBtn.addEventListener("click", ()=>{
      const date = dateInput.value;
      const option = optionSelect.value;
      const value = valueInput.value;

      if(!date || !option) return alert("날짜와 점검구분을 입력하세요.");

      const states = {};
      checkItems.forEach((t,i)=>{
        states[i] = currentChecklist[i] || "";
      });

      const payload = { date, option, value, checklist: states };

      fetch(BASE_URL, {
        method: "POST",
        body: new URLSearchParams({ water: JSON.stringify(payload) })
      })
        .then(r=>r.text())
        .then(msg=>{
          alert(msg);
          location.reload();
        })
        .catch(err=>alert("❌ 오류: "+err));
    });

    // --- 페이지 로드 시 ---
    window.addEventListener("load", ()=>{
      checkDuplicate();
    });

  </script>
</body>
</html>
