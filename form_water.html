<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>지하수 점검</title>
  <style>
    body {
      font-family: "Noto Sans KR", sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f4f7fb;
    }
    header {
      background: #0078d7;
      color: white;
      padding: 14px;
      font-weight: bold;
      text-align: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 10;
    }
    main {
      flex: 1;
      overflow-y: auto;
      padding: 70px 15px 100px;
    }
    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }
    input, select {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    #valueBox { margin-top: 15px; }
    .checklist {
      display: none;
      margin-top: 20px;
    }
    .item {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .item-title {
      font-weight: bold;
      margin-bottom: 6px;
    }
    .ox-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 6px;
    }
    .ox-btn {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f2f2f2;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
    }
    .ox-btn.active {
      background: #0078d7;
      color: white;
      border-color: #0078d7;
    }
    #dupBox {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 8px;
    }
    #dupBox button {
      margin-top: 8px;
      background: #0078d7;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: white;
      padding: 12px 16px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    }
    button#saveBtn {
      width: 100%;
      background: #0078d7;
      color: white;
      border: none;
      padding: 14px;
      font-size: 18px;
      border-radius: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>💧 지하수 점검</header>

  <main>
    <form id="waterForm">
      <label>날짜</label>
      <input type="date" id="date" required />

      <label>점검 구분</label>
      <select id="option" required>
        <option value="검침" selected>검침</option>
        <option value="정기점검">정기점검</option>
      </select>

      <div id="dupBox">
        <span>⚠️ 기존 데이터가 있습니다.</span><br>
        <button type="button" id="loadBtn">확인</button>
      </div>

      <div id="valueBox">
        <label>수치 입력</label>
        <input type="number" id="value" step="0.01" placeholder="예: 12.4" />
      </div>

      <div class="checklist" id="checklist"></div>
    </form>
  </main>

  <footer>
    <button id="saveBtn" type="button">저장하기</button>
  </footer>

  <script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbwKgMIoLZEry7gCt3ovyYmBc8z0y5mJsjH_9wQp3y9D-tTuG-B8BMnKjVjoU2VzB79FhQ/exec";
const dateInput = document.getElementById("date");
const optionSelect = document.getElementById("option");
const valueInput = document.getElementById("valueInput");
const checklistContainer = document.getElementById("checklistContainer");
const saveBtn = document.getElementById("saveBtn");

let currentOption = "검침";
let currentChecklist = {}; // OX 상태 저장

// ✅ 1️⃣ 옵션 선택시 동작
optionSelect.addEventListener("change", async () => {
  currentOption = optionSelect.value;
  checklistContainer.innerHTML = "";
  valueInput.value = "";
  valueInput.disabled = true;
  saveBtn.disabled = true;

  if (!dateInput.value) {
    alert("날짜를 먼저 선택해주세요.");
    optionSelect.value = "";
    return;
  }

  // 🔹 1. 중복 여부 확인
  const payload = { date: dateInput.value, option: currentOption };
  const res = await fetch(`${BASE_URL}?checkWater=${JSON.stringify(payload)}`);
  const data = await res.json();

  if (data.exists) {
    // 🔸 중복데이터 존재 → 메시지 띄우기
    if (confirm(`이미 '${currentOption}' 데이터가 존재합니다. 불러오시겠습니까?`)) {
      // ✅ 기존 데이터 불러오기
      const fetchRes = await fetch(`${BASE_URL}?getWater=${JSON.stringify(payload)}`);
      const result = await fetchRes.json();
      if (result.exists) {
        if (currentOption === "검침") {
          valueInput.disabled = false;
          valueInput.value = result.data.value || "";
        } else if (currentOption === "정기점검") {
          renderChecklist(result.data);
        }
      }
      saveBtn.disabled = false;
    }
  } else {
    // 🔹 새 데이터
    if (currentOption === "검침") {
      valueInput.disabled = false;
      checklistContainer.innerHTML = "";
    } else if (currentOption === "정기점검") {
      renderChecklist(); // 신규 체크리스트 렌더링
    }
    saveBtn.disabled = false;
  }
});

// ✅ 2️⃣ 정기점검 체크리스트 UI 생성
function renderChecklist(dataObj = {}) {
  const items = [
    "쓰레기 등 불필요한 물건 방치여부",
    "청소상태 양호여부",
    "장금장치 상태",
    "오염원 양호여부",
    "저수조 균열여부",
    "저수조내 침전물 상태",
    "저수조내 부유물 상태",
    "배관 누수 상태",
    "급수펌프 작동유무",
    "접합부 고정여부",
  ];

  checklistContainer.innerHTML = "";
  valueInput.disabled = true;

  items.forEach((label, idx) => {
    const div = document.createElement("div");
    div.className = "check-row";
    div.innerHTML = `
      <label>${label}</label>
      <button type="button" class="ox-btn" data-key="${idx}" data-val="O">O</button>
      <button type="button" class="ox-btn" data-key="${idx}" data-val="X">X</button>
    `;
    checklistContainer.appendChild(div);

    // 기존값 반영
    if (dataObj[`col${idx+4}`]) {
      const val = dataObj[`col${idx+4}`];
      currentChecklist[idx] = val;
      const btn = div.querySelector(`button[data-val="${val}"]`);
      if (btn) btn.classList.add("selected");
    }
  });

  checklistContainer.querySelectorAll(".ox-btn").forEach(btn => {
    btn.addEventListener("click", e => {
      const key = e.target.dataset.key;
      const val = e.target.dataset.val;
      currentChecklist[key] = val;
      // 토글 처리
      e.target.parentElement.querySelectorAll(".ox-btn").forEach(b => b.classList.remove("selected"));
      e.target.classList.add("selected");
    });
  });
}

// ✅ 3️⃣ 저장
saveBtn.addEventListener("click", async () => {
  if (!dateInput.value || !currentOption) return alert("날짜와 옵션을 선택하세요.");

  let payload = { date: dateInput.value, option: currentOption };

  if (currentOption === "검침") {
    if (!valueInput.value) return alert("수치를 입력하세요.");
    payload.value = valueInput.value;
  } else if (currentOption === "정기점검") {
    payload.checklist = Object.values(currentChecklist);
  }

  const params = new URLSearchParams();
  params.append("water", JSON.stringify(payload));

  const res = await fetch(`${BASE_URL}`, {
    method: "POST",
    body: params,
  });

  const text = await res.text();
  alert(text);
});
</script>

</body>
</html>
