<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>정기검증 취합 (월별)</title>
<style>
body { font-family: Arial, sans-serif; margin:16px; }
h2 { text-align:center; margin-bottom:8px; }
.controls { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; }
button { padding:6px 10px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
table { width:100%; border-collapse: collapse; margin-top:12px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#f5f5f5; }
td.clickable { cursor: pointer; text-decoration: underline; font-size: 16px; font-weight: bold; }
.small { font-size:12px; color:#666; }
</style>
</head>
<body>

<h2>정기검증 취합 (월별)</h2>

<div class="controls">
  <label for="yearSelect">년도:</label>
  <select id="yearSelect"></select>
  <button id="loadBtn">조회</button>
</div>

<table id="monthStatusTable">
  <thead>
    <tr>
      <th>월</th>
      <th>품질검사</th>
      <th>탱크청소</th>
      <th>에어필터</th>
      <th>지하수검사</th>
      <th>검교정</th>
      <th>유효성평가</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="small" id="note">● = 완료, ○ = 미완료. 셀 클릭 시 입력폼이 새창으로 열립니다.</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbzer90uY5RJoU-AYu4wlxxRZeuEg1PSdlOXOWPwRYoQBZikNUkd8cynDiqJAasI8dKc7g/exec";

const CELL_MAP_MONTH = [
  { period: "분기", item: "품질검사" },
  { period: "반기", item: "탱크청소" },
  { period: "반기", item: "에어필터" },
  { period: "연간", item: "지하수검사" },
  { period: "연간", item: "검교정" },
  { period: "연간", item: "유효성평가" }
];

const tbody = document.querySelector("#monthStatusTable tbody");
const yearSelect = document.getElementById("yearSelect");

// URL 파라미터에서 year 받기
const params = new URLSearchParams(location.search);
let currentYear = parseInt(params.get("year")) || new Date().getFullYear();

// 년도 드롭다운 생성 (현재 ±5)
for(let y=currentYear-5;y<=currentYear+5;y++){
  const opt = document.createElement("option");
  opt.value=y; opt.textContent=y;
  if(y===currentYear) opt.selected=true;
  yearSelect.appendChild(opt);
}

// 데이터 불러오기
async function loadMonthData(year){
  tbody.innerHTML=`<tr><td colspan="7">불러오는 중...</td></tr>`;
  try{
    const resp = await fetch(`${BASE_URL}?mode=data_month&year=${year}`);
    const json = await resp.json();
    if(!json.success) throw new Error(json.error || '데이터 로드 실패');
    renderMonthTable(json.data);
  }catch(err){
    tbody.innerHTML=`<tr><td colspan="7">오류: ${err.message}</td></tr>`;
  }
}

// 테이블 렌더링
function renderMonthTable(data){
  tbody.innerHTML='';
  for(let m=1;m<=12;m++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m}월</td>`;
    const monthData=data.filter(r=>{
      const [ry,rm]=r.date.split('-').map(Number);
      return ry===currentYear && rm===m;
    });
    CELL_MAP_MONTH.forEach(cell=>{
      const td=document.createElement('td');
      td.classList.add('clickable');
      const matched=monthData.find(r=>r.statusArray?.some(s=>s.period===cell.period && s.item===cell.item));
      if(matched){
        const s=matched.statusArray.find(s=>s.period===cell.period && s.item===cell.item);
        td.textContent=s.status==='완료'?'●':s.status==='미완료'?'○':'';
      }
      td.onclick=()=>{
        const firstDate = `${currentYear}-${String(m).padStart(2,'0')}-01`;
        const url = `https://foodtherapy-dean.github.io/my-webform/check/form_check.html?date=${firstDate}&period=${encodeURIComponent(cell.period)}&item=${encodeURIComponent(cell.item)}`;
        window.open(url,'_blank');
      };
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
}

document.getElementById("loadBtn").addEventListener('click',()=>loadMonthData(parseInt(yearSelect.value)));
yearSelect.addEventListener('change',()=>currentYear=parseInt(yearSelect.value));

// 초기 로딩
loadMonthData(currentYear);
</script>

</body>
</html>
