<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì •ê¸°ê²€ì¦ ì·¨í•© (ì›”ë³„)</title>

<style>
  body { font-family: Arial, sans-serif; margin:16px; }
  h2 { text-align:center; margin-bottom:8px; }
  .controls { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; }
  button { padding:6px 10px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
  table { width:100%; border-collapse: collapse; margin-top:12px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#f5f5f5; }
  td.clickable { cursor:pointer; text-decoration: underline; font-weight:bold; }
  #note { text-align:center; margin-top:8px; color:#444; font-size:12px; }
</style>
</head>

<body>
<h2>ì •ê¸°ê²€ì¦ ì·¨í•© (ì›”ë³„)</h2>

<div class="controls">
  <label>ë…„ë„: 
    <input type="number" id="yearInput" min="2020" max="2100" />
  </label>
  <button id="loadBtn">ì¡°íšŒ</button>
</div>

<table id="statusTable">
  <thead id="tableHead"></thead>
  <tbody></tbody>
</table>

<div id="note">â— = ì™„ë£Œ, â—‹ = ë¯¸ì™„ë£Œ. í´ë¦­ ì‹œ ì…ë ¥í¼ ìƒˆì°½ ì—´ë¦¼</div>


<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbxXHby92qoccnlrQ1t8mNyq2jEUTM3hn8TnywpbeU2KXHs6NWZy7wHkkRm1uoxrPm3H7g/exec";

const CELL_MAP_MONTH = [
  { period: "ë¶„ê¸°", item: "í’ˆì§ˆê²€ì‚¬" },
  { period: "ë°˜ê¸°", item: "íƒ±í¬ì²­ì†Œ" },
  { period: "ë°˜ê¸°", item: "ì—ì–´í•„í„°" },
  { period: "ì—°ê°„", item: "ì§€í•˜ìˆ˜ê²€ì‚¬" },
  { period: "ì—°ê°„", item: "ê²€êµì •" },
  { period: "ì—°ê°„", item: "ìœ íš¨ì„±í‰ê°€" }
];

const tbody = document.querySelector("#statusTable tbody");
const tableHead = document.getElementById("tableHead");
const yearInput = document.getElementById("yearInput");
const loadBtn = document.getElementById("loadBtn");


// ============================
// í—¤ë” ë¹Œë“œ
// ============================
function buildHead() {
  tableHead.innerHTML = `
    <tr>
      <th rowspan="2">ì›”</th>
      <th>ë¶„ê¸°</th>
      <th colspan="2">ë°˜ê¸°</th>
      <th colspan="3">ì—°ê°„</th>
    </tr>
    <tr>
      <th>í’ˆì§ˆê²€ì‚¬</th>
      <th>íƒ±í¬ì²­ì†Œ</th>
      <th>ì—ì–´í•„í„°</th>
      <th>ì§€í•˜ìˆ˜ê²€ì‚¬</th>
      <th>ê²€êµì •</th>
      <th>ìœ íš¨ì„±í‰ê°€</th>
    </tr>
  `;
}


// ============================
// ë°ì´í„° ë¡œë“œ
// ============================
async function loadData(year) {
  tbody.innerHTML = `<tr><td colspan="7">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>`;

  try {
    const url = `${BASE_URL}?mode=data_month&year=${year}`;
    const resp = await fetch(url);
    const json = await resp.json();

    if (!json.success) throw new Error(json.message || "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");

    renderTable(json.data);

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="7">ì˜¤ë¥˜: ${err.message}</td></tr>`;
  }
}


// ============================
// í…Œì´ë¸” ë Œë”ë§
// ============================
function renderTable(data) {
  buildHead();
  tbody.innerHTML = "";

  data.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${m.month}ì›”</td>`;

    CELL_MAP_MONTH.forEach(cell => {
      const td = document.createElement("td");
      td.classList.add("clickable");

      const status = m.statusArray.find(
        s => s.period === cell.period && s.item === cell.item
      );

      td.textContent =
        status?.status === "ì™„ë£Œ" ? "â—" :
        status?.status === "ë¯¸ì™„ë£Œ" ? "â—‹" :
        "";

      td.onclick = () => openForm(m.month, cell.period, cell.item);

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}


// ============================
// ì…ë ¥ í¼ ì—´ê¸°
// ============================
function openForm(month, period, item) {
  const url = `https://foodtherapy-dean.github.io/my-webform/check/form_check.html?month=${month}&period=${encodeURIComponent(period)}&item=${encodeURIComponent(item)}`;
  window.open(url, "_blank");
}


// ============================
// ì´ˆê¸°í™” (ì›¹í¼ ë¡œë“œì‹œ ìë™ ì¡°íšŒ)
// ============================
function init() {
  const params = new URLSearchParams(location.search);
  const year = params.get("year") || new Date().getFullYear();

  yearInput.value = year;

  // ğŸ”¥ ì›¹í¼ ë¡œë“œì‹œ ìë™ ì¡°íšŒ
  loadData(parseInt(year, 10));

  loadBtn.addEventListener("click", () =>
    loadData(parseInt(yearInput.value, 10))
  );
}

window.onload = init;
</script>

</body>
</html>
