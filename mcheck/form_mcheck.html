<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>정기검증 월별 관리</title>
<style>
body { font-family: Arial, sans-serif; margin:16px; }
h2 { text-align:center; margin-bottom:8px; }
table { width:100%; border-collapse: collapse; margin-top:12px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#f5f5f5; }
td.clickable { cursor:pointer; text-decoration:underline; font-size:18px; font-weight:bold; }
.small { font-size:12px; color:#666; }
.header-row { background:#fafafa; }
</style>
</head>
<body>

<h2>정기검증 월별 관리</h2>

<table id="statusTable">
  <thead id="tableHead"></thead>
  <tbody></tbody>
</table>
<div class="small" id="note">●=완료, ○=미완료. 클릭 시 상세 입력폼 열림.</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbxmwZCw15c2ZZbF5oX-oXZTL4rRKP2b7t_Qn2_M7Ro0LQVJFTkmikzi82EuY8vypOKWsA/exec";

const CELL_MAP_MONTH = [
  { period: "분기", item: "품질검사" },
  { period: "반기", item: "탱크청소" },
  { period: "반기", item: "에어필터" },
  { period: "연간", item: "지하수검사" },
  { period: "연간", item: "검교정" },
  { period: "연간", item: "유효성평가" }
];

const tbody = document.querySelector("#statusTable tbody");
const tableHead = document.querySelector("#tableHead");

function convertStatus(status){ return status==='완료'?'●':status==='미완료'?'○':''; }

function buildMonthHead(){
  tableHead.innerHTML='';
  const tr1 = document.createElement('tr');
  tr1.innerHTML=`<th>월</th><th colspan="1">분기</th><th colspan="2">반기</th><th colspan="3">연간</th>`;
  const tr2 = document.createElement('tr');
  tr2.innerHTML=`<th></th><th>품질검사</th><th>탱크청소</th><th>에어필터</th><th>지하수검사</th><th>검교정</th><th>유효성평가</th>`;
  tableHead.appendChild(tr1);
  tableHead.appendChild(tr2);
}

async function loadMonthData(year){
  tbody.innerHTML=`<tr><td colspan="7">불러오는 중...</td></tr>`;
  try{
    const resp = await fetch(`${BASE_URL}?mode=data_month&year=${year}`);
    const json = await resp.json();
    if(!json.success) throw new Error(json.error||'로드 실패');
    renderMonthTable(json.data, year);
  }catch(e){
    tbody.innerHTML=`<tr><td colspan="7">오류: ${e.message}</td></tr>`;
    console.error(e);
  }
}

function renderMonthTable(data, year){
  buildMonthHead();
  tbody.innerHTML='';
  data.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${d.month}월</td>`;
    CELL_MAP_MONTH.forEach(cell=>{
      const td = document.createElement('td');
      td.classList.add('clickable');
      const matched = d.statusArray.find(s=>s.period===cell.period && s.item===cell.item);
      td.textContent = convertStatus(matched?.status);
      td.onclick = ()=> openForm(`${year}-${String(d.month).padStart(2,'0')}-01`, cell.period, cell.item);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function openForm(dateStr, period, item){
  const url=`https://foodtherapy-dean.github.io/my-webform/check/form_check.html?date=${dateStr}&period=${encodeURIComponent(period)}&item=${encodeURIComponent(item)}`;
  window.open(url,'_blank');
}

function init(){
  const year = new Date().getFullYear();
  loadMonthData(year);
}

window.onload = init;
</script>

</body>
</html>
