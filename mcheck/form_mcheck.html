<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>정기검증 취합 (월별 모드)</title>
<style>
body { font-family: Arial, sans-serif; margin:16px; }
h2 { text-align:center; margin-bottom:8px; }
.controls { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
button { padding:6px 10px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
button.active { background:#4caf50; color:#fff; border-color:#4caf50; }
table { width:100%; border-collapse: collapse; margin-top:12px; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#f5f5f5; }
td.clickable { cursor: pointer; text-decoration: underline; font-size: 18px; font-weight: bold; }
.small { font-size:12px; color:#666; }
.header-row { background:#fafafa; }
#note { text-align:center; margin-top:8px; color:#444; }
@media (max-width:800px){ .controls{flex-direction:column;} table{font-size:12px} td.clickable{font-size:16px} }
</style>
</head>
<body>

<h2>정기검증 취합 (월별)</h2>

<div class="controls">
  <div style="display:flex; align-items:center; gap:8px;">
    <label for="yearInput">연도:</label>
    <select id="yearInput"></select>
  </div>
</div>

<table id="statusTable">
  <thead id="tableHead"></thead>
  <tbody></tbody>
</table>

<div id="note" class="small">● = 완료, ○ = 미완료, 빈칸 = 미입력. 셀 클릭 시 입력폼 열림.</div>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbzer90uY5RJoU-AYu4wlxxRZeuEg1PSdlOXOWPwRYoQBZikNUkd8cynDiqJAasI8dKc7g/exec";

const CELL_MAP_MONTH = [
  { period: "분기", item: "품질검사" },
  { period: "반기", item: "탱크청소" },
  { period: "반기", item: "에어필터" },
  { period: "연간", item: "지하수검사" },
  { period: "연간", item: "검교정" },
  { period: "연간", item: "유효성평가" }
];

const tbody = document.querySelector("#statusTable tbody");
const tableHead = document.querySelector("#tableHead");
const yearSelect = document.getElementById("yearInput");

let currentYear;

// ====================
// 연도 선택 UI 초기화
// ====================
function initYearSelect() {
  const today = new Date();
  const startYear = today.getFullYear() - 5;
  const endYear = today.getFullYear() + 1;
  for(let y = startYear; y <= endYear; y++){
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  }
  // 기본값은 현재 연도
  currentYear = today.getFullYear();
  yearSelect.value = currentYear;
  yearSelect.addEventListener('change', () => {
    currentYear = parseInt(yearSelect.value,10);
    loadData(currentYear);
  });
}

// ====================
// 테이블 헤더 생성
// ====================
function buildMonthHead(){
  tableHead.innerHTML = '';
  const tr1 = document.createElement('tr');
  tr1.innerHTML = `<th rowspan="2">월</th><th colspan="1">분기</th><th colspan="2">반기</th><th colspan="3">연간</th>`;
  const tr2 = document.createElement('tr');
  tr2.innerHTML = `<th>품질검사</th><th>탱크청소</th><th>에어필터</th><th>지하수검사</th><th>검교정</th><th>유효성평가</th>`;
  tableHead.appendChild(tr1);
  tableHead.appendChild(tr2);
}

// ====================
// 데이터 렌더링
// ====================
async function loadData(year){
  tbody.innerHTML = `<tr><td colspan="7">불러오는 중...</td></tr>`;
  try{
    const url = `${BASE_URL}?mode=data_month&year=${year}`;
    const resp = await fetch(url);
    const json = await resp.json();
    if(!json.success) throw new Error(json.message || '데이터 로드 실패');

    tbody.innerHTML = '';
    buildMonthHead();

    json.data.forEach(m => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m.month}월</td>`;
      CELL_MAP_MONTH.forEach(cell=>{
        const td = document.createElement('td');
        td.classList.add('clickable');
        const record = m.statusArray.find(s=>s.period===cell.period && s.item===cell.item);
        if(record && record.status === '완료') td.textContent='●';
        else if(record && record.status === '미완료') td.textContent='○';
        else td.textContent='';
        td.onclick = ()=> openForm(year, m.month, cell.period, cell.item);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

  }catch(err){
    tbody.innerHTML = `<tr><td colspan="7">오류: ${err.message}</td></tr>`;
    console.error(err);
  }
}

// ====================
// 입력폼 열기
// ====================
function openForm(year, month, period, item){
  const dateStr = `${year}-${String(month).padStart(2,'0')}-01`;
  const url = `https://foodtherapy-dean.github.io/my-webform/check/form_check.html?date=${dateStr}&period=${encodeURIComponent(period)}&item=${encodeURIComponent(item)}`;
  window.open(url, '_blank');
}

// ====================
// 초기화
// ====================
window.onload = function(){
  initYearSelect();
  loadData(currentYear);
};
</script>

</body>
</html>
