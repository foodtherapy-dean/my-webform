<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>정기검증 취합 (월별)</title>

<style>
  body { font-family: Arial, sans-serif; margin:16px; }
  h2 { text-align:center; margin-bottom:8px; }
  .controls { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; }
  button { padding:6px 10px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
  table { width:100%; border-collapse: collapse; margin-top:12px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#f5f5f5; }
  td.clickable { cursor:pointer; text-decoration: underline; font-weight:bold; }
  #note { text-align:center; margin-top:8px; color:#444; font-size:12px; }
</style>
</head>

<body>
<h2>정기검증 취합 (월별)</h2>

<div class="controls">
  <label>년도: 
    <input type="number" id="yearInput" min="2020" max="2100" />
  </label>
  <button id="loadBtn">조회</button>
</div>

<table id="statusTable">
  <thead id="tableHead"></thead>
  <tbody></tbody>
</table>

<div id="note">● = 완료, ○ = 미완료. 클릭 시 입력폼 새창 열림</div>


<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbxXHby92qoccnlrQ1t8mNyq2jEUTM3hn8TnywpbeU2KXHs6NWZy7wHkkRm1uoxrPm3H7g/exec";

const itemsMap = {
  "주간": ["방재점검","위생복세탁","기타청소"],
  "월간": ["CCP검증","위생교육"],
  "분기": ["품질검사"],
  "반기": ["탱크청소","에어필터점검"],
  "연간": ["지하수검사","검교정","유효성평가"]
};

const dateInput = document.getElementById("dateInput");
const periodSelect = document.getElementById("periodSelect");
const itemBox = document.getElementById("itemBox");
const itemSelect = document.getElementById("itemSelect");
const statusBox = document.getElementById("statusBox");
const btnDone = document.getElementById("btnDone");
const btnNot = document.getElementById("btnNot");
const saveBtn = document.getElementById("saveBtn");

let selectedStatus = "";

// ====== UI 갱신 ======
function updateStatusUI() {
  btnDone.classList.toggle("active", selectedStatus === "완료");
  btnNot.classList.toggle("active", selectedStatus === "미완료");
}

// ====== 폼 리셋 ======
function resetForm(){
  periodSelect.value = "";
  itemSelect.innerHTML = '<option value="">-- 선택하세요 --</option>';
  itemBox.classList.add("hidden");
  statusBox.classList.add("hidden");
  selectedStatus = "";
  updateStatusUI();
}

// ====== 상태 버튼 ======
btnDone.onclick = () => {
  selectedStatus = (selectedStatus === "완료") ? "" : "완료";
  updateStatusUI();
};
btnNot.onclick = () => {
  selectedStatus = (selectedStatus === "미완료") ? "" : "미완료";
  updateStatusUI();
};

function getStatus() {
  return selectedStatus;
}

// 날짜 변경 시 입력 초기화
dateInput.addEventListener("change", resetForm);

// ====== 주기 선택 ======
periodSelect.addEventListener("change", () => {
  itemSelect.innerHTML = '<option value="">-- 선택하세요 --</option>';
  statusBox.classList.add("hidden");

  const period = periodSelect.value;
  if(!period){ itemBox.classList.add("hidden"); return; }

  itemsMap[period].forEach(item => {
    const op = document.createElement("option");
    op.value = item; 
    op.textContent = item;
    itemSelect.appendChild(op);
  });

  itemBox.classList.remove("hidden");
});

// ===== 항목 선택 → 자동 중복체크 =====
itemSelect.addEventListener("change", () => {
  if(itemSelect.value){
    checkDuplicate();
  }
});

// ====== 중복 체크 ======
function checkDuplicate(){
  if(!dateInput.value || !periodSelect.value || !itemSelect.value) return;

  const url = `${BASE_URL}?mode=read&date=${dateInput.value}&period=${periodSelect.value}&item=${itemSelect.value}`;

  fetch(url)
    .then(r => r.json())
    .then(d => {
      statusBox.classList.remove("hidden");

      if(d.status){
        selectedStatus = d.data === "완료" ? "완료" : "미완료";
      } else {
        selectedStatus = "미완료";
      }
      updateStatusUI();
    });
}

// ======= 저장 =======
saveBtn.onclick = () => {
  if(!dateInput.value) return alert("날짜 선택 필요");
  if(!periodSelect.value) return alert("주기 선택 필요");
  if(!itemSelect.value) return alert("항목 선택 필요");

  const payload = {
    mode: "write",
    date: dateInput.value,
    period: periodSelect.value,
    item: itemSelect.value,
    status: getStatus()
  };

  fetch(BASE_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(d => {
      alert(d.message);
      resetForm();
    });
};


// ========== URL 파라미터 세팅 (핵심 수정) ==========
window.onload = () => {

  const params = new URLSearchParams(window.location.search);

  const date = params.get("date");
  const period = params.get("period");
  const item = params.get("item");

  // 날짜 즉시 반영
  if(date) dateInput.value = date;
  else dateInput.value = new Date().toISOString().split("T")[0];

  // 주기 자동 선택
  if(period){
    periodSelect.value = period;

    itemSelect.innerHTML = '<option value="">-- 선택하세요 --</option>';
    itemsMap[period].forEach(i=>{
      const op = document.createElement("option");
      op.value = i; 
      op.textContent = i;
      itemSelect.appendChild(op);
    });

    itemBox.classList.remove("hidden");
  }

  // 항목 자동 선택 → 중복 체크 자동 실행 (중요!!)
  if(item){
    itemSelect.value = item;
    statusBox.classList.add("hidden");
    checkDuplicate();   // ← 여기 추가됨
  }
};
</script>

</body>
</html>
