<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>정기검증 취합 (월별)</title>

<style>
  body { font-family: Arial, sans-serif; margin:16px; }
  h2 { text-align:center; margin-bottom:8px; }
  .controls { display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; }
  button { padding:6px 10px; border-radius:6px; border:1px solid #888; background:#fff; cursor:pointer; }
  table { width:100%; border-collapse: collapse; margin-top:12px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#f5f5f5; }
  td.clickable { cursor:pointer; text-decoration: underline; font-weight:bold; }
  #note { text-align:center; margin-top:8px; color:#444; font-size:12px; }
</style>
</head>

<body>
<h2>정기검증 취합 (월별)</h2>

<div class="controls">
  <label>년도: 
    <input type="number" id="yearInput" min="2020" max="2100" />
  </label>
  <button id="loadBtn">조회</button>
</div>

<table id="statusTable">
  <thead id="tableHead"></thead>
  <tbody></tbody>
</table>

<div id="note">● = 완료, ○ = 미완료. 클릭 시 입력폼 새창 열림</div>


<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbxXHby92qoccnlrQ1t8mNyq2jEUTM3hn8TnywpbeU2KXHs6NWZy7wHkkRm1uoxrPm3H7g/exec";

const CELL_MAP_MONTH = [
  { period: "분기", item: "품질검사" },
  { period: "반기", item: "탱크청소" },
  { period: "반기", item: "에어필터" },
  { period: "연간", item: "지하수검사" },
  { period: "연간", item: "검교정" },
  { period: "연간", item: "유효성평가" }
];

const tbody = document.querySelector("#statusTable tbody");
const tableHead = document.getElementById("tableHead");
const yearInput = document.getElementById("yearInput");
const loadBtn = document.getElementById("loadBtn");

// ============================
// 헤더 빌드
// ============================
function buildHead() {
  tableHead.innerHTML = `
    <tr>
      <th rowspan="2">월</th>
      <th>분기</th>
      <th colspan="2">반기</th>
      <th colspan="3">연간</th>
    </tr>
    <tr>
      <th>품질검사</th>
      <th>탱크청소</th>
      <th>에어필터</th>
      <th>지하수검사</th>
      <th>검교정</th>
      <th>유효성평가</th>
    </tr>
  `;
}

// ============================
// 데이터 로드
// ============================
async function loadData(year) {
  tbody.innerHTML = `<tr><td colspan="7">불러오는 중...</td></tr>`;

  try {
    const url = `${BASE_URL}?mode=data_month&year=${year}`;
    const resp = await fetch(url);
    const json = await resp.json();

    if (!json.success) throw new Error(json.message || "데이터 로드 실패");

    renderTable(json.data);

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="7">오류: ${err.message}</td></tr>`;
  }
}

// ============================
// 테이블 렌더링
// ============================
function renderTable(data) {
  buildHead();
  tbody.innerHTML = "";

  data.forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${m.month}월</td>`;

    CELL_MAP_MONTH.forEach(cell => {
      const td = document.createElement("td");
      td.classList.add("clickable");

      const status = m.statusArray.find(
        s => s.period === cell.period && s.item === cell.item
      );

      td.textContent =
        status?.status === "완료" ? "●" :
        status?.status === "미완료" ? "○" :
        "";

      // 클릭 시 값 전달 (실제 날짜 포함)
      td.onclick = () => {
  // 데이터가 있을 경우 그대로 전달, 없으면 월 첫 날로 세팅
  let date = status?.date || `${yearInput.value}-${String(m.month).padStart(2,"0")}-01`;

  openForm(m.month, cell.period, cell.item, date, status?.status || null);
};
        openForm(m.month, cell.period, cell.item, date, status?.status || null);
      };

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

// ============================
// 입력 폼 열기 (날짜·상태 포함)
// ============================
function openForm(month, period, item, date, status) {
  const url =
    `https://foodtherapy-dean.github.io/my-webform/check/form_check.html` +
    `?month=${month}` +
    `&period=${encodeURIComponent(period)}` +
    `&item=${encodeURIComponent(item)}` +
    `&date=${encodeURIComponent(date)}` +
    `&status=${encodeURIComponent(status || "미완료")}`;

  window.open(url, "_blank");
}

// ============================
// 초기화 (자동조회)
// ============================
function init() {
  const params = new URLSearchParams(location.search);
  const year = params.get("year") || new Date().getFullYear();

  yearInput.value = year;

  loadData(parseInt(year, 10));

  loadBtn.addEventListener("click", () =>
    loadData(parseInt(yearInput.value, 10))
  );
}

window.onload = init;
</script>

</body>
</html>
