<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìƒë©´ê³µì •(ì£¼ì •)</title>
<link rel="icon" type="image/png" sizes="192x192" href="Waterdrop.png">
<style>
  :root { --g: #4CAF50; --muted:#e0e0e0; }
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f7f8;}
  .app-container{display:flex;flex-direction:column;min-height:100vh;}
  .app-header{background:var(--g);color:#fff;padding:16px 12px;text-align:center;font-size:1.4rem;font-weight:700;}
  .app-body{flex:1;padding:12px;box-sizing:border-box;}
  .app-footer{padding:10px;position:relative;}
  .card{background:#fff;border-radius:10px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06);}
  label{display:block;font-size:0.95rem;margin-bottom:6px;color:#222;}
  input[type="date"], select, input[type="number"]{width:100%;padding:8px;font-size:0.95rem;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;}
  .row-flex{display:flex;gap:8px;align-items:center;}
  .col{flex:1;min-width:0;}
  .label-inline{flex:0 0 110px;font-weight:700;font-size:0.95rem;}
  #rounds .row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #eee;margin-bottom:8px;}
  .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--muted);font-weight:700;cursor:pointer;font-size:0.95rem;}
  .btn.selected{background:var(--g);color:#fff;box-shadow:inset 0 0 0 2px rgba(0,0,0,0.04);}
  .result{margin-left:auto;font-weight:700;font-size:0.95rem;text-align:right;min-width:80px;}
  #submitBtn{width:100%;height:56px;background:var(--g);color:#fff;border:0;border-radius:10px;font-size:1.1rem;cursor:pointer;}
  #loadingMsg{display:none;margin:8px 0;color:#666;font-weight:700;}
  #duplicateMsg{display:none;background:#fff3f3;border:1px solid #f2c2c2;padding:10px;border-radius:8px;}
  @media(max-width:420px){
    .label-inline{flex:0 0 90px;font-size:0.85rem;}
    .btn{padding:7px 8px;font-size:0.9rem;}
    .result{min-width:70px;font-size:0.9rem;}
    #submitBtn{height:48px;font-size:1rem;}
  }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ìƒë©´ê³µì • ì ê²€</div>

  <div class="app-body">
    <div class="card">
      <label for="date">ë‚ ì§œ</label>
      <input type="date" id="date" />

      <label for="product" style="margin-top:10px;">ìƒì‚°ì œí’ˆ</label>
      <select id="product">
        <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
        <option value="ë©”ë°€ìƒë©´">ë©”ë°€ìƒë©´</option>
        <option value="ìƒì¹¼êµ­ìˆ˜">ìƒì¹¼êµ­ìˆ˜</option>
        <option value="ìƒìš°ë™ë©´">ìƒìš°ë™ë©´</option>
      </select>

      <div style="margin-top:12px;" class="row-flex">
        <div style="flex:1;">
          <label style="margin-bottom:6px;">ì´ìƒì‚° LOT ìˆ˜</label>
          <select id="lotInput" style="font-size:0.95rem;"></select>
        </div>
        <div style="flex:1;">
          <label style="margin-bottom:6px;">ì´ì¤‘ëŸ‰ (kg)</label>
          <input type="number" id="totalKg" readonly style="text-align:right;" />
        </div>
      </div>

      <div id="loadingMsg">â³ ì¤‘ë³µ í™•ì¸ ì¤‘...</div>
      <div id="duplicateMsg">
        <div id="duplicateText" style="font-weight:700;margin-bottom:8px;"></div>
        <div style="display:flex;gap:8px;">
          <button id="duplicateConfirmBtn" class="btn" style="background:var(--g);color:#fff;">ê¸°ì¡´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="duplicateCancelBtn" class="btn">ìƒˆë¡œ ì…ë ¥</button>
        </div>
      </div>
    </div>

    <div id="rounds" class="card" style="display:none;"></div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ“¥ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbySUdJC8MbFWQcI5OiyoaLLknYuCphzDcy8O93TSHT11kgw6JCMytiwr8q2bwCHgJFuXQ/exec";

document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(location.search);
  const paramDate = params.get("date");

  const dateInput = document.getElementById("date");
  const productInput = document.getElementById("product");
  const lotInput = document.getElementById("lotInput");
  const totalKgInput = document.getElementById("totalKg");
  const roundsDiv = document.getElementById("rounds");
  const loadingMsg = document.getElementById("loadingMsg");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
  const duplicateCancelBtn = document.getElementById("duplicateCancelBtn");
  const submitBtn = document.getElementById("submitBtn");

  submitBtn.style.position = "fixed";
  submitBtn.style.bottom = "12px";
  submitBtn.style.left = "50%";
  submitBtn.style.transform = "translateX(-50%)";
  submitBtn.style.zIndex = "9999";

  dateInput.valueAsDate = paramDate ? new Date(paramDate) : new Date();

  lotInput.innerHTML = `<option value="0">0</option>` +
    Array.from({length:20}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join("");

  let roundData = {};

  function updateTotalKg(){
    let sum = 0;
    Object.values(roundData).forEach(r=>{
      sum += r.no;
    });
    totalKgInput.value = sum;
  }

  function createRounds(lotCount, existing=null) {
    roundsDiv.innerHTML = "";
    roundData = {};
    if (!lotCount || lotCount <= 0) {
      roundsDiv.style.display = "none";
      totalKgInput.value = "";
      return;
    }

    for (let i=1;i<=lotCount;i++){
      const row = document.createElement("div");
      row.className = "row";
      row.dataset.round = i;
      row.innerHTML = `
        <div style="flex:0 0 48px;font-weight:700;">${i}ì°¨</div>
        <button class="btn" type="button" data-type="3í¬">3í¬</button>
        <button class="btn" type="button" data-type="2í¬">2í¬</button>
        <div class="result" id="result${i}"></div>
      `;
      roundsDiv.appendChild(row);

      const btn3 = row.querySelector(".btn[data-type='3í¬']");
      const btn2 = row.querySelector(".btn[data-type='2í¬']");
      const resEl = row.querySelector(".result");

      if (existing && existing[i]) {
        const no = existing[i].no;
        const value = existing[i].value;
        roundData[i] = {no,value};
        if (no === 60){ btn3.classList.add("selected"); resEl.textContent = "ì£¼ì • 1 kg"; }
        else { btn2.classList.add("selected"); resEl.textContent = "ì£¼ì • 0.7 kg"; }
      } else {
        btn3.classList.add("selected");
        roundData[i] = {no:60, value:1};
        resEl.textContent = "ì£¼ì • 1 kg";
      }

      [btn3, btn2].forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = parseInt(row.dataset.round);
          row.querySelectorAll(".btn").forEach(b=>b.classList.remove("selected"));
          btn.classList.add("selected");

          const type = btn.dataset.type;
          const no = type === "3í¬" ? 60 : 40;
          const value = type === "3í¬" ? 1 : 0.7;
          roundData[idx] = {no,value};
          resEl.textContent = `ì£¼ì • ${value} kg`;
          updateTotalKg();
        });
      });
    }

    updateTotalKg();
    roundsDiv.style.display = "block";
  }

  lotInput.addEventListener("change", ()=>{
    const cnt = parseInt(lotInput.value) || 0;
    const defaultData = {};
    for(let i=1;i<=cnt;i++){
      defaultData[i] = {no:60,value:1};
    }
    createRounds(cnt, defaultData);
  });

  // ... ì´í•˜ ê¸°ì¡´ ì¤‘ë³µ ì²´í¬ ë° ì €ì¥ ë¡œì§ ê·¸ëŒ€ë¡œ ìœ ì§€ ...
  // ì„œë²„ fetch, restoreDuplicateData(), submitBtn click ì´ë²¤íŠ¸ ë“±
});
</script>
</body>
</html>
