<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>생면공정(주정)</title>
<style>
body, html { margin:0; padding:0; font-family:sans-serif; }
.app-container { display:flex; flex-direction:column; height:100vh; }
.app-header { background:#4CAF50; color:#fff; text-align:center; padding:20px; font-size:2rem; }
.app-body { flex:1; overflow-y:auto; padding:20px; background:#f9f9f9; }
.app-footer { flex:0 0 auto; }
.row { display:flex; align-items:center; gap:8px; margin-bottom:12px; background:#fff; padding:16px; border-radius:10px; }
.label { flex:0 0 60px; font-weight:bold; font-size:1.4rem; }
.btn { flex:1; padding:12px; border:none; border-radius:8px; cursor:pointer; background:#e0e0e0; font-weight:bold; }
.btn.selected { background:#4CAF50; color:#fff; }
.result { min-width:80px; text-align:right; font-weight:bold; }
#duplicateMsg { display:none; background:#ffcccc; padding:12px; border-radius:6px; margin-bottom:10px; }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">생면공정 점검 입력</div>
  <div class="app-body">
    <label for="date">날짜</label>
    <input type="date" id="date" style="width:100%; padding:10px; margin-bottom:10px;" />

    <label for="lotInput">총생산 LOT 수</label>
    <select id="lotInput"></select>

    <div id="duplicateMsg">
      <span id="duplicateText"></span>
      <button id="duplicateConfirmBtn">확인</button>
      <button id="duplicateCancelBtn">취소</button>
    </div>

    <div id="rounds"></div>
  </div>
  <div class="app-footer">
    <button id="submitBtn" style="width:100%; padding:20px; font-size:1.5rem; background:#4CAF50; color:#fff;">저장하기</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById("date");
  const lotInput = document.getElementById("lotInput");
  const roundsDiv = document.getElementById("rounds");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
  const duplicateCancelBtn = document.getElementById("duplicateCancelBtn");
  const submitBtn = document.getElementById("submitBtn");
  const scriptUrl = "YOUR_APPS_SCRIPT_URL_HERE";

  dateInput.valueAsDate = new Date();
  let roundData = {};
  let duplicateData = null;

  // LOT 옵션 생성
  lotInput.innerHTML = `<option value="0">0</option>` + 
    Array.from({ length: 20 }, (_, i) => `<option value="${i+1}">${i+1}</option>`).join("");

  function renderRounds(lotCount) {
    roundsDiv.innerHTML = "";
    roundData = {};
    if (lotCount > 0) {
      for (let i = 1; i <= lotCount; i++) {
        const row = document.createElement("div");
        row.className = "row";
        row.dataset.round = i;
        row.innerHTML = `
          <div class="label">${i}차</div>
          <button class="btn" data-type="3포">3포</button>
          <button class="btn" data-type="2포">2포</button>
          <div class="result" id="result${i}"></div>
        `;
        roundsDiv.appendChild(row);
      }
      roundsDiv.querySelectorAll(".btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const rowEl = e.target.closest(".row");
          const round = parseInt(rowEl.dataset.round);
          const type = e.target.dataset.type;
          const resultEl = rowEl.querySelector(".result");
          rowEl.querySelectorAll(".btn").forEach(b => b.classList.remove("selected"));
          e.target.classList.add("selected");
          const value = type==="3포"?1:0.7;
          roundData[round] = { no: type==="3포"?60:40, value };
          resultEl.textContent = `주정 ${value} kg`;
        });
      });
    }
  }

  lotInput.addEventListener("change", () => {
    const lotCount = parseInt(lotInput.value);
    renderRounds(lotCount);

    // 중복 데이터가 있을 경우 버튼 선택 복원
    if (duplicateData && duplicateData.exists) {
      for (let i = 1; i <= duplicateData.lot; i++) {
        const rowEl = roundsDiv.querySelector(`.row[data-round="${i}"]`);
        const type = (duplicateData.value[i-1]==1)?"3포":"2포";
        const btn = rowEl.querySelector(`.btn[data-type="${type}"]`);
        if(btn) btn.click();
      }
    }
  });

  async function checkDuplicate(date) {
    duplicateMsg.style.display = "none";
    submitBtn.disabled = true;
    try {
      const res = await fetch(`${scriptUrl}?checkSaengmyeon=${encodeURIComponent(JSON.stringify({ date }))}`);
      const data = await res.json();
      duplicateData = data;
      if(data.exists) {
        duplicateText.textContent = `⚠️ ${date} 에 이미 입력된 데이터가 있습니다.`;
        duplicateMsg.style.display = "block";
      } else submitBtn.disabled = false;
    } catch(e) { alert("중복 확인 실패"); }
  }

  dateInput.addEventListener("change", () => {
    if(dateInput.value) checkDuplicate(dateInput.value);
  });

  duplicateConfirmBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    submitBtn.disabled = false;
    if(duplicateData && duplicateData.exists){
      lotInput.value = duplicateData.lot;
      lotInput.dispatchEvent(new Event('change'));
    }
  });

  duplicateCancelBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    dateInput.valueAsDate = new Date();
  });

  submitBtn.addEventListener("click", async () => {
    if(!dateInput.value) return alert("날짜 선택하세요");
    const lotCount = parseInt(lotInput.value);
    if(lotCount===0) return alert("총생산 LOT 수 선택하세요");
    const noArr=[], valueArr=[];
    for(let i=1;i<=lotCount;i++){
      if(roundData[i]){ noArr.push(roundData[i].no); valueArr.push(roundData[i].value);}
      else{ noArr.push(""); valueArr.push("");}
    }
    const payload = { date: dateInput.value, lot: lotCount, no: noArr, value: valueArr };
    try {
      const res = await fetch(scriptUrl, { method:"POST", body:new URLSearchParams({ saengmyeon: JSON.stringify(payload) }) });
      const text = await res.text();
      alert("저장 완료: "+text);
      lotInput.value="0";
      roundsDiv.innerHTML="";
      checkDuplicate(dateInput.value);
    } catch(e){ alert("저장 실패: "+e.message); }
  });

  if(dateInput.value) checkDuplicate(dateInput.value);
});
</script>
</body>
</html>
