<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìƒë©´ê³µì •(ì£¼ì •)</title>
<link rel="icon" type="image/png" sizes="192x192" href="Waterdrop.png">
<style>
  :root { --g: #4CAF50; --muted:#e0e0e0; }
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f7f8;}
  .app-container{display:flex;flex-direction:column;min-height:100vh;}
  .app-header{background:var(--g);color:#fff;padding:16px 12px;text-align:center;font-size:1.4rem;font-weight:700;}
  .app-body{flex:1;padding:12px;box-sizing:border-box;}
  .app-footer{padding:10px;}
  .card{background:#fff;border-radius:10px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06);}
  label{display:block;font-size:0.95rem;margin-bottom:6px;color:#222;}
  input[type="date"], select, input[type="number"]{width:100%;padding:8px;font-size:0.95rem;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;}
  .row-flex{display:flex;gap:8px;align-items:center;}
  .col{flex:1;min-width:0;}
  .label-inline{flex:0 0 110px;font-weight:700;font-size:0.95rem;}
  #rounds .row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #eee;margin-bottom:8px;}
  .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--muted);font-weight:700;cursor:pointer;font-size:0.95rem;}
  .btn.selected{background:var(--g);color:#fff;box-shadow:inset 0 0 0 2px rgba(0,0,0,0.04);}
  .result{margin-left:auto;font-weight:700;font-size:0.95rem;text-align:right;min-width:80px;}
  #submitBtn{width:100%;padding:14px;background:var(--g);color:#fff;border:0;border-radius:10px;font-size:1.1rem;cursor:pointer;}
  #loadingMsg{display:none;margin:8px 0;color:#666;font-weight:700;}
  #duplicateMsg{display:none;background:#fff3f3;border:1px solid #f2c2c2;padding:10px;border-radius:8px;}
  @media(max-width:420px){
    .label-inline{flex:0 0 90px;font-size:0.85rem;}
    .btn{padding:7px 8px;font-size:0.9rem;}
    .result{min-width:70px;font-size:0.9rem;}
  }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ìƒë©´ê³µì • ì ê²€</div>

  <div class="app-body">
    <div class="card">
      <label for="date">ë‚ ì§œ</label>
      <input type="date" id="date" />

      <label for="product" style="margin-top:10px;">ìƒì‚°ì œí’ˆ</label>
      <select id="product">
        <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
        <option value="ë©”ë°€ìƒë©´">ë©”ë°€ìƒë©´</option>
        <option value="ìƒì¹¼êµ­ìˆ˜">ìƒì¹¼êµ­ìˆ˜</option>
        <option value="ìƒìš°ë™ë©´">ìƒìš°ë™ë©´</option>
      </select>

      <!-- LOT & ì´ì¤‘ëŸ‰ ê°™ì€ í–‰: flex 5:5 -->
      <div style="margin-top:12px;" class="row-flex">
        <div style="flex:1;">
          <label style="margin-bottom:6px;">ì´ìƒì‚° LOT ìˆ˜</label>
          <select id="lotInput" style="font-size:0.95rem;"></select>
        </div>
        <div style="flex:1;">
          <label style="margin-bottom:6px;">ì´ì¤‘ëŸ‰ (kg)</label>
          <input type="number" id="totalKg" readonly style="text-align:right;" />
        </div>
      </div>

      <div id="loadingMsg">â³ ì¤‘ë³µ í™•ì¸ ì¤‘...</div>
      <div id="duplicateMsg">
        <div id="duplicateText" style="font-weight:700;margin-bottom:8px;"></div>
        <div style="display:flex;gap:8px;">
          <button id="duplicateConfirmBtn" class="btn" style="background:var(--g);color:#fff;">ê¸°ì¡´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="duplicateCancelBtn" class="btn">ìƒˆë¡œ ì…ë ¥</button>
        </div>
      </div>
    </div>

    <div id="rounds" class="card" style="display:none;"></div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ“¥ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbySUdJC8MbFWQcI5OiyoaLLknYuCphzDcy8O93TSHT11kgw6JCMytiwr8q2bwCHgJFuXQ/exec"; // â† ë‹¹ì‹ ì˜ URLë¡œ êµì²´

document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(location.search);
  const paramDate = params.get("date");

  const dateInput = document.getElementById("date");
  const productInput = document.getElementById("product");
  const lotInput = document.getElementById("lotInput");
  const totalKgInput = document.getElementById("totalKg");
  const roundsDiv = document.getElementById("rounds");
  const loadingMsg = document.getElementById("loadingMsg");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
  const duplicateCancelBtn = document.getElementById("duplicateCancelBtn");
  const submitBtn = document.getElementById("submitBtn");

  dateInput.valueAsDate = paramDate ? new Date(paramDate) : new Date();

  // LOT 0~20
  lotInput.innerHTML = `<option value="0">0</option>` +
    Array.from({length:20}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join("");

  let roundData = {}; // {index: {no,value}}

  function createRounds(lotCount, existing=null) {
    roundsDiv.innerHTML = "";
    roundData = {};
    if (!lotCount || lotCount <= 0) {
      roundsDiv.style.display = "none";
      return;
    }

    // existing: object keyed by 1..n
    for (let i=1;i<=lotCount;i++){
      const row = document.createElement("div");
      row.className = "row";
      row.dataset.round = i;
      row.innerHTML = `
        <div style="flex:0 0 48px;font-weight:700;">${i}ì°¨</div>
        <button class="btn" type="button" data-type="3í¬">3í¬</button>
        <button class="btn" type="button" data-type="2í¬">2í¬</button>
        <div class="result" id="result${i}"></div>
      `;
      roundsDiv.appendChild(row);

      const btn3 = row.querySelector(".btn[data-type='3í¬']");
      const btn2 = row.querySelector(".btn[data-type='2í¬']");
      const resEl = row.querySelector(".result");

      if (existing && existing[i]) {
        const {no,value} = existing[i];
        roundData[i] = {no,value};
        if (no==60){ btn3.classList.add("selected"); resEl.textContent = "ì£¼ì • 1 kg"; }
        else { btn2.classList.add("selected"); resEl.textContent = "ì£¼ì • 0.7 kg"; }
      } else {
        btn3.classList.add("selected");
        roundData[i] = {no:60, value:1};
        resEl.textContent = "ì£¼ì • 1 kg";
      }

      [btn3, btn2].forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = parseInt(row.dataset.round);
          // ì´ë¯¸ ì„ íƒëœ ë²„íŠ¼ í´ë¦­ -> í•´ë‹¹ ì°¨ìˆ˜ ì‚­ì œ(ì·¨ìˆ˜)
          if (btn.classList.contains("selected")) {
            // remove idx from roundData and rebuild
            const keys = Object.keys(roundData).map(k=>parseInt(k)).sort((a,b)=>a-b);
            const newData = {};
            let ni = 1;
            keys.forEach(k=>{
              if (k!==idx) {
                newData[ni] = roundData[k];
                ni++;
              }
            });
            const newCount = Object.keys(newData).length;
            lotInput.value = newCount;
            totalKgInput.value = newCount * 20;
            createRounds(newCount, newData);
            return;
          }

          // normal selection change
          row.querySelectorAll(".btn").forEach(b=>b.classList.remove("selected"));
          btn.classList.add("selected");
          const type = btn.dataset.type;
          const value = type === "3í¬" ? 1 : 0.7;
          const no = type === "3í¬" ? 60 : 40;
          roundData[idx] = {no,value};
          resEl.textContent = `ì£¼ì • ${value} kg`;
        });
      });
    }

    roundsDiv.style.display = "block";
  }

  // LOT change -> update total kg + rounds
  lotInput.addEventListener("change", ()=>{
    const cnt = parseInt(lotInput.value) || 0;
    totalKgInput.value = cnt * 20;
    createRounds(cnt);
  });

  // ì¤‘ë³µì²´í¬: GET parameter ë°©ì‹ (existing code í˜¸í™˜)
  async function checkDuplicate(date) {
    loadingMsg.style.display = "block";
    duplicateMsg.style.display = "none";
    submitBtn.disabled = true;

    try {
      const res = await fetch(`${scriptUrl}?checkSaengmyeon=${encodeURIComponent(JSON.stringify({date}))}`);
      const data = await res.json();
      loadingMsg.style.display = "none";
      if (data.exists) {
        duplicateText.textContent = `${date} ì— ì´ë¯¸ ì…ë ¥ëœ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.`;
        duplicateMsg.style.display = "block";
      } else {
        duplicateMsg.style.display = "none";
        submitBtn.disabled = false;
      }
    } catch (err) {
      loadingMsg.style.display = "none";
      alert("ì¤‘ë³µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      submitBtn.disabled = false;
    }
  }

  // ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°: GET ë°©ì‹
  async function restoreDuplicateData(date) {
Â  Â  loadingMsg.style.display = "block";
Â  Â  try {
Â  Â  Â  const res = await fetch(`${scriptUrl}?getSaengmyeon=${encodeURIComponent(JSON.stringify({date}))}`);
Â  Â  Â  const data = await res.json();
Â  Â  Â  loadingMsg.style.display = "none";

Â  Â  Â  if (data && data.no && data.value) { // ğŸ‘ˆ noì™€ value ë°°ì—´ì´ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
Â  Â  Â  Â  productInput.value = data.product || "";
Â  Â  Â  Â  totalKgInput.value = data.weight || "";
Â  Â  Â  Â  
Â  Â  Â  Â  const noArr = data.no; Â  Â // 20ê°œì˜ NO ê°’ ë°°ì—´
Â  Â  Â  Â  const valueArr = data.value; // 20ê°œì˜ VALUE ê°’ ë°°ì—´
Â  Â  Â  Â  
Â  Â  Â  Â  // ë¹ˆ ê°’ì„ ì œì™¸í•˜ê³  ì‹¤ì œ ë°ì´í„°ë§Œ ìˆœì°¨ì ìœ¼ë¡œ ì¶”ì¶œ
Â  Â  Â  Â  const filledData = [];
Â  Â  Â  Â  for (let i = 0; i < noArr.length; i++) {
Â  Â  Â  Â  Â  // NOë‚˜ VALUE ì¤‘ í•˜ë‚˜ë¼ë„ ê°’ì´ ìˆìœ¼ë©´ ìœ íš¨í•œ LOTìœ¼ë¡œ ê°„ì£¼
Â  Â  Â  Â  Â  if (String(noArr[i]).trim() !== "" || String(valueArr[i]).trim() !== "") { 
Â  Â  Â  Â  Â  Â  const no = parseInt(noArr[i]) || (parseFloat(valueArr[i]) === 1 ? 60 : 40);
Â  Â  Â  Â  Â  Â  const value = parseFloat(valueArr[i]) || (no === 60 ? 1 : 0.7);

Â  Â  Â  Â  Â  Â  filledData.push({ no, value });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const lotCount = filledData.length;
Â  Â  Â  Â  lotInput.value = lotCount;
Â  Â  Â  Â  totalKgInput.value = lotCount * 20;

Â  Â  Â  Â  // build existing object {1: {no,value}, 2: {no,value}, ...}
Â  Â  Â  Â  const existing = {};
Â  Â  Â  Â  for (let i=0;i<lotCount;i++){
Â  Â  Â  Â  Â  existing[i+1] = filledData[i];
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  createRounds(lotCount, existing);
        roundData = {};
for (let i=1; i<=lotCount; i++) {
  roundData[i] = {
    no: existing[i].no,
    value: existing[i].value
  };
}
Â  Â  Â  } else {
Â  Â  Â  Â  alert("ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  loadingMsg.style.display = "none";
Â  Â  Â  alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜");
Â  Â  Â  console.error(err);
Â  Â  }
Â  }
  dateInput.addEventListener("change", ()=>{
    lotInput.value = "0";
    totalKgInput.value = "";
    createRounds(0);
    if (dateInput.value) checkDuplicate(dateInput.value);
  });

  duplicateConfirmBtn.addEventListener("click", ()=>{
    duplicateMsg.style.display = "none";
    if (dateInput.value) restoreDuplicateData(dateInput.value);
  });

  duplicateCancelBtn.addEventListener("click", ()=>{
    duplicateMsg.style.display = "none";
    dateInput.valueAsDate = new Date();
  });

  // ì €ì¥: POST (JSON or form-encoded supported on server)
  submitBtn.addEventListener("click", async ()=>{
  if (!dateInput.value) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  if (!productInput.value) return alert("ìƒì‚°ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.");
  const lotCount = parseInt(lotInput.value) || 0;
  if (lotCount === 0) return alert("ì´ìƒì‚° LOT ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
  if (!totalKgInput.value || parseFloat(totalKgInput.value) === 0) return alert("ì´ì¤‘ëŸ‰ ì˜¤ë¥˜ì…ë‹ˆë‹¤.");

  const noArr = [];
  const valueArr = [];
  for (let i=1;i<=lotCount;i++){
    if (roundData[i]) {
      noArr.push(roundData[i].no);
      valueArr.push(roundData[i].value);
    } else {
      noArr.push("");
      valueArr.push("");
    }
  }

  const payload = {
    date: dateInput.value,
    product: productInput.value,
    weight: totalKgInput.value,
    lot: lotCount,
    no: noArr,
    value: valueArr
  };

  try {
    submitBtn.disabled = true;

    // form-encoded ë°©ì‹ìœ¼ë¡œ ì „ì†¡ -> preflight íšŒí”¼
    const formBody = new URLSearchParams();
    formBody.append("saengmyeon", JSON.stringify(payload));

    const res = await fetch(scriptUrl, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: formBody.toString()
    });

    // ì •ìƒì ìœ¼ë¡œ ì‘ë‹µì´ ì™”ëŠ”ì§€ í™•ì¸
    const result = await res.json();
    submitBtn.disabled = false;

    if (result && (result.result === "success" || result.success)) {
      alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜: " + (result.error || result.message || JSON.stringify(result)));
    }
  } catch (err) {
    submitBtn.disabled = false;
    alert("ì„œë²„ ì˜¤ë¥˜: " + (err.message || err));
  }
});

  // ì´ˆê¸° ì¤‘ë³µ ì²´í¬
  if (dateInput.value) checkDuplicate(dateInput.value);

});
</script>
</body>
</html>
