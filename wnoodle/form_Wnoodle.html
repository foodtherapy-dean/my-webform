<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìƒë©´ê³µì •(ì£¼ì •)</title>
<link rel="icon" type="image/png" sizes="192x192" href="Waterdrop.png">
<link rel="apple-touch-icon" href="Waterdrop.png">
<meta name="theme-color" content="#4CAF50">
<link rel="manifest" href="manifest.json">
<style>
body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
.app-container { display:flex; flex-direction:column; height:100%; }
.app-header { background:#4CAF50; color:#fff; text-align:center; padding:20px; font-size:2rem; }
.app-body { flex:1 1 auto; overflow-y:auto; padding:20px; box-sizing:border-box; background:#f9f9f9; }
.app-footer { flex:0 0 auto; }
#submitBtn { width:100%; font-size:1.8rem; padding:24px 0; background:#4CAF50; color:#fff; border:none; cursor:pointer; }
.row { display:flex; align-items:center; gap:8px; margin-bottom:12px; background:#fff; padding:16px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); flex-wrap:nowrap; }
.label { flex:0 0 80px; font-weight:bold; font-size:1.4rem; cursor:pointer; }
.btn { flex:1 1 0; min-width:0; padding:16px 12px; border-radius:8px; cursor:pointer; border:none; font-size:1.4rem; font-weight:bold; background:#e0e0e0; color:#333; transition:background .2s,color .2s,box-shadow .2s; }
.btn.selected { background:#4CAF50; color:#fff; box-shadow:inset 0 0 0 2px #2e7d32; }
.result { margin-left:auto; flex:0 0 auto; min-width:110px; text-align:right; font-size:1.4rem; font-weight:bold; color:#333; }
#loadingMsg { display:none; margin:10px 0; font-size:1.2rem; color:#555; font-weight:bold; }
#duplicateMsg { display:none; background:#ffcccc; color:#900; padding:14px; margin-top:8px; border:1px solid #900; border-radius:6px; font-weight:bold; font-size:1.2rem; }
#duplicateMsg button { margin-left:14px; background:#900; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; font-size:1rem; }
#rounds { display:none; }
#lotInput { font-size:1.4rem; padding:10px; width:100%; margin-bottom:15px; }
</style>
</head>

<body>
<div class="app-container">
  <div class="app-header">ìƒë©´ê³µì • ì ê²€</div>

  <div class="app-body">

    <!-- ë‚ ì§œ -->
    <label for="date">ë‚ ì§œ</label>
    <input type="date" id="date" required
      style="font-size:1.4rem; padding:10px; width:100%; margin-bottom:10px;" />

    <!-- ìƒì‚°ì œí’ˆ (ì¶”ê°€ë¨) -->
    <label for="product">ìƒì‚°ì œí’ˆ</label>
    <select id="product" required
      style="font-size:1.4rem; padding:10px; width:100%; margin-bottom:15px;">
      <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
      <option value="ë©”ë°€ìƒë©´">ë©”ë°€ìƒë©´</option>
      <option value="ìƒì¹¼êµ­ìˆ˜">ìƒì¹¼êµ­ìˆ˜</option>
      <option value="ìƒìš°ë™ë©´">ìƒìš°ë™ë©´</option>
    </select>

    <!-- LOT ìˆ˜ -->
    <label for="lotInput">ì´ìƒì‚° LOT ìˆ˜</label>
    <select id="lotInput"></select>

    <!-- ì´ì¤‘ëŸ‰ (LOT Ã— 20kg ìë™ê³„ì‚°) -->
    <div class="row" style="margin-top:10px;">
      <label class="label" style="flex:0 0 100px;">ì´ì¤‘ëŸ‰</label>
      <input type="number" id="totalKg" readonly
        style="flex:1; font-size:1.4rem; padding:10px; text-align:right;">
      <span style="font-size:1.4rem; font-weight:bold;">kg</span>
    </div>

    <div id="loadingMsg">â³ ì¤‘ë³µ í™•ì¸ ì¤‘...</div>

    <div id="duplicateMsg">
      <span id="duplicateText"></span>
      <button id="duplicateConfirmBtn">í™•ì¸</button>
      <button id="duplicateCancelBtn">ì·¨ì†Œ</button>
    </div>

    <div id="rounds"></div>

  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ“¥ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<script>
const scriptUrl =
  "https://script.google.com/macros/s/AKfycby9wi2mK2hN_HNnhTeKpxTO4j1w8zy0ei9ZvOrUMeK2SapvTBDWdJY7NmdSh4Y6ECFQYA/exec";

document.addEventListener("DOMContentLoaded", () => {

  const params = new URLSearchParams(location.search);
  const paramDate = params.get("date");

  const dateInput = document.getElementById("date");
  const productInput = document.getElementById("product");
  const lotInput = document.getElementById("lotInput");
  const totalKgInput = document.getElementById("totalKg");
  const submitBtn = document.getElementById("submitBtn");
  const roundsDiv = document.getElementById("rounds");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");
  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
  const duplicateCancelBtn = document.getElementById("duplicateCancelBtn");
  const loadingMsg = document.getElementById("loadingMsg");

  dateInput.valueAsDate = paramDate ? new Date(paramDate) : new Date();
  let roundData = {};

  /** LOT ì˜µì…˜ ìƒì„± */
  lotInput.innerHTML = `
    <option value="0" selected>0</option>
    ${Array.from({length: 20}, (_, i) =>
      `<option value="${i+1}">${i+1}</option>`
    ).join("")}
  `;

  /** LOT Ã— 20 = ì´ì¤‘ëŸ‰ ê³„ì‚° */
  lotInput.addEventListener("change", () => {
    createRounds(parseInt(lotInput.value));
    const lot = parseInt(lotInput.value) || 0;
    totalKgInput.value = lot * 20;
  });

  /** LOT ë¼ìš´ë“œ êµ¬ì„± */
  function createRounds(lotCount) {
    roundsDiv.innerHTML = "";
    roundData = {};

    if (lotCount <= 0) {
      roundsDiv.style.display = "none";
      return;
    }

    for (let i = 1; i <= lotCount; i++) {
      const row = document.createElement("div");
      row.className = "row";
      row.dataset.round = i;
      row.innerHTML = `
        <div class="label">${i}ì°¨</div>
        <button class="btn" type="button" data-type="3í¬">3í¬</button>
        <button class="btn" type="button" data-type="2í¬">2í¬</button>
        <div id="result${i}" class="result"></div>
      `;
      roundsDiv.appendChild(row);

      const btn3 = row.querySelector(".btn[data-type='3í¬']");
      const btn2 = row.querySelector(".btn[data-type='2í¬']");
      const resultEl = row.querySelector(".result");

      btn3.classList.add("selected");
      roundData[i] = { no: 60, value: 1 };
      resultEl.textContent = `ì£¼ì • 1 kg`;

      [btn3, btn2].forEach(btn => {
        btn.addEventListener("click", () => {
          row.querySelectorAll(".btn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");

          const type = btn.dataset.type;
          const value = type === "3í¬" ? 1 : 0.7;
          const no = type === "3í¬" ? 60 : 40;

          roundData[i] = { no, value };
          resultEl.textContent = `ì£¼ì • ${value} kg`;
        });
      });
    }
    roundsDiv.style.display = "block";
  }

  /** ë‚ ì§œ ë³€ê²½ ì‹œ ì¤‘ë³µ í™•ì¸ */
  dateInput.addEventListener("change", () => {
    lotInput.value = "0";
    totalKgInput.value = "";
    createRounds(0);
    if (dateInput.value) checkDuplicate(dateInput.value);
  });

  /** ì¤‘ë³µ í™•ì¸ ìš”ì²­ */
  async function checkDuplicate(date) {
    loadingMsg.style.display = "block";
    submitBtn.disabled = true;
    duplicateMsg.style.display = "none";

    try {
      const res = await fetch(
        `${scriptUrl}?checkSaengmyeon=${encodeURIComponent(JSON.stringify({date}))}`
      );
      const data = await res.json();
      loadingMsg.style.display = "none";

      if (data.exists) {
        duplicateText.textContent = `âš ï¸ ${date} ì— ì´ë¯¸ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.`;
        duplicateMsg.style.display = "block";
      } else {
        submitBtn.disabled = false;
      }
    } catch (e) {
      alert("ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜");
      loadingMsg.style.display = "none";
    }
  }

  /** ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° */
  duplicateConfirmBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    submitBtn.disabled = false;
  });

  duplicateCancelBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    dateInput.valueAsDate = new Date();
  });

  /** ì €ì¥ */
  submitBtn.addEventListener("click", async () => {

    if (!dateInput.value) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    if (!productInput.value) return alert("ìƒì‚°ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.");

    const lotCount = parseInt(lotInput.value);
    if (lotCount === 0) return alert("ì´ìƒì‚° LOT ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

    if (!totalKgInput.value || totalKgInput.value === "0")
      return alert("ì´ì¤‘ëŸ‰ ê³„ì‚° ì˜¤ë¥˜ì…ë‹ˆë‹¤.");

    const noArr = [];
    const valueArr = [];
    for (let i = 1; i <= lotCount; i++) {
      noArr.push(roundData[i].no);
      valueArr.push(roundData[i].value);
    }

    const body = {
      date: dateInput.value,
      product: productInput.value,
      lot: lotCount,
      totalKg: totalKgInput.value,
      noArr,
      valueArr
    };

    try {
      submitBtn.disabled = true;
      const res = await fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify(body)
      });
      const data = await res.json();
      submitBtn.disabled = false;

      if (data.result === "success") {
        alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        alert("ì €ì¥ ì˜¤ë¥˜");
      }
    } catch (e) {
      alert("ì„œë²„ ì˜¤ë¥˜");
      submitBtn.disabled = false;
    }
  });
});
</script>

</body>
</html>
