<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìƒë©´ê³µì •(ì£¼ì •)</title>
<link rel="icon" type="image/png" sizes="192x192" href="Waterdrop.png">
<style>
  :root { --g: #4CAF50; --muted:#e0e0e0; }
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f7f8;}
  .app-container{display:flex;flex-direction:column;min-height:100vh;}
  .app-header{background:var(--g);color:#fff;padding:16px 12px;text-align:center;font-size:1.4rem;font-weight:700;}
  .app-body{flex:1;padding:12px;box-sizing:border-box;}
  .app-footer{padding:0;}
  .card{background:#fff;border-radius:10px;padding:12px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.06);}
  label{display:block;font-size:0.95rem;margin-bottom:6px;color:#222;}
  input[type="date"], select, input[type="number"]{width:100%;padding:8px;font-size:0.95rem;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;}
  .row-flex{display:flex;gap:8px;align-items:center;}
  .col{flex:1;min-width:0;}
  .label-inline{flex:0 0 110px;font-weight:700;font-size:0.95rem;}
  #rounds .row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #eee;margin-bottom:8px;}
  .btn{padding:8px 10px;border-radius:8px;border:0;background:var(--muted);font-weight:700;cursor:pointer;font-size:0.95rem;}
  .btn.selected{background:var(--g);color:#fff;box-shadow:inset 0 0 0 2px rgba(0,0,0,0.04);}
  .result{margin-left:auto;font-weight:700;font-size:0.95rem;text-align:right;min-width:80px;}
  #submitBtn{width:100%;background:var(--g);color:#fff;border:0;border-radius:10px;font-size:1.1rem;cursor:pointer;}
  #loadingMsg{display:none;margin:8px 0;color:#666;font-weight:700;}
  #duplicateMsg{display:none;background:#fff3f3;border:1px solid #f2c2c2;padding:10px;border-radius:8px;}
  @media(max-width:420px){
    .label-inline{flex:0 0 90px;font-size:0.85rem;}
    .btn{padding:7px 8px;font-size:0.9rem;}
    .result{min-width:70px;font-size:0.9rem;}
  }
</style>
</head>
<body>
<div class="app-container">
  <div class="app-header">ìƒë©´ê³µì • ì ê²€</div>

  <div class="app-body">
    <div class="card">
      <label for="date">ë‚ ì§œ</label>
      <input type="date" id="date" />

      <label for="product" style="margin-top:10px;">ìƒì‚°ì œí’ˆ</label>
      <select id="product">
        <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
        <option value="ë©”ë°€ìƒë©´">ë©”ë°€ìƒë©´</option>
        <option value="ìƒì¹¼êµ­ìˆ˜">ìƒì¹¼êµ­ìˆ˜</option>
        <option value="ìƒìš°ë™ë©´">ìƒìš°ë™ë©´</option>
      </select>

      <div style="margin-top:12px;" class="row-flex">
        <div style="flex:1;">
          <label style="margin-bottom:6px;">ì´ìƒì‚° LOT ìˆ˜</label>
          <select id="lotInput" style="font-size:0.95rem;"></select>
        </div>
        <div style="flex:1;">
          <label style="margin-bottom:6px;">ì´ì¤‘ëŸ‰ (kg)</label>
          <input type="number" id="totalKg" readonly style="text-align:right;" />
        </div>
      </div>

      <div id="loadingMsg">â³ ì¤‘ë³µ í™•ì¸ ì¤‘...</div>
      <div id="duplicateMsg">
        <div id="duplicateText" style="font-weight:700;margin-bottom:8px;"></div>
        <div style="display:flex;gap:8px;">
          <button id="duplicateConfirmBtn" class="btn" style="background:var(--g);color:#fff;">ê¸°ì¡´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button id="duplicateCancelBtn" class="btn">ìƒˆë¡œ ì…ë ¥</button>
        </div>
      </div>
    </div>

    <div id="rounds" class="card" style="display:none;"></div>
  </div>

  <div class="app-footer">
    <button id="submitBtn">ğŸ“¥ ì €ì¥í•˜ê¸°</button>
  </div>
</div>

<script>
const scriptUrl = "https://script.google.com/macros/s/AKfycbySUdJC8MbFWQcI5OiyoaLLknYuCphzDcy8O93TSHT11kgw6JCMytiwr8q2bwCHgJFuXQ/exec";

document.addEventListener("DOMContentLoaded", () => {

  /* ----------------------------------------------------
     ê¸°ë³¸ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
  ---------------------------------------------------- */
  const params = new URLSearchParams(location.search);
  const paramDate = params.get("date");

  const dateInput = document.getElementById("date");
  const productInput = document.getElementById("product");
  const lotInput = document.getElementById("lotInput");
  const totalKgInput = document.getElementById("totalKg");
  const roundsDiv = document.getElementById("rounds");
  const loadingMsg = document.getElementById("loadingMsg");
  const duplicateMsg = document.getElementById("duplicateMsg");
  const duplicateText = document.getElementById("duplicateText");

  const duplicateConfirmBtn = document.getElementById("duplicateConfirmBtn");
  const duplicateCancelBtn = document.getElementById("duplicateCancelBtn");
  const submitBtn = document.getElementById("submitBtn");

  /* ----------------------------------------------------
      ì €ì¥ ë²„íŠ¼(ê³ ì • ë ˆì´ì•„ì›ƒ)
  ---------------------------------------------------- */
  const headerHeight = document.querySelector(".app-header").offsetHeight;
  submitBtn.style.height = `${headerHeight}px`;
  submitBtn.style.position = "fixed";
  submitBtn.style.bottom = "0";
  submitBtn.style.left = "0";
  submitBtn.style.width = "100%";
  submitBtn.style.zIndex = "9999";

  /* ----------------------------------------------------
      ë‚ ì§œ ê¸°ë³¸ê°’
  ---------------------------------------------------- */
  dateInput.valueAsDate = paramDate ? new Date(paramDate) : new Date();

  /* ----------------------------------------------------
      LOT ì˜µì…˜ êµ¬ì„±
  ---------------------------------------------------- */
  lotInput.innerHTML =
    `<option value="0">0</option>` +
    Array.from({ length: 20 }, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join("");

  /* ----------------------------------------------------
      roundData = { 1:{no:60, value:1}, ... }
  ---------------------------------------------------- */
  let roundData = {};

  /* ====================================================
       1) ì°¨ìˆ˜ ë²„íŠ¼ êµ¬ì„±
  ==================================================== */
  function createRounds(lotCount, existing = null) {
    roundsDiv.innerHTML = "";
    roundData = {};

    if (!lotCount || lotCount <= 0) {
      roundsDiv.style.display = "none";
      return;
    }

    for (let i = 1; i <= lotCount; i++) {

      const row = document.createElement("div");
      row.className = "row";
      row.dataset.round = i;
      row.innerHTML = `
        <div style="flex:0 0 48px; font-weight:700;">${i}ì°¨</div>
        <button class="btn" type="button" data-type="3í¬">3í¬</button>
        <button class="btn" type="button" data-type="2í¬">2í¬</button>
        <div class="result" id="result${i}"></div>
      `;
      roundsDiv.appendChild(row);

      const btn3 = row.querySelector(".btn[data-type='3í¬']");
      const btn2 = row.querySelector(".btn[data-type='2í¬']");
      const resEl = row.querySelector(".result");

      /* ê¸°ì¡´ ë°ì´í„°ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ê°’ ë³µì› (ì•ˆì „í•œ íŒŒì‹±) */
      let initNo = 60;
      let initValue = 1;

      if (existing && Array.isArray(existing) && existing[i - 1]) {
        const rawNo = existing[i - 1].no;
        const rawVal = existing[i - 1].value;

        const sNo = (rawNo === undefined || rawNo === null) ? "" : String(rawNo).trim();
        const sVal = (rawVal === undefined || rawVal === null) ? "" : String(rawVal).trim();

        if (sNo !== "") {
          const p = Number(sNo);
          if (!isNaN(p)) initNo = p;
        } else if (sVal !== "") {
          // no ë¹„ì–´ìˆê³  valueë§Œ ìˆëŠ” ê²½ìš° valueë¡œ no ì¶”ë¡ 
          const pv = Number(sVal);
          if (!isNaN(pv)) initNo = (pv === 1 ? 60 : 40);
        }

        if (sVal !== "") {
          const pv = Number(sVal);
          if (!isNaN(pv)) initValue = pv;
        } else {
          initValue = (initNo === 60 ? 1 : 0.7);
        }
      }

      roundData[i] = { no: initNo, value: initValue };

      // ë²„íŠ¼ ì„ íƒ ë³µì›: ìˆ«ìë¹„êµ(ì—„ê²©)
      btn2.classList.remove("selected");
      btn3.classList.remove("selected");
      if (initNo === 60) {
        btn3.classList.add("selected");
      } else {
        btn2.classList.add("selected");
      }

      resEl.textContent = `ì£¼ì • ${initValue} kg`;

      /* ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ */
      [btn3, btn2].forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(row.dataset.round);

          row.querySelectorAll(".btn").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");

          const is3po = btn.dataset.type === "3í¬";
          const no = is3po ? 60 : 40;
          const value = is3po ? 1 : 0.7;

          roundData[idx] = { no, value };
          resEl.textContent = `ì£¼ì • ${value} kg`;

          updateTotalKg();
        });
      });
    }

    updateTotalKg();
    roundsDiv.style.display = "block";
  }

  /* ====================================================
      2) ì´ì¤‘ëŸ‰ ê³„ì‚°
  ==================================================== */
  function updateTotalKg() {
    let total = 0;
    Object.values(roundData).forEach(r => {
      const nv = Number(r && r.no);
      if (!isNaN(nv)) total += nv;
    });
    totalKgInput.value = total;
  }

  /* LOT ë³€ê²½ â†’ ë¹ˆ ì°¨ìˆ˜ ìƒì„± */
  lotInput.addEventListener("change", () => {
    const cnt = Number(lotInput.value) || 0;
    createRounds(cnt, null);
  });

  /* ====================================================
      3) ë‚ ì§œ ì¤‘ë³µ í™•ì¸
  ==================================================== */
  async function checkDuplicate(date) {
    loadingMsg.style.display = "block";
    duplicateMsg.style.display = "none";
    submitBtn.disabled = true;

    try {
      const res = await fetch(
        `${scriptUrl}?checkSaengmyeon=${encodeURIComponent(JSON.stringify({ date }))}`
      );
      const data = await res.json();

      loadingMsg.style.display = "none";

      if (data && data.exists) {
        duplicateText.textContent = `${date} ì— ì´ë¯¸ ì…ë ¥ëœ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤.`;
        duplicateMsg.style.display = "block";
      } else {
        duplicateMsg.style.display = "none";
        submitBtn.disabled = false;
      }

    } catch (e) {
      loadingMsg.style.display = "none";
      alert("ì¤‘ë³µ í™•ì¸ ì˜¤ë¥˜");
      submitBtn.disabled = false;
    }
  }

  /* ====================================================
      4) ì¤‘ë³µ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
         â€” ë¹ˆê°’ ì²˜ë¦¬ ì—„ê²©íˆ í•´ì„œ '20ê°œ ëª¨ë‘ ìƒì„±' ë¬¸ì œ ë°©ì§€
  ==================================================== */
  async function restoreDuplicateData(date) {
    loadingMsg.style.display = "block";

    try {
      const res = await fetch(
        `${scriptUrl}?getSaengmyeon=${encodeURIComponent(JSON.stringify({ date }))}`
      );
      const data = await res.json();

      loadingMsg.style.display = "none";

      if (!data || !Array.isArray(data.no)) {
        alert("ë¶ˆëŸ¬ì˜¬ ë°ì´í„° ì—†ìŒ");
        return;
      }

      productInput.value = data.product || "";

      const noArr = data.no || [];
      const valueArr = data.value || [];

      /* ì‹œíŠ¸ ë°ì´í„° â†’ ì•ˆì „í•œ ë°°ì—´(filled)ë¡œ ë³€í™˜
         - raw ë¬¸ìì—´ì´ ë¹„ì–´ìˆìœ¼ë©´ ê±´ë„ˆëœ€ (both empty -> skip)
         - noê°€ ë¹„ì–´ìˆê³  valueë§Œ ìˆëŠ” ê²½ìš° valueë¡œ no ì¶”ë¡ 
      */
      const filled = [];
      const maxLen = Math.max(noArr.length, valueArr.length);
      for (let i = 0; i < maxLen; i++) {
        const rawNo = (noArr[i] === undefined || noArr[i] === null) ? "" : String(noArr[i]).trim();
        const rawVal = (valueArr[i] === undefined || valueArr[i] === null) ? "" : String(valueArr[i]).trim();

        if (rawNo === "" && rawVal === "") continue; // ë¹ˆ í•­ëª©ì€ ë¬´ì‹œ

        let no = NaN;
        let value = NaN;

        if (rawNo !== "") {
          const p = Number(rawNo);
          if (!isNaN(p)) no = p;
        }
        if (rawVal !== "") {
          const pv = Number(rawVal);
          if (!isNaN(pv)) value = pv;
        }

        // noê°€ ë¹„ì–´ìˆì§€ë§Œ valueê°€ ìˆìœ¼ë©´ ì¶”ë¡ 
        if (isNaN(no) && !isNaN(value)) {
          no = (value === 1 ? 60 : 40);
        }

        // valueê°€ ë¹„ì–´ìˆìœ¼ë©´ noë¡œ ì¶”ë¡ 
        if (isNaN(value) && !isNaN(no)) {
          value = (no === 60 ? 1 : 0.7);
        }

        if (!isNaN(no)) {
          filled.push({ no: no, value: value });
        }
      }

      const lotCount = filled.length;
      lotInput.value = lotCount;

      // UI ìƒì„±í•˜ë©´ì„œ filledë¥¼ existingìœ¼ë¡œ ì „ë‹¬ â†’ createRoundsê°€ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
      createRounds(lotCount, filled);

      // roundDataëŠ” createRoundsì—ì„œ ì´ë¯¸ ì„¤ì •ë¨ â€” ì¶”ê°€ ë®ì–´ì“°ê¸° ë¶ˆí•„ìš”

      updateTotalKg();
      submitBtn.disabled = false;

    } catch (err) {
      loadingMsg.style.display = "none";
      alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜");
      console.error(err);
      submitBtn.disabled = false;
    }
  }

  /* ë‚ ì§œ ë³€ê²½ â†’ ì¤‘ë³µ ì²´í¬ */
  dateInput.addEventListener("change", () => {
    productInput.value = "";
    lotInput.value = "0";
    roundsDiv.innerHTML = "";
    totalKgInput.value = "";

    if (dateInput.value) checkDuplicate(dateInput.value);
  });

  /* ì¤‘ë³µ â†’ "ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ */
  duplicateConfirmBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    if (dateInput.value) restoreDuplicateData(dateInput.value);
  });

  /* ì¤‘ë³µ â†’ "ì·¨ì†Œ" ë²„íŠ¼ */
  duplicateCancelBtn.addEventListener("click", () => {
    duplicateMsg.style.display = "none";
    dateInput.valueAsDate = new Date();
    checkDuplicate(dateInput.value);
  });

  /* ====================================================
      5) ì €ì¥
  ==================================================== */
  submitBtn.addEventListener("click", async () => {

    if (!dateInput.value) return alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    if (!productInput.value) return alert("ìƒì‚°ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.");

    const lotCount = Number(lotInput.value);
    if (lotCount === 0) return alert("ì´ìƒì‚° LOT ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

    if (!totalKgInput.value || Number(totalKgInput.value) === 0)
      return alert("ì´ì¤‘ëŸ‰ ì˜¤ë¥˜");

    /* roundData â†’ ë°°ì—´ ë³€í™˜ */
    const noArr = [];
    const valueArr = [];

    for (let i = 1; i <= lotCount; i++) {
      if (roundData[i]) {
        noArr.push(roundData[i].no);
        valueArr.push(roundData[i].value);
      } else {
        noArr.push("");
        valueArr.push("");
      }
    }

    const payload = {
      date: dateInput.value,
      product: productInput.value,
      weight: totalKgInput.value,
      lot: lotCount,
      no: noArr,
      value: valueArr
    };

    try {
      submitBtn.disabled = true;

      const formBody = new URLSearchParams();
      formBody.append("saengmyeon", JSON.stringify(payload));

      const res = await fetch(scriptUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        },
        body: formBody.toString()
      });

      const result = await res.json();

      submitBtn.disabled = false;

      if (result && (result.result === "success" || result.success)) {
        alert(result.message || "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      } else {
        alert("ì €ì¥ ì˜¤ë¥˜: " + (result.error || result.message));
      }

    } catch (err) {
      submitBtn.disabled = false;
      alert("ì„œë²„ ì˜¤ë¥˜: " + err.message);
    }
  });

  /* í˜ì´ì§€ ë¡œë”© ì‹œ ìµœì´ˆ ì²´í¬ */
  if (dateInput.value) checkDuplicate(dateInput.value);

});
</script>

</body>
</html>
