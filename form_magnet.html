<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>금속검출 모니터링</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    select, input[type="date"], button { width: 100%; padding: 8px; margin-top: 5px; }
    .section { margin-top: 15px; }
    .ox-buttons { display: flex; gap: 10px; margin-top: 5px; }
    .ox-buttons button {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .selected { background-color: #4CAF50; color: white; }
  </style>
</head>
<body>
  <h2>금속검출 모니터링</h2>
  <form id="magnetForm">
    <label>날짜</label>
    <input type="date" id="date" name="date" required />

    <label>점검차수</label>
    <select id="step" name="step" required>
      <option value="">선택하세요</option>
      <option>1차점검</option>
      <option>2차점검</option>
      <option>3차점검</option>
      <option>4차점검</option>
    </select>

    <label>시간</label>
    <div style="display: flex; gap: 10px;">
      <select id="hour" name="hour" required>
        <option value="">시 선택</option>
        <!-- JS로 채움 -->
      </select>
      <select id="minute" name="minute" required>
        <option value="">분 선택</option>
        <!-- JS로 채움 -->
      </select>
    </div>

    <label>제품 선택</label>
    <select id="product" name="product" required>
      <option value="">선택하세요</option>
      <option>A상품</option>
      <option>B상품</option>
      <option>C상품</option>
      <option>D상품</option>
      <option>E상품</option>
      <option>F상품</option>
    </select>

    <div class="section" id="oxSection"></div>

    <button type="submit" style="margin-top: 20px;">저장</button>
  </form>

  <script>
    // 날짜 자동 설정
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("date").value = today;

    // 시간 선택 (시/분)
    const hourSelect = document.getElementById("hour");
    const minuteSelect = document.getElementById("minute");
    for (let i = 1; i <= 24; i++) {
      const h = i.toString().padStart(2, '0');
      hourSelect.innerHTML += `<option value="${h}">${h}시</option>`;
    }
    [0,10,20,30,40,50].forEach(m => {
      const mm = m.toString().padStart(2, '0');
      minuteSelect.innerHTML += `<option value="${mm}">${mm}분</option>`;
    });

    // OX 버튼 렌더링
    const oxItems = ["Fe", "Sus", "제품", "제품+Fe", "제품+Sus"];
    const oxState = {};
    const section = document.getElementById("oxSection");

    oxItems.forEach(key => {
      const label = document.createElement("label");
      label.textContent = key;

      const buttonGroup = document.createElement("div");
      buttonGroup.className = "ox-buttons";
      buttonGroup.dataset.key = key;

      const btnO = document.createElement("button");
      btnO.type = "button";
      btnO.textContent = "O";
      btnO.onclick = () => selectOX(key, "O");

      const btnX = document.createElement("button");
      btnX.type = "button";
      btnX.textContent = "X";
      btnX.onclick = () => selectOX(key, "X");

      buttonGroup.appendChild(btnO);
      buttonGroup.appendChild(btnX);

      section.appendChild(label);
      section.appendChild(buttonGroup);
    });

    function selectOX(key, value) {
      oxState[key] = value;
      const buttons = document.querySelectorAll(`.ox-buttons[data-key="${key}"] button`);
      buttons.forEach(btn => {
        btn.classList.toggle("selected", btn.textContent === value);
      });
    }

    document.getElementById("magnetForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const date = document.getElementById("date").value;
      const step = document.getElementById("step").value;
      const hour = document.getElementById("hour").value;
      const minute = document.getElementById("minute").value;
      const product = document.getElementById("product").value;

      // 필수 체크
      const missing = [];
      if (!step) missing.push("점검차수");
      if (!hour) missing.push("시");
      if (!minute) missing.push("분");
      if (!product) missing.push("제품");
      oxItems.forEach(k => {
        if (!oxState[k]) missing.push(k);
      });

      if (missing.length > 0) {
        alert("❌ 미입력 항목:\n" + missing.join(", "));
        return;
      }

      const postData = {
        magnet: true,
        date, step, hour, minute, product,
        states: JSON.stringify(oxState)
      };

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxZqOGrQIjdRCACEA5Llg-eWgqekxDnt_0yah0NuitqTm-E2k_ZcW7erNhtrSKnA1kWBg/exec", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams(postData)
        });

        const text = await response.text();
        alert("✅ 저장 완료:\n" + text);

        // 폼 초기화 (날짜 제외)
        document.getElementById("step").value = "";
        document.getElementById("hour").value = "";
        document.getElementById("minute").value = "";
        document.getElementById("product").value = "";
        oxItems.forEach(k => delete oxState[k]);
        document.querySelectorAll(".ox-buttons button").forEach(btn => btn.classList.remove("selected"));
      } catch (err) {
        alert("❌ 저장 실패: " + err.message);
      }
    });
  </script>
</body>
</html>
