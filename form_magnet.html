<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>금속검출 점검</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 16px;
    }
    .hidden { display: none; }
    .inline-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .inline-row > * {
      flex: 1;
    }
    .ox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }
    .ox-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1 1 45%;
    }
  </style>
</head>
<body>
  <h2>금속검출 점검</h2>

  <form id="magnetForm">
    <!-- 날짜 -->
    <label>날짜:
      <input type="date" name="date" id="date" required />
    </label>

    <!-- 점검옵션 -->
    <label>점검옵션:
      <select name="option" id="option" required>
        <option value="">-- 선택 --</option>
        <option value="1차점검">1차점검</option>
        <option value="2차점검">2차점검</option>
        <option value="3차점검">3차점검</option>
        <option value="4차점검">4차점검</option>
        <option value="최종취합">최종취합</option>
      </select>
    </label>

    <!-- 시간 -->
    <div class="inline-row hidden" id="timeRow">
      <label>시:
        <select name="hour" id="hour" required>
          <option value="">시</option>
          ${[...Array(24).keys()].map(h => `<option value="${h}">${h}</option>`).join('')}
        </select>
      </label>
      <label>분:
        <select name="minute" id="minute" required>
          <option value="">분</option>
          ${[0,10,20,30,40,50].map(m => `<option value="${m}">${m}</option>`).join('')}
        </select>
      </label>
    </div>

    <!-- 제품선택 -->
    <label id="productRow" class="hidden">제품:
      <select name="product" required>
        <option value="">-- 선택 --</option>
        <option>A상품</option>
        <option>B상품</option>
        <option>C상품</option>
        <option>D상품</option>
        <option>E상품</option>
        <option>G상품</option>
      </select>
    </label>

    <!-- OX선택 -->
    <div class="ox-group hidden" id="oxRow">
      ${["Fe", "Sus", "제품", "제품+Fe", "제품+Sus"].map(label => `
        <div class="ox-item">
          <span>${label}</span>
          <label><input type="radio" name="${label}" value="O" required /> O</label>
          <label><input type="radio" name="${label}" value="X" /> X</label>
        </div>`).join('')}
    </div>

    <!-- 최종취합 전용 -->
    <div class="inline-row hidden" id="finalRow">
      <label>통과수량:
        <input type="number" name="passCount" min="0" />
      </label>
      <label>검출수량:
        <input type="number" name="failCount" min="0" />
      </label>
    </div>

    <button type="submit">저장</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 오늘 날짜 자동입력
      document.getElementById("date").valueAsDate = new Date();

      const option = document.getElementById("option");
      const productRow = document.getElementById("productRow");
      const oxRow = document.getElementById("oxRow");
      const finalRow = document.getElementById("finalRow");
      const timeRow = document.getElementById("timeRow");

      option.addEventListener("change", () => {
        const isRegular = option.value.startsWith("1차") || option.value.startsWith("2차") ||
                          option.value.startsWith("3차") || option.value.startsWith("4차");

        timeRow.classList.toggle("hidden", !isRegular);
        productRow.classList.toggle("hidden", option.value === "");
        oxRow.classList.toggle("hidden", !isRegular);
        finalRow.classList.toggle("hidden", option.value !== "최종취합");
      });

      document.getElementById("magnetForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const form = e.target;
        const data = new FormData(form);

        // 필수 체크
        const requiredFields = ["date", "option", "hour", "minute", "product"];
        for (let field of requiredFields) {
          if (!data.get(field)) return alert("모든 필수 항목을 입력해주세요.");
        }

        // OX 체크 확인 (1~4차 점검 시)
        if (["1차점검", "2차점검", "3차점검", "4차점검"].includes(data.get("option"))) {
          const oxItems = ["Fe", "Sus", "제품", "제품+Fe", "제품+Sus"];
          for (let item of oxItems) {
            if (!data.get(item)) return alert(`${item} 항목을 O 또는 X로 선택해주세요.`);
          }
        }

        // 전송
        const payload = {};
        data.forEach((val, key) => payload[key] = val);
        payload.type = "magnet";

        try {
          const res = await fetch("https://script.google.com/macros/s/AKfycbzu8cE1fqQUvYpF3P4ImOLT2ngWcVPivWgXyfoQ7fpvnqMDgs3nTL5_zB7PSWZuSqFgKw/exec", {
            method: "POST",
            body: JSON.stringify(payload),
            headers: { "Content-Type": "application/json" }
          });

          const text = await res.text();
          alert("저장 완료: " + text);

          // 초기화
          form.reset();
          document.getElementById("date").valueAsDate = new Date(); // 날짜는 유지
        } catch (err) {
          alert("저장 실패: " + err);
        }
      });
    });
  </script>
</body>
</html>
