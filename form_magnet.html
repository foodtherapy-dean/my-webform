<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>금속검출 점검</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      max-width: 600px;
      margin: auto;
    }

    .inline-row {
      display: flex;
      gap: 10px;
    }

    .inline-row > * {
      flex: 1;
    }

    label {
      font-weight: bold;
    }

    .ox-button-group {
      display: flex;
      gap: 5px;
      justify-content: space-between;
    }

    .ox-button {
      flex: 1;
      padding: 8px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
      cursor: pointer;
      font-size: 16px;
    }

    .ox-button.selected {
      background: #4CAF50;
      color: white;
    }

    .hidden {
      display: none;
    }

    input, select {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    button {
      width: 100%;
      padding: 10px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>금속검출 점검</h2>
  <form id="magnetForm">
    <label>날짜</label>
    <input type="date" id="date" name="date" />

    <label>점검옵션</label>
    <select id="option" name="option">
      <option value="">선택</option>
      <option value="1차">1차</option>
      <option value="2차">2차</option>
      <option value="최종취합">최종취합</option>
    </select>

    <div id="details" class="hidden">
      <div class="inline-row">
        <div>
          <label>시</label>
          <select id="hour"></select>
        </div>
        <div>
          <label>분</label>
          <select id="minute"></select>
        </div>
      </div>

      <label>제품명</label>
      <select id="product">
        <option value="">선택</option>
        <option>제품A</option>
        <option>제품B</option>
        <option>제품C</option>
        <option>제품D</option>
        <option>제품E</option>
        <option>제품F</option>
      </select>

      <label>Fe 검출</label>
      <div class="ox-button-group" data-index="0">
        <div class="ox-button">O</div>
        <div class="ox-button">X</div>
      </div>

      <label>Sus 검출</label>
      <div class="ox-button-group" data-index="1">
        <div class="ox-button">O</div>
        <div class="ox-button">X</div>
      </div>

      <label>제품 내 금속</label>
      <div class="ox-button-group" data-index="2">
        <div class="ox-button">O</div>
        <div class="ox-button">X</div>
      </div>

      <label>제품+Fe</label>
      <div class="ox-button-group" data-index="3">
        <div class="ox-button">O</div>
        <div class="ox-button">X</div>
      </div>

      <label>제품+Sus</label>
      <div class="ox-button-group" data-index="4">
        <div class="ox-button">O</div>
        <div class="ox-button">X</div>
      </div>
    </div>

    <div id="summarySection" class="hidden">
      <label>통과 수량 / 검출 수량</label>
      <div class="inline-row">
        <input type="number" id="passQty" placeholder="통과" />
        <input type="number" id="defectQty" placeholder="검출" />
      </div>
    </div>

    <button type="submit">저장</button>
  </form>

  <p id="status"></p>

  <script>
    const form = document.getElementById("magnetForm");
    const option = document.getElementById("option");
    const details = document.getElementById("details");
    const summary = document.getElementById("summarySection");
    const dateInput = document.getElementById("date");

    // 기본 날짜 지정
    dateInput.valueAsDate = new Date();

    // 시간, 분 선택
    const hour = document.getElementById("hour");
    const minute = document.getElementById("minute");

    for (let i = 0; i < 24; i++) {
      hour.innerHTML += `<option>${String(i).padStart(2, '0')}</option>`;
    }
    for (let i = 0; i < 60; i += 10) {
      minute.innerHTML += `<option>${String(i).padStart(2, '0')}</option>`;
    }

    // 옵션 선택 시 상세 입력창 표시
    option.addEventListener("change", () => {
      const val = option.value;
      details.classList.toggle("hidden", !val);
      summary.classList.toggle("hidden", val !== "최종취합");
    });

    // OX 버튼 토글
    document.querySelectorAll(".ox-button-group").forEach(group => {
      group.querySelectorAll(".ox-button").forEach(btn => {
        btn.addEventListener("click", () => {
          group.querySelectorAll(".ox-button").forEach(b => b.classList.remove("selected"));
          btn.classList.add("selected");
        });
      });
    });

    // 전송 처리
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const oxList = [];

      document.querySelectorAll(".ox-button-group").forEach(group => {
        const selected = group.querySelector(".selected");
        oxList.push(selected ? selected.textContent : "");
      });

      const payload = {
        date: dateInput.value,
        group: "금속검출",
        entries: {
          option: option.value,
          time: `${hour.value}:${minute.value}`,
          product: document.getElementById("product").value,
          oxList,
          passQty: document.getElementById("passQty").value,
          defectQty: document.getElementById("defectQty").value
        }
      };

      const url = "https://script.google.com/macros/s/AKfycbwrspkat8meQL8n-8FA8cgBn953wBl4PpILAcYJwHcelEVsYnIY9KOA0AYHqXnA4WUfJQ/exec";
      const res = await fetch(url, {
        method: "POST",
        body: new URLSearchParams({ magnet: JSON.stringify(payload) })
      });

      const msg = await res.text();
      document.getElementById("status").textContent = msg;
    });
  </script>
</body>
</html>
