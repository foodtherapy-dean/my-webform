<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>금속검출 모니터링</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    select, input[type="date"], button { width: 100%; padding: 8px; margin-top: 5px; }
    .section { margin-top: 15px; }
    .ox-buttons { display: flex; gap: 10px; margin-top: 5px; }
    .ox-buttons button {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .selected { background-color: #4CAF50; color: white; }
  </style>
</head>
<body>
  <h2>금속검출 모니터링</h2>
  <form id="magnetForm">
    <label>날짜</label>
    <input type="date" id="date" name="date" required />

    <label>점검차수</label>
    <select id="step" name="step" required>
      <option value="">선택하세요</option>
      <option>1차점검</option>
      <option>2차점검</option>
      <option>3차점검</option>
      <option>4차점검</option>
    </select>

    <label>시간</label>
    <div style="display: flex; gap: 10px;">
      <select id="hour" name="hour" required>
        <option value="">시 선택</option>
        ${[...Array(24).keys()].map(i => `<option value="${(i+1).toString().padStart(2, '0')}">${(i+1).toString().padStart(2, '0')}시</option>`).join('')}
      </select>
      <select id="minute" name="minute" required>
        <option value="">분 선택</option>
        ${[0,10,20,30,40,50].map(i => `<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}분</option>`).join('')}
      </select>
    </div>

    <label>제품 선택</label>
    <select id="product" name="product" required>
      <option value="">선택하세요</option>
      <option>A상품</option>
      <option>B상품</option>
      <option>C상품</option>
      <option>D상품</option>
      <option>E상품</option>
      <option>F상품</option>
    </select>

    <div class="section">
      ${["Fe", "Sus", "제품", "제품+Fe", "제품+Sus"].map(key => `
        <label>${key}</label>
        <div class="ox-buttons" data-key="${key}">
          <button type="button" onclick="selectOX('${key}', 'O')">O</button>
          <button type="button" onclick="selectOX('${key}', 'X')">X</button>
        </div>
      `).join('')}
    </div>

    <input type="hidden" id="oxStates" name="oxStates" />

    <button type="submit" style="margin-top: 20px;">저장</button>
  </form>

  <script>
    // 날짜 자동 입력
    document.getElementById("date").valueAsDate = new Date();

    const oxState = {};

    function selectOX(key, value) {
      oxState[key] = value;

      const container = document.querySelector(\`.ox-buttons[data-key="\${key}"]\`);
      container.querySelectorAll("button").forEach(btn => {
        btn.classList.toggle("selected", btn.textContent === value);
      });
    }

    document.getElementById("magnetForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const date = document.getElementById("date").value;
      const step = document.getElementById("step").value;
      const hour = document.getElementById("hour").value;
      const minute = document.getElementById("minute").value;
      const product = document.getElementById("product").value;

      // 필수 입력 검사
      const missing = [];
      if (!step) missing.push("점검차수");
      if (!hour) missing.push("시");
      if (!minute) missing.push("분");
      if (!product) missing.push("제품");
      ["Fe", "Sus", "제품", "제품+Fe", "제품+Sus"].forEach(key => {
        if (!oxState[key]) missing.push(key);
      });

      if (missing.length > 0) {
        alert("❌ 미입력 항목:\n" + missing.join(", "));
        return;
      }

      const postData = {
        magnet: true,
        date,
        step,
        hour,
        minute,
        product,
        states: JSON.stringify(oxState)
      };

      try {
        const response = await fetch("https://script.google.com/macros/s/PASTE_YOUR_DEPLOYED_URL_HERE/exec", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams(postData)
        });

        const text = await response.text();
        alert("✅ 저장 완료:\n" + text);

        // 입력창 초기화 (날짜 제외)
        document.getElementById("step").value = "";
        document.getElementById("hour").value = "";
        document.getElementById("minute").value = "";
        document.getElementById("product").value = "";
        Object.keys(oxState).forEach(k => delete oxState[k]);
        document.querySelectorAll(".ox-buttons button").forEach(btn => btn.classList.remove("selected"));
      } catch (err) {
        alert("❌ 전송 실패: " + err.message);
      }
    });
  </script>
</body>
</html>
