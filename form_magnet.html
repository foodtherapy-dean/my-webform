<script>
// 날짜 기본값 설정
const dateInput = document.getElementById("date");
dateInput.valueAsDate = new Date();
dateInput.classList.add("selected");

// select, time 선택 시 selected 스타일
function applySelectedStyle(selector) {
  document.querySelectorAll(selector).forEach(el => {
    el.addEventListener("change", () => {
      el.classList.toggle("selected", !!el.value);
    });
  });
}
applySelectedStyle("select");
applySelectedStyle('input[type="time"]');

// 점검 옵션 변경 시 UI 표시 + 중복 체크
document.getElementById("option").addEventListener("change", async e => {
  const opt = e.target.value;
  const dateVal = dateInput.value;
  if (!opt || !dateVal) return;

  document.getElementById("loadingMsg").style.display = "block";

  try {
    const query = encodeURIComponent(JSON.stringify({ date: dateVal, option: opt }));
    const url = "https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec?checkMagnet=" + query;
    const res = await fetch(url);
    const result = await res.json();

    if (result.exists) {
      document.getElementById("duplicateText").innerText = `⚠️ 이미 같은 날짜(${dateVal})와 옵션(${opt})의 데이터가 존재합니다.`;
      document.getElementById("duplicateMsg").style.display = "block";
    } else {
      document.getElementById("duplicateMsg").style.display = "none";
    }
  } catch (err) {
    console.error(err);
  }

  document.getElementById("loadingMsg").style.display = "none";

  const showSub = ["1차점검","2차점검","3차점검","4차점검","최종취합"].includes(opt);
  const isSummary = opt === "최종취합";
  document.getElementById("subInputs").style.display = showSub ? "block" : "none";
  document.getElementById("summaryInputs").style.display = isSummary ? "block" : "none";
  document.getElementById("oxContainer").style.display = isSummary ? "none" : "block";
  const timeLabel = document.getElementById("timeLabel");
  if (timeLabel) timeLabel.style.display = isSummary ? "none" : "block";
  if (isSummary) oxValues = {};
});

// 중복 확인 확인 버튼
document.getElementById("duplicateConfirmBtn").addEventListener("click", () => {
  location.reload();
});

// OX 생성
const oxItems = ["Fe","Sus","제품","제품+Fe","제품+Sus"];
const oxContainer = document.getElementById("oxContainer");
oxItems.forEach(label => {
  const oxSet = document.createElement("div");
  oxSet.className = "ox-set";
  oxSet.innerHTML = `
    <div>${label}</div>
    <div class="ox-buttons">
      <button type="button" class="ox" data-label="${label}" data-value="O">O</button>
      <button type="button" class="ox" data-label="${label}" data-value="X">X</button>
    </div>
  `;
  oxContainer.appendChild(oxSet);
});

// OX 선택 처리
let oxValues = {};
document.addEventListener("click", e => {
  if (e.target.classList.contains("ox")) {
    const btn = e.target;
    const label = btn.dataset.label;
    oxValues[label] = btn.dataset.value;
    document.querySelectorAll(`.ox[data-label="${label}"]`).forEach(b => b.classList.toggle("selected", b===btn));
  }
});

// 옵션 순서 검증
async function validateOptionSequence(dateVal, opt) {
  try {
    const query = encodeURIComponent(JSON.stringify({ date: dateVal }));
    const url = "https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec?getMagnet=" + query;
    const res = await fetch(url);
    const result = await res.json();

    const existingOptions = (result.options || []).map(o => String(o).trim());
    const requiredMap = {
      "2차점검":["1차점검"],
      "3차점검":["1차점검","2차점검"],
      "4차점검":["1차점검","2차점검","3차점검"],
      "최종취합":["1차점검"]
    };

    const missing = (requiredMap[opt] || []).filter(r => !existingOptions.includes(r));
    if (missing.length) {
      alert(`⚠️ 누락된 차수: ${missing.join(", ")}이(가) 먼저 입력되어야 ${opt}를 저장할 수 있습니다.`);
      return false;
    }

    return true;
  } catch (err) {
    console.error(err);
    return true;
  }
}

// 폼 제출
document.getElementById("magnetForm").addEventListener("submit", async function(e){
  e.preventDefault();
  const form = e.target;

  // 필수 입력 체크
  const activeInputs = form.querySelectorAll("input, select");
  for (const input of activeInputs) {
    if (input.offsetParent===null) continue;
    if (!input.value) { alert(`${input.previousElementSibling?.innerText || "입력값"}을(를) 입력하세요.`); input.focus(); return; }
  }

  // OX 필수 체크
  if (form.option.value!=="최종취합") {
    for (const label of oxItems) {
      if (!(label in oxValues)) {
        alert(`검출 상태 '${label}'의 O 또는 X를 선택하세요.`); 
        document.querySelector(`.ox[data-label="${label}"]`)?.focus(); 
        return;
      }
    }
  }

  // 순서 검증
  const isValidSequence = await validateOptionSequence(form.date.value, form.option.value);
  if (!isValidSequence) return;

  // 시간 분리
  const timeInput = form.querySelector("#time");
  let hour="", minute="";
  if (timeInput && timeInput.value) [hour, minute] = timeInput.value.split(":");

  const data = {
    type: "data",
    date: form.date.value,
    option: form.option.value,
    hour, minute,
    product: form.product.value,
    passCount: form.querySelector('input[name="passCount"]')?.value || "",
    detectCount: form.querySelector('input[name="detectCount"]')?.value || "",
    states: oxValues
  };

  const formData = new FormData();
  formData.append("magnet", JSON.stringify(data));

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbymv885vawGF_1pgz2IP6R5DHxrV-BGWsjHxg9PF3k2OvxIpmJXdQ4eIpUmho_VIb9AIg/exec", { method:"POST", body:formData });
    const result = await response.text();
    if(response.ok) { alert("✅ 저장 완료:\n"+result); location.reload(); }
    else { alert("❌ 서버 오류:\n"+result); location.reload(); }
  } catch(err) { alert("❌ 저장 중 오류 발생:\n"+err.message); location.reload(); }
});
</script>
