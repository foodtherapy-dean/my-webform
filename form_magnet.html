<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>금속검출 점검</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    .inline-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .ox-set {
      margin-bottom: 10px;
    }
    .ox {
      border: 1px solid #ccc;
      padding: 5px 10px;
      cursor: pointer;
      margin-right: 5px;
    }
    .ox.selected {
      background: #4caf50;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>금속검출 점검</h2>
  <form id="magnetForm">
    <label for="date">날짜:</label>
    <input type="date" id="date" name="date" required><br><br>

    <label for="option">점검옵션:</label>
    <select id="option" name="option" required>
      <option value="">선택하세요</option>
      <option value="1차점검">1차점검</option>
      <option value="2차점검">2차점검</option>
      <option value="3차점검">3차점검</option>
      <option value="최종취합">최종취합</option>
    </select><br><br>

    <div id="timeRow" class="inline-row">
      <label>시간:</label>
      <input type="time" id="time" name="time">
    </div><br>

    <div id="productRow" class="inline-row">
      <label for="product">제품명:</label>
      <select id="product" name="product">
        <option value="">선택</option>
        <option value="제품A">제품A</option>
        <option value="제품B">제품B</option>
        <option value="제품C">제품C</option>
      </select>
    </div><br>

    <div id="oxSection">
      <div class="ox-set" data-label="Fe">
        <label>Fe</label><br>
        <button type="button" class="ox" data-label="Fe" data-value="O">O</button>
        <button type="button" class="ox" data-label="Fe" data-value="X">X</button>
      </div>
      <div class="ox-set" data-label="Sus">
        <label>Sus</label><br>
        <button type="button" class="ox" data-label="Sus" data-value="O">O</button>
        <button type="button" class="ox" data-label="Sus" data-value="X">X</button>
      </div>
    </div>

    <div id="finalRow" style="display:none">
      <label>통과수량:</label>
      <input type="number" name="passCount"><br>
      <label>검출수량:</label>
      <input type="number" name="detectCount"><br>
    </div><br>

    <button type="submit">저장</button>
  </form>

  <script>
    const dateInput = document.getElementById("date");
    dateInput.valueAsDate = new Date();

    const oxValues = {};

    document.querySelectorAll(".ox").forEach(btn => {
      btn.addEventListener("click", function () {
        const label = btn.dataset.label;
        const value = btn.dataset.value;

        // 같은 label의 다른 버튼 선택 해제
        document.querySelectorAll(`.ox[data-label="${label}"]`).forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        oxValues[label] = value;
      });
    });

    const optionSelect = document.getElementById("option");
    optionSelect.addEventListener("change", function () {
      const isFinal = this.value === "최종취합";
      document.getElementById("finalRow").style.display = isFinal ? "block" : "none";
      document.getElementById("oxSection").style.display = isFinal ? "none" : "block";
    });

    document.getElementById("magnetForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const form = e.target;
      const optionValue = form.option.value;

      if (!optionValue) {
        alert("점검옵션을 선택해 주세요.");
        return;
      }

      if (optionValue !== "최종취합") {
        const requiredLabels = ["Fe", "Sus"];
        for (const label of requiredLabels) {
          if (!(label in oxValues)) {
            alert(`검출 상태 '${label}'의 O 또는 X를 선택해 주세요.`);
            return;
          }
        }
      }

      let hour = "", minute = "";
      if (form.time.value) {
        const timeParts = form.time.value.split(":");
        hour = timeParts[0] || "";
        minute = timeParts[1] || "";
      }

      const data = {
        type: "magnet",
        date: form.date.value,
        option: optionValue,
        hour: hour,
        minute: minute,
        product: form.product.value,
        passCount: form.querySelector('input[name="passCount"]')?.value || "",
        detectCount: form.querySelector('input[name="detectCount"]')?.value || "",
        states: oxValues
      };

      const formData = new FormData();
      formData.append("data", JSON.stringify(data));

      try {
        const response = await fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec", {
          method: "POST",
          body: formData
        });

        const result = await response.text();
        if (response.ok) {
          alert("✅ 저장 완료:\n" + result);
          form.reset();
          dateInput.valueAsDate = new Date();
          document.querySelectorAll(".ox.selected").forEach(btn => btn.classList.remove("selected"));
          for (const key in oxValues) delete oxValues[key];
        } else {
          alert("❌ 서버 오류:\n" + result);
        }
      } catch (err) {
        alert("❌ 저장 중 오류 발생:\n" + err.message);
        console.error("❌ 예외:", err);
      }
    });
  </script>
</body>
</html>
